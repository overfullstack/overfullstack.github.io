/*! For license information please see 484bcb1e-f37b52ac445247cfd30c.js.LICENSE.txt */
"use strict";(self.webpackChunkgopals_over_full_stack_v2=self.webpackChunkgopals_over_full_stack_v2||[]).push([[883],{3023:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0});var r=n(5752),s=n(8316),i=n(7019),o=n(1313),a=n(3582);const c="@firebase/firestore";class u{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}u.UNAUTHENTICATED=new u(null),u.GOOGLE_CREDENTIALS=new u("google-credentials-uid"),u.FIRST_PARTY=new u("first-party-uid"),u.MOCK_USER=new u("mock-user");let l="10.8.0";const h=new i.Logger("@firebase/firestore");function d(){return h.logLevel}function f(e,...t){if(h.logLevel<=i.LogLevel.DEBUG){const n=t.map(p);h.debug(`Firestore (${l}): ${e}`,...n)}}function m(e,...t){if(h.logLevel<=i.LogLevel.ERROR){const n=t.map(p);h.error(`Firestore (${l}): ${e}`,...n)}}function g(e,...t){if(h.logLevel<=i.LogLevel.WARN){const n=t.map(p);h.warn(`Firestore (${l}): ${e}`,...n)}}function p(e){if("string"==typeof e)return e;try{return function(e){return JSON.stringify(e)}(e)}catch(t){return e}}function y(e="Unexpected state"){const t=`FIRESTORE (${l}) INTERNAL ASSERTION FAILED: `+e;throw m(t),new Error(t)}function w(e,t){e||y()}function v(e,t){return e}const I={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class _ extends o.FirebaseError{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class b{constructor(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class E{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class T{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable((()=>t(u.UNAUTHENTICATED)))}shutdown(){}}class S{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable((()=>t(this.token.user)))}shutdown(){this.changeListener=null}}class x{constructor(e){this.t=e,this.currentUser=u.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){let n=this.i;const r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve();let s=new b;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new b,e.enqueueRetryable((()=>r(this.currentUser)))};const i=()=>{const t=s;e.enqueueRetryable((async()=>{await t.promise,await r(this.currentUser)}))},o=e=>{f("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((e=>o(e))),setTimeout((()=>{if(!this.auth){const e=this.t.getImmediate({optional:!0});e?o(e):(f("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new b)}}),0),i()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then((t=>this.i!==e?(f("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(w("string"==typeof t.accessToken),new E(t.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const e=this.auth&&this.auth.getUid();return w(null===e||"string"==typeof e),new u(e)}}class C{constructor(e,t,n){this.l=e,this.h=t,this.P=n,this.type="FirstParty",this.user=u.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);const e=this.T();return e&&this.I.set("Authorization",e),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class D{constructor(e,t,n){this.l=e,this.h=t,this.P=n}getToken(){return Promise.resolve(new C(this.l,this.h,this.P))}start(e,t){e.enqueueRetryable((()=>t(u.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class N{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class A{constructor(e){this.A=e,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(e,t){const n=e=>{null!=e.error&&f("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);const n=e.token!==this.R;return this.R=e.token,f("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable((()=>n(t)))};const r=e=>{f("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.A.onInit((e=>r(e))),setTimeout((()=>{if(!this.appCheck){const e=this.A.getImmediate({optional:!0});e?r(e):f("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then((e=>e?(w("string"==typeof e.token),this.R=e.token,new N(e.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}function k(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let r=0;r<e;r++)n[r]=Math.floor(256*Math.random());return n}class M{static newId(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=62*Math.floor(256/62);let n="";for(;n.length<20;){const r=k(40);for(let s=0;s<r.length;++s)n.length<20&&r[s]<t&&(n+=e.charAt(r[s]%62))}return n}}function L(e,t){return e<t?-1:e>t?1:0}function R(e,t,n){return e.length===t.length&&e.every(((e,r)=>n(e,t[r])))}function F(e){return e+"\0"}class P{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new _(I.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new _(I.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new _(I.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new _(I.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return P.fromMillis(Date.now())}static fromDate(e){return P.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new P(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?L(this.nanoseconds,e.nanoseconds):L(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class V{constructor(e){this.timestamp=e}static fromTimestamp(e){return new V(e)}static min(){return new V(new P(0,0))}static max(){return new V(new P(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class O{constructor(e,t,n){void 0===t?t=0:t>e.length&&y(),void 0===n?n=e.length-t:n>e.length-t&&y(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===O.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof O?e.forEach((e=>{t.push(e)})):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),s=t.get(r);if(n<s)return-1;if(n>s)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class q extends O{construct(e,t,n){return new q(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...e){const t=[];for(const n of e){if(n.indexOf("//")>=0)throw new _(I.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter((e=>e.length>0)))}return new q(t)}static emptyPath(){return new q([])}}const U=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class B extends O{construct(e,t,n){return new B(e,t,n)}static isValidIdentifier(e){return U.test(e)}canonicalString(){return this.toArray().map((e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),B.isValidIdentifier(e)||(e="`"+e+"`"),e))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new B(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;const s=()=>{if(0===n.length)throw new _(I.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new _(I.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new _(I.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?(i=!i,r++):"."!==t||i?(n+=t,r++):(s(),r++)}if(s(),i)throw new _(I.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new B(t)}static emptyPath(){return new B([])}}class z{constructor(e){this.path=e}static fromPath(e){return new z(q.fromString(e))}static fromName(e){return new z(q.fromString(e).popFirst(5))}static empty(){return new z(q.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===q.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return q.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new z(new q(e.slice()))}}class G{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function K(e){return e.fields.find((e=>2===e.kind))}function $(e){return e.fields.filter((e=>2!==e.kind))}function Q(e,t){let n=L(e.collectionGroup,t.collectionGroup);if(0!==n)return n;for(let r=0;r<Math.min(e.fields.length,t.fields.length);++r)if(n=W(e.fields[r],t.fields[r]),0!==n)return n;return L(e.fields.length,t.fields.length)}G.UNKNOWN_ID=-1;class j{constructor(e,t){this.fieldPath=e,this.kind=t}}function W(e,t){const n=B.comparator(e.fieldPath,t.fieldPath);return 0!==n?n:L(e.kind,t.kind)}class Y{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new Y(0,X.min())}}function H(e,t){const n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,s=V.fromTimestamp(1e9===r?new P(n+1,0):new P(n,r));return new X(s,z.empty(),t)}function J(e){return new X(e.readTime,e.key,-1)}class X{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new X(V.min(),z.empty(),-1)}static max(){return new X(V.max(),z.empty(),-1)}}function Z(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=z.comparator(e.documentKey,t.documentKey),0!==n?n:L(e.largestBatchId,t.largestBatchId))}const ee="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class te{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((e=>e()))}}async function ne(e){if(e.code!==I.FAILED_PRECONDITION||e.message!==ee)throw e;f("LocalStore","Unexpectedly lost primary lease")}class re{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e((e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)}),(e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)}))}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&y(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new re(((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}}))}toPromise(){return new Promise(((e,t)=>{this.next(e,t)}))}wrapUserFunction(e){try{const t=e();return t instanceof re?t:re.resolve(t)}catch(e){return re.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction((()=>e(t))):re.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction((()=>e(t))):re.reject(t)}static resolve(e){return new re(((t,n)=>{t(e)}))}static reject(e){return new re(((t,n)=>{n(e)}))}static waitFor(e){return new re(((t,n)=>{let r=0,s=0,i=!1;e.forEach((e=>{++r,e.next((()=>{++s,i&&s===r&&t()}),(e=>n(e)))})),i=!0,s===r&&t()}))}static or(e){let t=re.resolve(!1);for(const n of e)t=t.next((e=>e?re.resolve(e):n()));return t}static forEach(e,t){const n=[];return e.forEach(((e,r)=>{n.push(t.call(this,e,r))})),this.waitFor(n)}static mapArray(e,t){return new re(((n,r)=>{const s=e.length,i=new Array(s);let o=0;for(let a=0;a<s;a++){const c=a;t(e[c]).next((e=>{i[c]=e,++o,o===s&&n(i)}),(e=>r(e)))}}))}static doWhile(e,t){return new re(((n,r)=>{const s=()=>{!0===e()?t().next((()=>{s()}),r):n()};s()}))}}class se{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.V=new b,this.transaction.oncomplete=()=>{this.V.resolve()},this.transaction.onabort=()=>{t.error?this.V.reject(new ae(e,t.error)):this.V.resolve()},this.transaction.onerror=t=>{const n=de(t.target.error);this.V.reject(new ae(e,n))}}static open(e,t,n,r){try{return new se(t,e.transaction(r,n))}catch(e){throw new ae(t,e)}}get m(){return this.V.promise}abort(e){e&&this.V.reject(e),this.aborted||(f("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}g(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){const t=this.transaction.objectStore(e);return new ue(t)}}class ie{constructor(e,t,n){this.name=e,this.version=t,this.p=n,12.2===ie.S(o.getUA())&&m("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return f("SimpleDb","Removing database:",e),le(window.indexedDB.deleteDatabase(e)).toPromise()}static D(){if(!o.isIndexedDBAvailable())return!1;if(ie.C())return!0;const e=o.getUA(),t=ie.S(e),n=0<t&&t<10,r=ie.v(e),s=0<r&&r<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||n||s)}static C(){var e;return"undefined"!=typeof process&&"YES"===(null===(e=process.__PRIVATE_env)||void 0===e?void 0:e.F)}static M(e,t){return e.store(t)}static S(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static v(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async O(e){return this.db||(f("SimpleDb","Opening database:",this.name),this.db=await new Promise(((t,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{const n=e.target.result;t(n)},r.onblocked=()=>{n(new ae(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{const r=t.target.error;"VersionError"===r.name?n(new _(I.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new _(I.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new ae(e,r))},r.onupgradeneeded=e=>{f("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);const t=e.target.result;this.p.N(t,r.transaction,e.oldVersion,this.version).next((()=>{f("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.B&&(this.db.onversionchange=e=>this.B(e)),this.db}L(e){this.B=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){const s="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.O(e);const t=se.open(this.db,e,s?"readonly":"readwrite",n),i=r(t).next((e=>(t.g(),e))).catch((e=>(t.abort(e),re.reject(e)))).toPromise();return i.catch((()=>{})),await t.m,i}catch(e){const t=e,n="FirebaseError"!==t.name&&i<3;if(f("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class oe{constructor(e){this.k=e,this.q=!1,this.K=null}get isDone(){return this.q}get $(){return this.K}set cursor(e){this.k=e}done(){this.q=!0}U(e){this.K=e}delete(){return le(this.k.delete())}}class ae extends _{constructor(e,t){super(I.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function ce(e){return"IndexedDbTransactionError"===e.name}class ue{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(f("SimpleDb","PUT",this.store.name,e,t),n=this.store.put(t,e)):(f("SimpleDb","PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),le(n)}add(e){return f("SimpleDb","ADD",this.store.name,e,e),le(this.store.add(e))}get(e){return le(this.store.get(e)).next((t=>(void 0===t&&(t=null),f("SimpleDb","GET",this.store.name,e,t),t)))}delete(e){return f("SimpleDb","DELETE",this.store.name,e),le(this.store.delete(e))}count(){return f("SimpleDb","COUNT",this.store.name),le(this.store.count())}W(e,t){const n=this.options(e,t),r=n.index?this.store.index(n.index):this.store;if("function"==typeof r.getAll){const e=r.getAll(n.range);return new re(((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}}))}{const e=this.cursor(n),t=[];return this.G(e,((e,n)=>{t.push(n)})).next((()=>t))}}j(e,t){const n=this.store.getAll(e,null===t?void 0:t);return new re(((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}}))}H(e,t){f("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.J=!1;const r=this.cursor(n);return this.G(r,((e,t,n)=>n.delete()))}Y(e,t){let n;t?n=e:(n={},t=e);const r=this.cursor(n);return this.G(r,t)}Z(e){const t=this.cursor({});return new re(((n,r)=>{t.onerror=e=>{const t=de(e.target.error);r(t)},t.onsuccess=t=>{const r=t.target.result;r?e(r.primaryKey,r.value).next((e=>{e?r.continue():n()})):n()}}))}G(e,t){const n=[];return new re(((r,s)=>{e.onerror=e=>{s(e.target.error)},e.onsuccess=e=>{const s=e.target.result;if(!s)return void r();const i=new oe(s),o=t(s.primaryKey,s.value,i);if(o instanceof re){const e=o.catch((e=>(i.done(),re.reject(e))));n.push(e)}i.isDone?r():null===i.$?s.continue():s.continue(i.$)}})).next((()=>re.waitFor(n)))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.J?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function le(e){return new re(((t,n)=>{e.onsuccess=e=>{const n=e.target.result;t(n)},e.onerror=e=>{const t=de(e.target.error);n(t)}}))}let he=!1;function de(e){const t=ie.S(o.getUA());if(t>=12.2&&t<13){const t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){const e=new _("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return he||(he=!0,setTimeout((()=>{throw e}),0)),e}}return e}class fe{constructor(e,t){this.asyncQueue=e,this.X=t,this.task=null}start(){this.ee(15e3)}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}ee(e){f("IndexBackfiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,(async()=>{this.task=null;try{f("IndexBackfiller",`Documents written: ${await this.X.te()}`)}catch(e){ce(e)?f("IndexBackfiller","Ignoring IndexedDB error during index backfill: ",e):await ne(e)}await this.ee(6e4)}))}}class me{constructor(e,t){this.localStore=e,this.persistence=t}async te(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(t=>this.ne(t,e)))}ne(e,t){const n=new Set;let r=t,s=!0;return re.doWhile((()=>!0===s&&r>0),(()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next((t=>{if(null!==t&&!n.has(t))return f("IndexBackfiller",`Processing collection: ${t}`),this.re(e,t,r).next((e=>{r-=e,n.add(t)}));s=!1})))).next((()=>t-r))}re(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next((r=>this.localStore.localDocuments.getNextDocuments(e,t,r,n).next((n=>{const s=n.changes;return this.localStore.indexManager.updateIndexEntries(e,s).next((()=>this.ie(r,n))).next((n=>(f("IndexBackfiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n)))).next((()=>s.size))}))))}ie(e,t){let n=e;return t.changes.forEach(((e,t)=>{const r=J(t);Z(r,n)>0&&(n=r)})),new X(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class ge{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.se(e),this.oe=e=>t.writeSequenceNumber(e))}se(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this.oe&&this.oe(e),e}}function pe(e){return null==e}function ye(e){return 0===e&&1/e==-1/0}function we(e){return"number"==typeof e&&Number.isInteger(e)&&!ye(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}function ve(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t=_e(t)),t=Ie(e.get(n),t);return _e(t)}function Ie(e,t){let n=t;const r=e.length;for(let s=0;s<r;s++){const t=e.charAt(s);switch(t){case"\0":n+="";break;case"":n+="";break;default:n+=t}}return n}function _e(e){return e+""}function be(e){const t=e.length;if(w(t>=2),2===t)return w(""===e.charAt(0)&&""===e.charAt(1)),q.emptyPath();const n=t-2,r=[];let s="";for(let i=0;i<t;){const t=e.indexOf("",i);switch((t<0||t>n)&&y(),e.charAt(t+1)){case"":const n=e.substring(i,t);let o;0===s.length?o=n:(s+=n,o=s,s=""),r.push(o);break;case"":s+=e.substring(i,t),s+="\0";break;case"":s+=e.substring(i,t+1);break;default:y()}i=t+2}return new q(r)}ge._e=-1;const Ee=["userId","batchId"];function Te(e,t){return[e,ve(t)]}function Se(e,t,n){return[e,ve(t),n]}const xe={},Ce=["prefixPath","collectionGroup","readTime","documentId"],De=["prefixPath","collectionGroup","documentId"],Ne=["collectionGroup","readTime","prefixPath","documentId"],Ae=["canonicalId","targetId"],ke=["targetId","path"],Me=["path","targetId"],Le=["collectionId","parent"],Re=["indexId","uid"],Fe=["uid","sequenceNumber"],Pe=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],Ve=["indexId","uid","orderedDocumentKey"],Oe=["userId","collectionPath","documentId"],qe=["userId","collectionPath","largestBatchId"],Ue=["userId","collectionGroup","largestBatchId"],Be=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],ze=[...Be,"documentOverlays"],Ge=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],Ke=Ge,$e=[...Ke,"indexConfiguration","indexState","indexEntries"];class Qe extends te{constructor(e,t){super(),this.ae=e,this.currentSequenceNumber=t}}function je(e,t){const n=v(e);return ie.M(n.ae,t)}function We(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function Ye(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function He(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}class Je{constructor(e,t){this.comparator=e,this.root=t||Ze.EMPTY}insert(e,t){return new Je(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,Ze.BLACK,null,null))}remove(e){return new Je(this.comparator,this.root.remove(e,this.comparator).copy(null,null,Ze.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal(((t,n)=>(e(t,n),!1)))}toString(){const e=[];return this.inorderTraversal(((t,n)=>(e.push(`${t}:${n}`),!1))),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new Xe(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new Xe(this.root,e,this.comparator,!1)}getReverseIterator(){return new Xe(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new Xe(this.root,e,this.comparator,!0)}}class Xe{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,t&&r&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class Ze{constructor(e,t,n,r,s){this.key=e,this.value=t,this.color=null!=n?n:Ze.RED,this.left=null!=r?r:Ze.EMPTY,this.right=null!=s?s:Ze.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,s){return new Ze(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;const s=n(e,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===s?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return Ze.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return Ze.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,Ze.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,Ze.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw y();if(this.right.isRed())throw y();const e=this.left.check();if(e!==this.right.check())throw y();return e+(this.isRed()?0:1)}}Ze.EMPTY=null,Ze.RED=!0,Ze.BLACK=!1,Ze.EMPTY=new class{constructor(){this.size=0}get key(){throw y()}get value(){throw y()}get color(){throw y()}get left(){throw y()}get right(){throw y()}copy(e,t,n,r,s){return this}insert(e,t,n){return new Ze(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class et{constructor(e){this.comparator=e,this.data=new Je(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal(((t,n)=>(e(t),!1)))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new tt(this.data.getIterator())}getIteratorFrom(e){return new tt(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach((e=>{t=t.add(e)})),t}isEqual(e){if(!(e instanceof et))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const e=[];return this.forEach((t=>{e.push(t)})),e}toString(){const e=[];return this.forEach((t=>e.push(t))),"SortedSet("+e.toString()+")"}copy(e){const t=new et(this.comparator);return t.data=e,t}}class tt{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function nt(e){return e.hasNext()?e.getNext():void 0}class rt{constructor(e){this.fields=e,e.sort(B.comparator)}static empty(){return new rt([])}unionWith(e){let t=new et(B.comparator);for(const n of this.fields)t=t.add(n);for(const n of e)t=t.add(n);return new rt(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return R(this.fields,e.fields,((e,t)=>e.isEqual(t)))}}class st extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}class it{constructor(e){this.binaryString=e}static fromBase64String(e){const t=function(e){try{return atob(e)}catch(e){throw"undefined"!=typeof DOMException&&e instanceof DOMException?new st("Invalid base64 string: "+e):e}}(e);return new it(t)}static fromUint8Array(e){const t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new it(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return L(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}it.EMPTY_BYTE_STRING=new it("");const ot=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function at(e){if(w(!!e),"string"==typeof e){let t=0;const n=ot.exec(e);if(w(!!n),n[1]){let e=n[1];e=(e+"000000000").substr(0,9),t=Number(e)}const r=new Date(e);return{seconds:Math.floor(r.getTime()/1e3),nanos:t}}return{seconds:ct(e.seconds),nanos:ct(e.nanos)}}function ct(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function ut(e){return"string"==typeof e?it.fromBase64String(e):it.fromUint8Array(e)}function lt(e){var t,n;return"server_timestamp"===(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function ht(e){const t=e.mapValue.fields.__previous_value__;return lt(t)?ht(t):t}function dt(e){const t=at(e.mapValue.fields.__local_write_time__.timestampValue);return new P(t.seconds,t.nanos)}class ft{constructor(e,t,n,r,s,i,o,a,c){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.longPollingOptions=a,this.useFetchStreams=c}}class mt{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new mt("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof mt&&e.projectId===this.projectId&&e.database===this.database}}const gt={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},pt={nullValue:"NULL_VALUE"};function yt(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?lt(e)?4:Mt(e)?9007199254740991:10:y()}function wt(e,t){if(e===t)return!0;const n=yt(e);if(n!==yt(t))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return dt(e).isEqual(dt(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;const n=at(e.timestampValue),r=at(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return function(e,t){return ut(e.bytesValue).isEqual(ut(t.bytesValue))}(e,t);case 7:return e.referenceValue===t.referenceValue;case 8:return function(e,t){return ct(e.geoPointValue.latitude)===ct(t.geoPointValue.latitude)&&ct(e.geoPointValue.longitude)===ct(t.geoPointValue.longitude)}(e,t);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return ct(e.integerValue)===ct(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){const n=ct(e.doubleValue),r=ct(t.doubleValue);return n===r?ye(n)===ye(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return R(e.arrayValue.values||[],t.arrayValue.values||[],wt);case 10:return function(e,t){const n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(We(n)!==We(r))return!1;for(const s in n)if(n.hasOwnProperty(s)&&(void 0===r[s]||!wt(n[s],r[s])))return!1;return!0}(e,t);default:return y()}}function vt(e,t){return void 0!==(e.values||[]).find((e=>wt(e,t)))}function It(e,t){if(e===t)return 0;const n=yt(e),r=yt(t);if(n!==r)return L(n,r);switch(n){case 0:case 9007199254740991:return 0;case 1:return L(e.booleanValue,t.booleanValue);case 2:return function(e,t){const n=ct(e.integerValue||e.doubleValue),r=ct(t.integerValue||t.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(e,t);case 3:return _t(e.timestampValue,t.timestampValue);case 4:return _t(dt(e),dt(t));case 5:return L(e.stringValue,t.stringValue);case 6:return function(e,t){const n=ut(e),r=ut(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){const n=e.split("/"),r=t.split("/");for(let s=0;s<n.length&&s<r.length;s++){const e=L(n[s],r[s]);if(0!==e)return e}return L(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){const n=L(ct(e.latitude),ct(t.latitude));return 0!==n?n:L(ct(e.longitude),ct(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return function(e,t){const n=e.values||[],r=t.values||[];for(let s=0;s<n.length&&s<r.length;++s){const e=It(n[s],r[s]);if(e)return e}return L(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===gt.mapValue&&t===gt.mapValue)return 0;if(e===gt.mapValue)return 1;if(t===gt.mapValue)return-1;const n=e.fields||{},r=Object.keys(n),s=t.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let o=0;o<r.length&&o<i.length;++o){const e=L(r[o],i[o]);if(0!==e)return e;const t=It(n[r[o]],s[i[o]]);if(0!==t)return t}return L(r.length,i.length)}(e.mapValue,t.mapValue);default:throw y()}}function _t(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return L(e,t);const n=at(e),r=at(t),s=L(n.seconds,r.seconds);return 0!==s?s:L(n.nanos,r.nanos)}function bt(e){return Et(e)}function Et(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=at(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?function(e){return ut(e).toBase64()}(e.bytesValue):"referenceValue"in e?function(e){return z.fromName(e).toString()}(e.referenceValue):"geoPointValue"in e?function(e){return`geo(${e.latitude},${e.longitude})`}(e.geoPointValue):"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=Et(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const s of t)r?r=!1:n+=",",n+=`${s}:${Et(e.fields[s])}`;return n+"}"}(e.mapValue):y()}function Tt(e){switch(yt(e)){case 0:case 1:return 4;case 2:return 8;case 3:case 8:return 16;case 4:const t=ht(e);return t?16+Tt(t):16;case 5:return 2*e.stringValue.length;case 6:return ut(e.bytesValue).approximateByteSize();case 7:return e.referenceValue.length;case 9:return function(e){return(e.values||[]).reduce(((e,t)=>e+Tt(t)),0)}(e.arrayValue);case 10:return function(e){let t=0;return Ye(e.fields,((e,n)=>{t+=e.length+Tt(n)})),t}(e.mapValue);default:throw y()}}function St(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function xt(e){return!!e&&"integerValue"in e}function Ct(e){return!!e&&"arrayValue"in e}function Dt(e){return!!e&&"nullValue"in e}function Nt(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function At(e){return!!e&&"mapValue"in e}function kt(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const t={mapValue:{fields:{}}};return Ye(e.mapValue.fields,((e,n)=>t.mapValue.fields[e]=kt(n))),t}if(e.arrayValue){const t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=kt(e.arrayValue.values[n]);return t}return Object.assign({},e)}function Mt(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function Lt(e){return"nullValue"in e?pt:"booleanValue"in e?{booleanValue:!1}:"integerValue"in e||"doubleValue"in e?{doubleValue:NaN}:"timestampValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in e?{stringValue:""}:"bytesValue"in e?{bytesValue:""}:"referenceValue"in e?St(mt.empty(),z.empty()):"geoPointValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in e?{arrayValue:{}}:"mapValue"in e?{mapValue:{}}:y()}function Rt(e){return"nullValue"in e?{booleanValue:!1}:"booleanValue"in e?{doubleValue:NaN}:"integerValue"in e||"doubleValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in e?{stringValue:""}:"stringValue"in e?{bytesValue:""}:"bytesValue"in e?St(mt.empty(),z.empty()):"referenceValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in e?{arrayValue:{}}:"arrayValue"in e?{mapValue:{}}:"mapValue"in e?gt:y()}function Ft(e,t){const n=It(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function Pt(e,t){const n=It(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class Vt{constructor(e){this.value=e}static empty(){return new Vt({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!At(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=kt(t)}setAll(e){let t=B.emptyPath(),n={},r=[];e.forEach(((e,s)=>{if(!t.isImmediateParentOf(s)){const e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=s.popLast()}e?n[s.lastSegment()]=kt(e):r.push(s.lastSegment())}));const s=this.getFieldsMap(t);this.applyChanges(s,n,r)}delete(e){const t=this.field(e.popLast());At(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return wt(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];At(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){Ye(t,((t,n)=>e[t]=n));for(const r of n)delete e[r]}clone(){return new Vt(kt(this.value))}}function Ot(e){const t=[];return Ye(e.fields,((e,n)=>{const r=new B([e]);if(At(n)){const e=Ot(n.mapValue).fields;if(0===e.length)t.push(r);else for(const n of e)t.push(r.child(n))}else t.push(r)})),new rt(t)}class qt{constructor(e,t,n,r,s,i,o){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.createTime=s,this.data=i,this.documentState=o}static newInvalidDocument(e){return new qt(e,0,V.min(),V.min(),V.min(),Vt.empty(),0)}static newFoundDocument(e,t,n,r){return new qt(e,1,t,V.min(),n,r,0)}static newNoDocument(e,t){return new qt(e,2,t,V.min(),V.min(),Vt.empty(),0)}static newUnknownDocument(e,t){return new qt(e,3,t,V.min(),V.min(),Vt.empty(),2)}convertToFoundDocument(e,t){return!this.createTime.isEqual(V.min())||2!==this.documentType&&0!==this.documentType||(this.createTime=e),this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=Vt.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=Vt.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=V.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof qt&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new qt(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class Ut{constructor(e,t){this.position=e,this.inclusive=t}}function Bt(e,t,n){let r=0;for(let s=0;s<e.position.length;s++){const i=t[s],o=e.position[s];if(r=i.field.isKeyField()?z.comparator(z.fromName(o.referenceValue),n.key):It(o,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return r}function zt(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!wt(e.position[n],t.position[n]))return!1;return!0}class Gt{constructor(e,t="asc"){this.field=e,this.dir=t}}function Kt(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}class $t{}class Qt extends $t{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.createKeyFieldInFilter(e,t,n):new nn(e,t,n):"array-contains"===t?new an(e,n):"in"===t?new cn(e,n):"not-in"===t?new un(e,n):"array-contains-any"===t?new ln(e,n):new Qt(e,t,n)}static createKeyFieldInFilter(e,t,n){return"in"===t?new rn(e,n):new sn(e,n)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&this.matchesComparison(It(t,this.value)):null!==t&&yt(this.value)===yt(t)&&this.matchesComparison(It(t,this.value))}matchesComparison(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return y()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class jt extends $t{constructor(e,t){super(),this.filters=e,this.op=t,this.ue=null}static create(e,t){return new jt(e,t)}matches(e){return Wt(this)?void 0===this.filters.find((t=>!t.matches(e))):void 0!==this.filters.find((t=>t.matches(e)))}getFlattenedFilters(){return null!==this.ue||(this.ue=this.filters.reduce(((e,t)=>e.concat(t.getFlattenedFilters())),[])),this.ue}getFilters(){return Object.assign([],this.filters)}}function Wt(e){return"and"===e.op}function Yt(e){return"or"===e.op}function Ht(e){return Jt(e)&&Wt(e)}function Jt(e){for(const t of e.filters)if(t instanceof jt)return!1;return!0}function Xt(e){if(e instanceof Qt)return e.field.canonicalString()+e.op.toString()+bt(e.value);if(Ht(e))return e.filters.map((e=>Xt(e))).join(",");{const t=e.filters.map((e=>Xt(e))).join(",");return`${e.op}(${t})`}}function Zt(e,t){return e instanceof Qt?function(e,t){return t instanceof Qt&&e.op===t.op&&e.field.isEqual(t.field)&&wt(e.value,t.value)}(e,t):e instanceof jt?function(e,t){return t instanceof jt&&e.op===t.op&&e.filters.length===t.filters.length&&e.filters.reduce(((e,n,r)=>e&&Zt(n,t.filters[r])),!0)}(e,t):void y()}function en(e,t){const n=e.filters.concat(t);return jt.create(n,e.op)}function tn(e){return e instanceof Qt?function(e){return`${e.field.canonicalString()} ${e.op} ${bt(e.value)}`}(e):e instanceof jt?function(e){return e.op.toString()+" {"+e.getFilters().map(tn).join(" ,")+"}"}(e):"Filter"}class nn extends Qt{constructor(e,t,n){super(e,t,n),this.key=z.fromName(n.referenceValue)}matches(e){const t=z.comparator(e.key,this.key);return this.matchesComparison(t)}}class rn extends Qt{constructor(e,t){super(e,"in",t),this.keys=on("in",t)}matches(e){return this.keys.some((t=>t.isEqual(e.key)))}}class sn extends Qt{constructor(e,t){super(e,"not-in",t),this.keys=on("not-in",t)}matches(e){return!this.keys.some((t=>t.isEqual(e.key)))}}function on(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map((e=>z.fromName(e.referenceValue)))}class an extends Qt{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return Ct(t)&&vt(t.arrayValue,this.value)}}class cn extends Qt{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&vt(this.value.arrayValue,t)}}class un extends Qt{constructor(e,t){super(e,"not-in",t)}matches(e){if(vt(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&!vt(this.value.arrayValue,t)}}class ln extends Qt{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Ct(t)||!t.arrayValue.values)&&t.arrayValue.values.some((e=>vt(this.value.arrayValue,e)))}}class hn{constructor(e,t=null,n=[],r=[],s=null,i=null,o=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.ce=null}}function dn(e,t=null,n=[],r=[],s=null,i=null,o=null){return new hn(e,t,n,r,s,i,o)}function fn(e){const t=v(e);if(null===t.ce){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map((e=>Xt(e))).join(","),e+="|ob:",e+=t.orderBy.map((e=>function(e){return e.field.canonicalString()+e.dir}(e))).join(","),pe(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((e=>bt(e))).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((e=>bt(e))).join(",")),t.ce=e}return t.ce}function mn(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let n=0;n<e.orderBy.length;n++)if(!Kt(e.orderBy[n],t.orderBy[n]))return!1;if(e.filters.length!==t.filters.length)return!1;for(let n=0;n<e.filters.length;n++)if(!Zt(e.filters[n],t.filters[n]))return!1;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!zt(e.startAt,t.startAt)&&zt(e.endAt,t.endAt)}function gn(e){return z.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function pn(e,t){return e.filters.filter((e=>e instanceof Qt&&e.field.isEqual(t)))}function yn(e,t,n){let r=pt,s=!0;for(const i of pn(e,t)){let e=pt,t=!0;switch(i.op){case"<":case"<=":e=Lt(i.value);break;case"==":case"in":case">=":e=i.value;break;case">":e=i.value,t=!1;break;case"!=":case"not-in":e=pt}Ft({value:r,inclusive:s},{value:e,inclusive:t})<0&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];Ft({value:r,inclusive:s},{value:e,inclusive:n.inclusive})<0&&(r=e,s=n.inclusive);break}return{value:r,inclusive:s}}function wn(e,t,n){let r=gt,s=!0;for(const i of pn(e,t)){let e=gt,t=!0;switch(i.op){case">=":case">":e=Rt(i.value),t=!1;break;case"==":case"in":case"<=":e=i.value;break;case"<":e=i.value,t=!1;break;case"!=":case"not-in":e=gt}Pt({value:r,inclusive:s},{value:e,inclusive:t})>0&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];Pt({value:r,inclusive:s},{value:e,inclusive:n.inclusive})>0&&(r=e,s=n.inclusive);break}return{value:r,inclusive:s}}class vn{constructor(e,t=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.le=null,this.he=null,this.Pe=null,this.startAt,this.endAt}}function In(e,t,n,r,s,i,o,a){return new vn(e,t,n,r,s,i,o,a)}function _n(e){return new vn(e)}function bn(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}function En(e){return null!==e.collectionGroup}function Tn(e){const t=v(e);if(null===t.le){t.le=[];const e=new Set;for(const s of t.explicitOrderBy)t.le.push(s),e.add(s.field.canonicalString());const n=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc",r=function(e){let t=new et(B.comparator);return e.filters.forEach((e=>{e.getFlattenedFilters().forEach((e=>{e.isInequality()&&(t=t.add(e.field))}))})),t}(t);r.forEach((r=>{e.has(r.canonicalString())||r.isKeyField()||t.le.push(new Gt(r,n))})),e.has(B.keyField().canonicalString())||t.le.push(new Gt(B.keyField(),n))}return t.le}function Sn(e){const t=v(e);return t.he||(t.he=xn(t,Tn(e))),t.he}function xn(e,t){if("F"===e.limitType)return dn(e.path,e.collectionGroup,t,e.filters,e.limit,e.startAt,e.endAt);{t=t.map((e=>{const t="desc"===e.dir?"asc":"desc";return new Gt(e.field,t)}));const n=e.endAt?new Ut(e.endAt.position,e.endAt.inclusive):null,r=e.startAt?new Ut(e.startAt.position,e.startAt.inclusive):null;return dn(e.path,e.collectionGroup,t,e.filters,e.limit,n,r)}}function Cn(e,t){const n=e.filters.concat([t]);return new vn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}function Dn(e,t,n){return new vn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function Nn(e,t){return mn(Sn(e),Sn(t))&&e.limitType===t.limitType}function An(e){return`${fn(Sn(e))}|lt:${e.limitType}`}function kn(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(t+=`, filters: [${e.filters.map((e=>tn(e))).join(", ")}]`),pe(e.limit)||(t+=", limit: "+e.limit),e.orderBy.length>0&&(t+=`, orderBy: [${e.orderBy.map((e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e))).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((e=>bt(e))).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((e=>bt(e))).join(",")),`Target(${t})`}(Sn(e))}; limitType=${e.limitType})`}function Mn(e,t){return t.isFoundDocument()&&function(e,t){const n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):z.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(const n of Tn(e))if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&function(e,t){return!(e.startAt&&!function(e,t,n){const r=Bt(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,Tn(e),t))&&!(e.endAt&&!function(e,t,n){const r=Bt(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,Tn(e),t))}(e,t)}function Ln(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function Rn(e){return(t,n)=>{let r=!1;for(const s of Tn(e)){const e=Fn(s,t,n);if(0!==e)return e;r=r||s.field.isKeyField()}return 0}}function Fn(e,t,n){const r=e.field.isKeyField()?z.comparator(t.key,n.key):function(e,t,n){const r=t.data.field(e),s=n.data.field(e);return null!==r&&null!==s?It(r,s):y()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return y()}}class Pn{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[r,s]of n)if(this.equalsFn(r,e))return s}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let s=0;s<r.length;s++)if(this.equalsFn(r[s][0],e))return void(r[s]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){Ye(this.inner,((t,n)=>{for(const[r,s]of n)e(r,s)}))}isEmpty(){return He(this.inner)}size(){return this.innerSize}}const Vn=new Je(z.comparator);function On(){return Vn}const qn=new Je(z.comparator);function Un(...e){let t=qn;for(const n of e)t=t.insert(n.key,n);return t}function Bn(e){let t=qn;return e.forEach(((e,n)=>t=t.insert(e,n.overlayedDocument))),t}function zn(){return Kn()}function Gn(){return Kn()}function Kn(){return new Pn((e=>e.toString()),((e,t)=>e.isEqual(t)))}const $n=new Je(z.comparator),Qn=new et(z.comparator);function jn(...e){let t=Qn;for(const n of e)t=t.add(n);return t}const Wn=new et(L);function Yn(){return Wn}function Hn(e,t){if(e.useProto3Json){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:ye(t)?"-0":t}}function Jn(e){return{integerValue:""+e}}function Xn(e,t){return we(t)?Jn(t):Hn(e,t)}class Zn{constructor(){this._=void 0}}function er(e,t,n){return e instanceof rr?function(e,t){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&lt(t)&&(t=ht(t)),t&&(n.fields.__previous_value__=t),{mapValue:n}}(n,t):e instanceof sr?ir(e,t):e instanceof or?ar(e,t):function(e,t){const n=nr(e,t),r=ur(n)+ur(e.Ie);return xt(n)&&xt(e.Ie)?Jn(r):Hn(e.serializer,r)}(e,t)}function tr(e,t,n){return e instanceof sr?ir(e,t):e instanceof or?ar(e,t):n}function nr(e,t){return e instanceof cr?function(e){return xt(e)||function(e){return!!e&&"doubleValue"in e}(e)}(t)?t:{integerValue:0}:null}class rr extends Zn{}class sr extends Zn{constructor(e){super(),this.elements=e}}function ir(e,t){const n=lr(t);for(const r of e.elements)n.some((e=>wt(e,r)))||n.push(r);return{arrayValue:{values:n}}}class or extends Zn{constructor(e){super(),this.elements=e}}function ar(e,t){let n=lr(t);for(const r of e.elements)n=n.filter((e=>!wt(e,r)));return{arrayValue:{values:n}}}class cr extends Zn{constructor(e,t){super(),this.serializer=e,this.Ie=t}}function ur(e){return ct(e.integerValue||e.doubleValue)}function lr(e){return Ct(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class hr{constructor(e,t){this.field=e,this.transform=t}}class dr{constructor(e,t){this.version=e,this.transformResults=t}}class fr{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new fr}static exists(e){return new fr(void 0,e)}static updateTime(e){return new fr(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function mr(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class gr{}function pr(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new xr(e.key,fr.none()):new _r(e.key,e.data,fr.none());{const n=e.data,r=Vt.empty();let s=new et(B.comparator);for(let e of t.fields)if(!s.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),s=s.add(e)}return new br(e.key,r,new rt(s.toArray()),fr.none())}}function yr(e,t,n){e instanceof _r?function(e,t,n){const r=e.value.clone(),s=Tr(e.fieldTransforms,t,n.transformResults);r.setAll(s),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof br?function(e,t,n){if(!mr(e.precondition,t))return void t.convertToUnknownDocument(n.version);const r=Tr(e.fieldTransforms,t,n.transformResults),s=t.data;s.setAll(Er(e)),s.setAll(r),t.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(e,t,n):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,t,n)}function wr(e,t,n,r){return e instanceof _r?function(e,t,n,r){if(!mr(e.precondition,t))return n;const s=e.value.clone(),i=Sr(e.fieldTransforms,r,t);return s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null}(e,t,n,r):e instanceof br?function(e,t,n,r){if(!mr(e.precondition,t))return n;const s=Sr(e.fieldTransforms,r,t),i=t.data;return i.setAll(Er(e)),i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map((e=>e.field)))}(e,t,n,r):function(e,t,n){return mr(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}(e,t,n)}function vr(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),s=nr(r.transform,e||null);null!=s&&(null===n&&(n=Vt.empty()),n.set(r.field,s))}return n||null}function Ir(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&!!function(e,t){return void 0===e&&void 0===t||!(!e||!t)&&R(e,t,((e,t)=>function(e,t){return e.field.isEqual(t.field)&&function(e,t){return e instanceof sr&&t instanceof sr||e instanceof or&&t instanceof or?R(e.elements,t.elements,wt):e instanceof cr&&t instanceof cr?wt(e.Ie,t.Ie):e instanceof rr&&t instanceof rr}(e.transform,t.transform)}(e,t)))}(e.fieldTransforms,t.fieldTransforms)&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class _r extends gr{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class br extends gr{constructor(e,t,n,r,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function Er(e){const t=new Map;return e.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const r=e.data.field(n);t.set(n,r)}})),t}function Tr(e,t,n){const r=new Map;w(e.length===n.length);for(let s=0;s<n.length;s++){const i=e[s],o=i.transform,a=t.data.field(i.field);r.set(i.field,tr(o,a,n[s]))}return r}function Sr(e,t,n){const r=new Map;for(const s of e){const e=s.transform,i=n.data.field(s.field);r.set(s.field,er(e,i,t))}return r}class xr extends gr{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class Cr extends gr{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Dr{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){const n=t.mutationResults;for(let r=0;r<this.mutations.length;r++){const t=this.mutations[r];t.key.isEqual(e.key)&&yr(t,e,n[r])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=wr(n,e,t,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(e.key)&&(t=wr(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const n=Gn();return this.mutations.forEach((r=>{const s=e.get(r.key),i=s.overlayedDocument;let o=this.applyToLocalView(i,s.mutatedFields);o=t.has(r.key)?null:o;const a=pr(i,o);null!==a&&n.set(r.key,a),i.isValidDocument()||i.convertToNoDocument(V.min())})),n}keys(){return this.mutations.reduce(((e,t)=>e.add(t.key)),jn())}isEqual(e){return this.batchId===e.batchId&&R(this.mutations,e.mutations,((e,t)=>Ir(e,t)))&&R(this.baseMutations,e.baseMutations,((e,t)=>Ir(e,t)))}}class Nr{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){w(e.mutations.length===n.length);let r=$n;const s=e.mutations;for(let i=0;i<s.length;i++)r=r.insert(s[i].key,n[i].version);return new Nr(e,t,n,r)}}class Ar{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class kr{constructor(e,t,n){this.alias=e,this.aggregateType=t,this.fieldPath=n}}class Mr{constructor(e,t){this.count=e,this.unchangedNames=t}}var Lr,Rr;function Fr(e){switch(e){default:return y();case I.CANCELLED:case I.UNKNOWN:case I.DEADLINE_EXCEEDED:case I.RESOURCE_EXHAUSTED:case I.INTERNAL:case I.UNAVAILABLE:case I.UNAUTHENTICATED:return!1;case I.INVALID_ARGUMENT:case I.NOT_FOUND:case I.ALREADY_EXISTS:case I.PERMISSION_DENIED:case I.FAILED_PRECONDITION:case I.ABORTED:case I.OUT_OF_RANGE:case I.UNIMPLEMENTED:case I.DATA_LOSS:return!0}}function Pr(e){if(void 0===e)return m("GRPC error has no .code"),I.UNKNOWN;switch(e){case Lr.OK:return I.OK;case Lr.CANCELLED:return I.CANCELLED;case Lr.UNKNOWN:return I.UNKNOWN;case Lr.DEADLINE_EXCEEDED:return I.DEADLINE_EXCEEDED;case Lr.RESOURCE_EXHAUSTED:return I.RESOURCE_EXHAUSTED;case Lr.INTERNAL:return I.INTERNAL;case Lr.UNAVAILABLE:return I.UNAVAILABLE;case Lr.UNAUTHENTICATED:return I.UNAUTHENTICATED;case Lr.INVALID_ARGUMENT:return I.INVALID_ARGUMENT;case Lr.NOT_FOUND:return I.NOT_FOUND;case Lr.ALREADY_EXISTS:return I.ALREADY_EXISTS;case Lr.PERMISSION_DENIED:return I.PERMISSION_DENIED;case Lr.FAILED_PRECONDITION:return I.FAILED_PRECONDITION;case Lr.ABORTED:return I.ABORTED;case Lr.OUT_OF_RANGE:return I.OUT_OF_RANGE;case Lr.UNIMPLEMENTED:return I.UNIMPLEMENTED;case Lr.DATA_LOSS:return I.DATA_LOSS;default:return y()}}(Rr=Lr||(Lr={}))[Rr.OK=0]="OK",Rr[Rr.CANCELLED=1]="CANCELLED",Rr[Rr.UNKNOWN=2]="UNKNOWN",Rr[Rr.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Rr[Rr.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Rr[Rr.NOT_FOUND=5]="NOT_FOUND",Rr[Rr.ALREADY_EXISTS=6]="ALREADY_EXISTS",Rr[Rr.PERMISSION_DENIED=7]="PERMISSION_DENIED",Rr[Rr.UNAUTHENTICATED=16]="UNAUTHENTICATED",Rr[Rr.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Rr[Rr.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Rr[Rr.ABORTED=10]="ABORTED",Rr[Rr.OUT_OF_RANGE=11]="OUT_OF_RANGE",Rr[Rr.UNIMPLEMENTED=12]="UNIMPLEMENTED",Rr[Rr.INTERNAL=13]="INTERNAL",Rr[Rr.UNAVAILABLE=14]="UNAVAILABLE",Rr[Rr.DATA_LOSS=15]="DATA_LOSS";let Vr=null;function Or(){return new TextEncoder}const qr=new a.Integer([4294967295,4294967295],0);function Ur(e){const t=Or().encode(e),n=new a.Md5;return n.update(t),new Uint8Array(n.digest())}function Br(e){const t=new DataView(e.buffer),n=t.getUint32(0,!0),r=t.getUint32(4,!0),s=t.getUint32(8,!0),i=t.getUint32(12,!0);return[new a.Integer([n,r],0),new a.Integer([s,i],0)]}class zr{constructor(e,t,n){if(this.bitmap=e,this.padding=t,this.hashCount=n,t<0||t>=8)throw new Gr(`Invalid padding: ${t}`);if(n<0)throw new Gr(`Invalid hash count: ${n}`);if(e.length>0&&0===this.hashCount)throw new Gr(`Invalid hash count: ${n}`);if(0===e.length&&0!==t)throw new Gr(`Invalid padding when bitmap length is 0: ${t}`);this.Te=8*e.length-t,this.Ee=a.Integer.fromNumber(this.Te)}de(e,t,n){let r=e.add(t.multiply(a.Integer.fromNumber(n)));return 1===r.compare(qr)&&(r=new a.Integer([r.getBits(0),r.getBits(1)],0)),r.modulo(this.Ee).toNumber()}Ae(e){return 0!=(this.bitmap[Math.floor(e/8)]&1<<e%8)}mightContain(e){if(0===this.Te)return!1;const t=Ur(e),[n,r]=Br(t);for(let s=0;s<this.hashCount;s++){const e=this.de(n,r,s);if(!this.Ae(e))return!1}return!0}static create(e,t,n){const r=e%8==0?0:8-e%8,s=new Uint8Array(Math.ceil(e/8)),i=new zr(s,r,t);return n.forEach((e=>i.insert(e))),i}insert(e){if(0===this.Te)return;const t=Ur(e),[n,r]=Br(t);for(let s=0;s<this.hashCount;s++){const e=this.de(n,r,s);this.Re(e)}}Re(e){const t=Math.floor(e/8),n=e%8;this.bitmap[t]|=1<<n}}class Gr extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}class Kr{constructor(e,t,n,r,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t,n){const r=new Map;return r.set(e,$r.createSynthesizedTargetChangeForCurrentChange(e,t,n)),new Kr(V.min(),r,new Je(L),On(),jn())}}class $r{constructor(e,t,n,r,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t,n){return new $r(n,t,jn(),jn(),jn())}}class Qr{constructor(e,t,n,r){this.Ve=e,this.removedTargetIds=t,this.key=n,this.me=r}}class jr{constructor(e,t){this.targetId=e,this.fe=t}}class Wr{constructor(e,t,n=it.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class Yr{constructor(){this.ge=0,this.pe=Xr(),this.ye=it.EMPTY_BYTE_STRING,this.we=!1,this.Se=!0}get current(){return this.we}get resumeToken(){return this.ye}get be(){return 0!==this.ge}get De(){return this.Se}Ce(e){e.approximateByteSize()>0&&(this.Se=!0,this.ye=e)}ve(){let e=jn(),t=jn(),n=jn();return this.pe.forEach(((r,s)=>{switch(s){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:y()}})),new $r(this.ye,this.we,e,t,n)}Fe(){this.Se=!1,this.pe=Xr()}Me(e,t){this.Se=!0,this.pe=this.pe.insert(e,t)}xe(e){this.Se=!0,this.pe=this.pe.remove(e)}Oe(){this.ge+=1}Ne(){this.ge-=1,w(this.ge>=0)}Be(){this.Se=!0,this.we=!0}}class Hr{constructor(e){this.Le=e,this.ke=new Map,this.qe=On(),this.Qe=Jr(),this.Ke=new Je(L)}$e(e){for(const t of e.Ve)e.me&&e.me.isFoundDocument()?this.Ue(t,e.me):this.We(t,e.key,e.me);for(const t of e.removedTargetIds)this.We(t,e.key,e.me)}Ge(e){this.forEachTarget(e,(t=>{const n=this.ze(t);switch(e.state){case 0:this.je(t)&&n.Ce(e.resumeToken);break;case 1:n.Ne(),n.be||n.Fe(),n.Ce(e.resumeToken);break;case 2:n.Ne(),n.be||this.removeTarget(t);break;case 3:this.je(t)&&(n.Be(),n.Ce(e.resumeToken));break;case 4:this.je(t)&&(this.He(t),n.Ce(e.resumeToken));break;default:y()}}))}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.ke.forEach(((e,n)=>{this.je(n)&&t(n)}))}Je(e){const t=e.targetId,n=e.fe.count,r=this.Ye(t);if(r){const s=r.target;if(gn(s))if(0===n){const e=new z(s.path);this.We(t,e,qt.newNoDocument(e,V.min()))}else w(1===n);else{const r=this.Ze(t);if(r!==n){const n=this.Xe(e),s=n?this.et(n,e,r):1;if(0!==s){this.He(t);const e=2===s?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Ke=this.Ke.insert(t,e)}null==Vr||Vr.tt(function(e,t,n,r,s){var i,o,a,c,u,l;const h={localCacheCount:e,existenceFilterCount:t.count,databaseId:n.database,projectId:n.projectId},d=t.unchangedNames;return d&&(h.bloomFilter={applied:0===s,hashCount:null!==(i=null==d?void 0:d.hashCount)&&void 0!==i?i:0,bitmapLength:null!==(c=null===(a=null===(o=null==d?void 0:d.bits)||void 0===o?void 0:o.bitmap)||void 0===a?void 0:a.length)&&void 0!==c?c:0,padding:null!==(l=null===(u=null==d?void 0:d.bits)||void 0===u?void 0:u.padding)&&void 0!==l?l:0,mightContain:e=>{var t;return null!==(t=null==r?void 0:r.mightContain(e))&&void 0!==t&&t}}),h}(r,e.fe,this.Le.nt(),n,s))}}}}Xe(e){const t=e.fe.unchangedNames;if(!t||!t.bits)return null;const{bits:{bitmap:n="",padding:r=0},hashCount:s=0}=t;let i,o;try{i=ut(n).toUint8Array()}catch(e){if(e instanceof st)return g("Decoding the base64 bloom filter in existence filter failed ("+e.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw e}try{o=new zr(i,r,s)}catch(e){return g(e instanceof Gr?"BloomFilter error: ":"Applying bloom filter failed: ",e),null}return 0===o.Te?null:o}et(e,t,n){return t.fe.count===n-this.rt(e,t.targetId)?0:2}rt(e,t){const n=this.Le.getRemoteKeysForTarget(t);let r=0;return n.forEach((n=>{const s=this.Le.nt(),i=`projects/${s.projectId}/databases/${s.database}/documents/${n.path.canonicalString()}`;e.mightContain(i)||(this.We(t,n,null),r++)})),r}it(e){const t=new Map;this.ke.forEach(((n,r)=>{const s=this.Ye(r);if(s){if(n.current&&gn(s.target)){const t=new z(s.target.path);null!==this.qe.get(t)||this.st(r,t)||this.We(r,t,qt.newNoDocument(t,e))}n.De&&(t.set(r,n.ve()),n.Fe())}}));let n=jn();this.Qe.forEach(((e,t)=>{let r=!0;t.forEachWhile((e=>{const t=this.Ye(e);return!t||"TargetPurposeLimboResolution"===t.purpose||(r=!1,!1)})),r&&(n=n.add(e))})),this.qe.forEach(((t,n)=>n.setReadTime(e)));const r=new Kr(e,t,this.Ke,this.qe,n);return this.qe=On(),this.Qe=Jr(),this.Ke=new Je(L),r}Ue(e,t){if(!this.je(e))return;const n=this.st(e,t.key)?2:0;this.ze(e).Me(t.key,n),this.qe=this.qe.insert(t.key,t),this.Qe=this.Qe.insert(t.key,this.ot(t.key).add(e))}We(e,t,n){if(!this.je(e))return;const r=this.ze(e);this.st(e,t)?r.Me(t,1):r.xe(t),this.Qe=this.Qe.insert(t,this.ot(t).delete(e)),n&&(this.qe=this.qe.insert(t,n))}removeTarget(e){this.ke.delete(e)}Ze(e){const t=this.ze(e).ve();return this.Le.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Oe(e){this.ze(e).Oe()}ze(e){let t=this.ke.get(e);return t||(t=new Yr,this.ke.set(e,t)),t}ot(e){let t=this.Qe.get(e);return t||(t=new et(L),this.Qe=this.Qe.insert(e,t)),t}je(e){const t=null!==this.Ye(e);return t||f("WatchChangeAggregator","Detected inactive target",e),t}Ye(e){const t=this.ke.get(e);return t&&t.be?null:this.Le._t(e)}He(e){this.ke.set(e,new Yr),this.Le.getRemoteKeysForTarget(e).forEach((t=>{this.We(e,t,null)}))}st(e,t){return this.Le.getRemoteKeysForTarget(e).has(t)}}function Jr(){return new Je(z.comparator)}function Xr(){return new Je(z.comparator)}const Zr={asc:"ASCENDING",desc:"DESCENDING"},es={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},ts={and:"AND",or:"OR"};class ns{constructor(e,t){this.databaseId=e,this.useProto3Json=t}}function rs(e,t){return e.useProto3Json||pe(t)?t:{value:t}}function ss(e,t){return e.useProto3Json?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function is(e,t){return e.useProto3Json?t.toBase64():t.toUint8Array()}function os(e,t){return ss(e,t.toTimestamp())}function as(e){return w(!!e),V.fromTimestamp(function(e){const t=at(e);return new P(t.seconds,t.nanos)}(e))}function cs(e,t){return us(e,t).canonicalString()}function us(e,t){const n=function(e){return new q(["projects",e.projectId,"databases",e.database])}(e).child("documents");return void 0===t?n:n.child(t)}function ls(e){const t=q.fromString(e);return w(Ms(t)),t}function hs(e,t){return cs(e.databaseId,t.path)}function ds(e,t){const n=ls(t);if(n.get(1)!==e.databaseId.projectId)throw new _(I.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new _(I.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new z(ps(n))}function fs(e,t){return cs(e.databaseId,t)}function ms(e){const t=ls(e);return 4===t.length?q.emptyPath():ps(t)}function gs(e){return new q(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function ps(e){return w(e.length>4&&"documents"===e.get(4)),e.popFirst(5)}function ys(e,t,n){return{name:hs(e,t),fields:n.value.mapValue.fields}}function ws(e,t,n){const r=ds(e,t.name),s=as(t.updateTime),i=t.createTime?as(t.createTime):V.min(),o=new Vt({mapValue:{fields:t.fields}}),a=qt.newFoundDocument(r,s,i,o);return n&&a.setHasCommittedMutations(),n?a.setHasCommittedMutations():a}function vs(e,t){let n;if(t instanceof _r)n={update:ys(e,t.key,t.value)};else if(t instanceof xr)n={delete:hs(e,t.key)};else if(t instanceof br)n={update:ys(e,t.key,t.data),updateMask:ks(t.fieldMask)};else{if(!(t instanceof Cr))return y();n={verify:hs(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map((e=>function(e,t){const n=t.transform;if(n instanceof rr)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof sr)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof or)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof cr)return{fieldPath:t.field.canonicalString(),increment:n.Ie};throw y()}(0,e)))),t.precondition.isNone||(n.currentDocument=function(e,t){return void 0!==t.updateTime?{updateTime:os(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:y()}(e,t.precondition)),n}function Is(e,t){const n=t.currentDocument?function(e){return void 0!==e.updateTime?fr.updateTime(as(e.updateTime)):void 0!==e.exists?fr.exists(e.exists):fr.none()}(t.currentDocument):fr.none(),r=t.updateTransforms?t.updateTransforms.map((t=>function(e,t){let n=null;if("setToServerValue"in t)w("REQUEST_TIME"===t.setToServerValue),n=new rr;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new sr(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new or(e)}else"increment"in t?n=new cr(e,t.increment):y();const r=B.fromServerFormat(t.fieldPath);return new hr(r,n)}(e,t))):[];if(t.update){t.update.name;const s=ds(e,t.update.name),i=new Vt({mapValue:{fields:t.update.fields}});if(t.updateMask){const e=function(e){const t=e.fieldPaths||[];return new rt(t.map((e=>B.fromServerFormat(e))))}(t.updateMask);return new br(s,i,e,n,r)}return new _r(s,i,n,r)}if(t.delete){const r=ds(e,t.delete);return new xr(r,n)}if(t.verify){const r=ds(e,t.verify);return new Cr(r,n)}return y()}function _s(e,t){return{documents:[fs(e,t.path)]}}function bs(e,t){const n={structuredQuery:{}},r=t.path;let s;null!==t.collectionGroup?(s=r,n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(s=r.popLast(),n.structuredQuery.from=[{collectionId:r.lastSegment()}]),n.parent=fs(e,s);const i=function(e){if(0!==e.length)return As(jt.create(e,"and"))}(t.filters);i&&(n.structuredQuery.where=i);const o=function(e){if(0!==e.length)return e.map((e=>function(e){return{field:Ds(e.field),direction:Ss(e.dir)}}(e)))}(t.orderBy);o&&(n.structuredQuery.orderBy=o);const a=rs(e,t.limit);return null!==a&&(n.structuredQuery.limit=a),t.startAt&&(n.structuredQuery.startAt=function(e){return{before:e.inclusive,values:e.position}}(t.startAt)),t.endAt&&(n.structuredQuery.endAt=function(e){return{before:!e.inclusive,values:e.position}}(t.endAt)),{ut:n,parent:s}}function Es(e){let t=ms(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let s=null;if(r>0){w(1===r);const e=n.from[0];e.allDescendants?s=e.collectionId:t=t.child(e.collectionId)}let i=[];n.where&&(i=function(e){const t=Ts(e);return t instanceof jt&&Ht(t)?t.getFilters():[t]}(n.where));let o=[];n.orderBy&&(o=function(e){return e.map((e=>function(e){return new Gt(Ns(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e)))}(n.orderBy));let a=null;n.limit&&(a=function(e){let t;return t="object"==typeof e?e.value:e,pe(t)?null:t}(n.limit));let c=null;n.startAt&&(c=function(e){const t=!!e.before,n=e.values||[];return new Ut(n,t)}(n.startAt));let u=null;return n.endAt&&(u=function(e){const t=!e.before,n=e.values||[];return new Ut(n,t)}(n.endAt)),In(t,s,o,i,a,"F",c,u)}function Ts(e){return void 0!==e.unaryFilter?function(e){switch(e.unaryFilter.op){case"IS_NAN":const t=Ns(e.unaryFilter.field);return Qt.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=Ns(e.unaryFilter.field);return Qt.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=Ns(e.unaryFilter.field);return Qt.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const s=Ns(e.unaryFilter.field);return Qt.create(s,"!=",{nullValue:"NULL_VALUE"});default:return y()}}(e):void 0!==e.fieldFilter?function(e){return Qt.create(Ns(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return y()}}(e.fieldFilter.op),e.fieldFilter.value)}(e):void 0!==e.compositeFilter?function(e){return jt.create(e.compositeFilter.filters.map((e=>Ts(e))),function(e){switch(e){case"AND":return"and";case"OR":return"or";default:return y()}}(e.compositeFilter.op))}(e):y()}function Ss(e){return Zr[e]}function xs(e){return es[e]}function Cs(e){return ts[e]}function Ds(e){return{fieldPath:e.canonicalString()}}function Ns(e){return B.fromServerFormat(e.fieldPath)}function As(e){return e instanceof Qt?function(e){if("=="===e.op){if(Nt(e.value))return{unaryFilter:{field:Ds(e.field),op:"IS_NAN"}};if(Dt(e.value))return{unaryFilter:{field:Ds(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(Nt(e.value))return{unaryFilter:{field:Ds(e.field),op:"IS_NOT_NAN"}};if(Dt(e.value))return{unaryFilter:{field:Ds(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:Ds(e.field),op:xs(e.op),value:e.value}}}(e):e instanceof jt?function(e){const t=e.getFilters().map((e=>As(e)));return 1===t.length?t[0]:{compositeFilter:{op:Cs(e.op),filters:t}}}(e):y()}function ks(e){const t=[];return e.fields.forEach((e=>t.push(e.canonicalString()))),{fieldPaths:t}}function Ms(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}class Ls{constructor(e,t,n,r,s=V.min(),i=V.min(),o=it.EMPTY_BYTE_STRING,a=null){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o,this.expectedCount=a}withSequenceNumber(e){return new Ls(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(e,t){return new Ls(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e,null)}withExpectedCount(e){return new Ls(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,e)}withLastLimboFreeSnapshotVersion(e){return new Ls(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken,this.expectedCount)}}class Rs{constructor(e){this.ct=e}}function Fs(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:Ps(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document=function(e,t){return{name:hs(e,t.key),fields:t.data.value.mapValue.fields,updateTime:ss(e,t.version.toTimestamp()),createTime:ss(e,t.createTime.toTimestamp())}}(e.ct,t);else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:Vs(t.version)};else{if(!t.isUnknownDocument())return y();r.unknownDocument={path:n.path.toArray(),version:Vs(t.version)}}return r}function Ps(e){const t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function Vs(e){const t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function Os(e){const t=new P(e.seconds,e.nanoseconds);return V.fromTimestamp(t)}function qs(e,t){const n=(t.baseMutations||[]).map((t=>Is(e.ct,t)));for(let i=0;i<t.mutations.length-1;++i){const e=t.mutations[i];if(i+1<t.mutations.length&&void 0!==t.mutations[i+1].transform){const n=t.mutations[i+1];e.updateTransforms=n.transform.fieldTransforms,t.mutations.splice(i+1,1),++i}}const r=t.mutations.map((t=>Is(e.ct,t))),s=P.fromMillis(t.localWriteTimeMs);return new Dr(t.batchId,s,n,r)}function Us(e){const t=Os(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?Os(e.lastLimboFreeSnapshotVersion):V.min();let r;return r=function(e){return void 0!==e.documents}(e.query)?function(e){return w(1===e.documents.length),Sn(_n(ms(e.documents[0])))}(e.query):function(e){return Sn(Es(e))}(e.query),new Ls(r,e.targetId,"TargetPurposeListen",e.lastListenSequenceNumber,t,n,it.fromBase64String(e.resumeToken))}function Bs(e,t){const n=Vs(t.snapshotVersion),r=Vs(t.lastLimboFreeSnapshotVersion);let s;s=gn(t.target)?_s(e.ct,t.target):bs(e.ct,t.target).ut;const i=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:fn(t.target),readTime:n,resumeToken:i,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:s}}function zs(e){const t=Es({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Dn(t,t.limit,"L"):t}function Gs(e,t){return new Ar(t.largestBatchId,Is(e.ct,t.overlayMutation))}function Ks(e,t){const n=t.path.lastSegment();return[e,ve(t.path.popLast()),n]}function $s(e,t,n,r){return{indexId:e,uid:t,sequenceNumber:n,readTime:Vs(r.readTime),documentKey:ve(r.documentKey.path),largestBatchId:r.largestBatchId}}class Qs{getBundleMetadata(e,t){return js(e).get(t).next((e=>{if(e)return function(e){return{id:e.bundleId,createTime:Os(e.createTime),version:e.version}}(e)}))}saveBundleMetadata(e,t){return js(e).put(function(e){return{bundleId:e.id,createTime:Vs(as(e.createTime)),version:e.version}}(t))}getNamedQuery(e,t){return Ws(e).get(t).next((e=>{if(e)return function(e){return{name:e.name,query:zs(e.bundledQuery),readTime:Os(e.readTime)}}(e)}))}saveNamedQuery(e,t){return Ws(e).put(function(e){return{name:e.name,readTime:Vs(as(e.readTime)),bundledQuery:e.bundledQuery}}(t))}}function js(e){return je(e,"bundles")}function Ws(e){return je(e,"namedQueries")}class Ys{constructor(e,t){this.serializer=e,this.userId=t}static lt(e,t){const n=t.uid||"";return new Ys(e,n)}getOverlay(e,t){return Hs(e).get(Ks(this.userId,t)).next((e=>e?Gs(this.serializer,e):null))}getOverlays(e,t){const n=zn();return re.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){const r=[];return n.forEach(((n,s)=>{const i=new Ar(t,s);r.push(this.ht(e,i))})),re.waitFor(r)}removeOverlaysForBatchId(e,t,n){const r=new Set;t.forEach((e=>r.add(ve(e.getCollectionPath()))));const s=[];return r.forEach((t=>{const r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);s.push(Hs(e).H("collectionPathOverlayIndex",r))})),re.waitFor(s)}getOverlaysForCollection(e,t,n){const r=zn(),s=ve(t),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return Hs(e).W("collectionPathOverlayIndex",i).next((e=>{for(const t of e){const e=Gs(this.serializer,t);r.set(e.getKey(),e)}return r}))}getOverlaysForCollectionGroup(e,t,n,r){const s=zn();let i;const o=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return Hs(e).Y({index:"collectionGroupOverlayIndex",range:o},((e,t,n)=>{const o=Gs(this.serializer,t);s.size()<r||o.largestBatchId===i?(s.set(o.getKey(),o),i=o.largestBatchId):n.done()})).next((()=>s))}ht(e,t){return Hs(e).put(function(e,t,n){const[r,s,i]=Ks(t,n.mutation.key);return{userId:t,collectionPath:s,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:vs(e.ct,n.mutation)}}(this.serializer,this.userId,t))}}function Hs(e){return je(e,"documentOverlays")}class Js{constructor(){}Pt(e,t){this.It(e,t),t.Tt()}It(e,t){if("nullValue"in e)this.Et(t,5);else if("booleanValue"in e)this.Et(t,10),t.dt(e.booleanValue?1:0);else if("integerValue"in e)this.Et(t,15),t.dt(ct(e.integerValue));else if("doubleValue"in e){const n=ct(e.doubleValue);isNaN(n)?this.Et(t,13):(this.Et(t,15),ye(n)?t.dt(0):t.dt(n))}else if("timestampValue"in e){const n=e.timestampValue;this.Et(t,20),"string"==typeof n?t.At(n):(t.At(`${n.seconds||""}`),t.dt(n.nanos||0))}else if("stringValue"in e)this.Rt(e.stringValue,t),this.Vt(t);else if("bytesValue"in e)this.Et(t,30),t.ft(ut(e.bytesValue)),this.Vt(t);else if("referenceValue"in e)this.gt(e.referenceValue,t);else if("geoPointValue"in e){const n=e.geoPointValue;this.Et(t,45),t.dt(n.latitude||0),t.dt(n.longitude||0)}else"mapValue"in e?Mt(e)?this.Et(t,Number.MAX_SAFE_INTEGER):(this.yt(e.mapValue,t),this.Vt(t)):"arrayValue"in e?(this.wt(e.arrayValue,t),this.Vt(t)):y()}Rt(e,t){this.Et(t,25),this.St(e,t)}St(e,t){t.At(e)}yt(e,t){const n=e.fields||{};this.Et(t,55);for(const r of Object.keys(n))this.Rt(r,t),this.It(n[r],t)}wt(e,t){const n=e.values||[];this.Et(t,50);for(const r of n)this.It(r,t)}gt(e,t){this.Et(t,37),z.fromName(e).path.forEach((e=>{this.Et(t,60),this.St(e,t)}))}Et(e,t){e.dt(t)}Vt(e){e.dt(2)}}function Xs(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}function Zs(e){const t=64-function(e){let t=0;for(let n=0;n<8;++n){const r=Xs(255&e[n]);if(t+=r,8!==r)break}return t}(e);return Math.ceil(t/8)}Js.bt=new Js;class ei{constructor(){this.buffer=new Uint8Array(1024),this.position=0}Dt(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ct(n.value),n=t.next();this.vt()}Ft(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Mt(n.value),n=t.next();this.xt()}Ot(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ct(e);else if(e<2048)this.Ct(960|e>>>6),this.Ct(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ct(480|e>>>12),this.Ct(128|63&e>>>6),this.Ct(128|63&e);else{const e=t.codePointAt(0);this.Ct(240|e>>>18),this.Ct(128|63&e>>>12),this.Ct(128|63&e>>>6),this.Ct(128|63&e)}}this.vt()}Nt(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Mt(e);else if(e<2048)this.Mt(960|e>>>6),this.Mt(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Mt(480|e>>>12),this.Mt(128|63&e>>>6),this.Mt(128|63&e);else{const e=t.codePointAt(0);this.Mt(240|e>>>18),this.Mt(128|63&e>>>12),this.Mt(128|63&e>>>6),this.Mt(128|63&e)}}this.xt()}Bt(e){const t=this.Lt(e),n=Zs(t);this.kt(1+n),this.buffer[this.position++]=255&n;for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=255&t[r]}qt(e){const t=this.Lt(e),n=Zs(t);this.kt(1+n),this.buffer[this.position++]=~(255&n);for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=~(255&t[r])}Qt(){this.Kt(255),this.Kt(255)}$t(){this.Ut(255),this.Ut(255)}reset(){this.position=0}seed(e){this.kt(e.length),this.buffer.set(e,this.position),this.position+=e.length}Wt(){return this.buffer.slice(0,this.position)}Lt(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=0!=(128&t[0]);t[0]^=n?255:128;for(let r=1;r<t.length;++r)t[r]^=n?255:0;return t}Ct(e){const t=255&e;0===t?(this.Kt(0),this.Kt(255)):255===t?(this.Kt(255),this.Kt(0)):this.Kt(t)}Mt(e){const t=255&e;0===t?(this.Ut(0),this.Ut(255)):255===t?(this.Ut(255),this.Ut(0)):this.Ut(e)}vt(){this.Kt(0),this.Kt(1)}xt(){this.Ut(0),this.Ut(1)}Kt(e){this.kt(1),this.buffer[this.position++]=e}Ut(e){this.kt(1),this.buffer[this.position++]=~e}kt(e){const t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);const r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class ti{constructor(e){this.Gt=e}ft(e){this.Gt.Dt(e)}At(e){this.Gt.Ot(e)}dt(e){this.Gt.Bt(e)}Tt(){this.Gt.Qt()}}class ni{constructor(e){this.Gt=e}ft(e){this.Gt.Ft(e)}At(e){this.Gt.Nt(e)}dt(e){this.Gt.qt(e)}Tt(){this.Gt.$t()}}class ri{constructor(){this.Gt=new ei,this.zt=new ti(this.Gt),this.jt=new ni(this.Gt)}seed(e){this.Gt.seed(e)}Ht(e){return 0===e?this.zt:this.jt}Wt(){return this.Gt.Wt()}reset(){this.Gt.reset()}}class si{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Jt(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new si(this.indexId,this.documentKey,this.arrayValue,n)}}function ii(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=oi(e.arrayValue,t.arrayValue),0!==n?n:(n=oi(e.directionalValue,t.directionalValue),0!==n?n:z.comparator(e.documentKey,t.documentKey)))}function oi(e,t){for(let n=0;n<e.length&&n<t.length;++n){const r=e[n]-t[n];if(0!==r)return r}return e.length-t.length}class ai{constructor(e){this.Yt=new et(((e,t)=>B.comparator(e.field,t.field))),this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Zt=e.orderBy,this.Xt=[];for(const t of e.filters){const e=t;e.isInequality()?this.Yt=this.Yt.add(e):this.Xt.push(e)}}get en(){return this.Yt.size>1}tn(e){if(w(e.collectionGroup===this.collectionId),this.en)return!1;const t=K(e);if(void 0!==t&&!this.nn(t))return!1;const n=$(e);let r=new Set,s=0,i=0;for(;s<n.length&&this.nn(n[s]);++s)r=r.add(n[s].fieldPath.canonicalString());if(s===n.length)return!0;if(this.Yt.size>0){const e=this.Yt.getIterator().getNext();if(!r.has(e.field.canonicalString())){const t=n[s];if(!this.rn(e,t)||!this.sn(this.Zt[i++],t))return!1}++s}for(;s<n.length;++s){const e=n[s];if(i>=this.Zt.length||!this.sn(this.Zt[i++],e))return!1}return!0}on(){if(this.en)return null;let e=new et(B.comparator);const t=[];for(const n of this.Xt)if(!n.field.isKeyField())if("array-contains"===n.op||"array-contains-any"===n.op)t.push(new j(n.field,2));else{if(e.has(n.field))continue;e=e.add(n.field),t.push(new j(n.field,0))}for(const n of this.Zt)n.field.isKeyField()||e.has(n.field)||(e=e.add(n.field),t.push(new j(n.field,"asc"===n.dir?0:1)));return new G(G.UNKNOWN_ID,this.collectionId,t,Y.empty())}nn(e){for(const t of this.Xt)if(this.rn(t,e))return!0;return!1}rn(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;const n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}sn(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}function ci(e){var t,n;if(w(e instanceof Qt||e instanceof jt),e instanceof Qt){if(e instanceof cn){const r=(null===(n=null===(t=e.value.arrayValue)||void 0===t?void 0:t.values)||void 0===n?void 0:n.map((t=>Qt.create(e.field,"==",t))))||[];return jt.create(r,"or")}return e}const r=e.filters.map((e=>ci(e)));return jt.create(r,e.op)}function ui(e){if(0===e.getFilters().length)return[];const t=fi(ci(e));return w(di(t)),li(t)||hi(t)?[t]:t.getFilters()}function li(e){return e instanceof Qt}function hi(e){return e instanceof jt&&Ht(e)}function di(e){return li(e)||hi(e)||function(e){if(e instanceof jt&&Yt(e)){for(const t of e.getFilters())if(!li(t)&&!hi(t))return!1;return!0}return!1}(e)}function fi(e){if(w(e instanceof Qt||e instanceof jt),e instanceof Qt)return e;if(1===e.filters.length)return fi(e.filters[0]);const t=e.filters.map((e=>fi(e)));let n=jt.create(t,e.op);return n=pi(n),di(n)?n:(w(n instanceof jt),w(Wt(n)),w(n.filters.length>1),n.filters.reduce(((e,t)=>mi(e,t))))}function mi(e,t){let n;return w(e instanceof Qt||e instanceof jt),w(t instanceof Qt||t instanceof jt),n=e instanceof Qt?t instanceof Qt?function(e,t){return jt.create([e,t],"and")}(e,t):gi(e,t):t instanceof Qt?gi(t,e):function(e,t){if(w(e.filters.length>0&&t.filters.length>0),Wt(e)&&Wt(t))return en(e,t.getFilters());const n=Yt(e)?e:t,r=Yt(e)?t:e,s=n.filters.map((e=>mi(e,r)));return jt.create(s,"or")}(e,t),pi(n)}function gi(e,t){if(Wt(t))return en(t,e.getFilters());{const n=t.filters.map((t=>mi(e,t)));return jt.create(n,"or")}}function pi(e){if(w(e instanceof Qt||e instanceof jt),e instanceof Qt)return e;const t=e.getFilters();if(1===t.length)return pi(t[0]);if(Jt(e))return e;const n=t.map((e=>pi(e))),r=[];return n.forEach((t=>{t instanceof Qt?r.push(t):t instanceof jt&&(t.op===e.op?r.push(...t.filters):r.push(t))})),1===r.length?r[0]:jt.create(r,e.op)}class yi{constructor(){this._n=new wi}addToCollectionParentIndex(e,t){return this._n.add(t),re.resolve()}getCollectionParents(e,t){return re.resolve(this._n.getEntries(t))}addFieldIndex(e,t){return re.resolve()}deleteFieldIndex(e,t){return re.resolve()}deleteAllFieldIndexes(e){return re.resolve()}createTargetIndexes(e,t){return re.resolve()}getDocumentsMatchingTarget(e,t){return re.resolve(null)}getIndexType(e,t){return re.resolve(0)}getFieldIndexes(e,t){return re.resolve([])}getNextCollectionGroupToUpdate(e){return re.resolve(null)}getMinOffset(e,t){return re.resolve(X.min())}getMinOffsetFromCollectionGroup(e,t){return re.resolve(X.min())}updateCollectionGroup(e,t,n){return re.resolve()}updateIndexEntries(e,t){return re.resolve()}}class wi{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new et(q.comparator),s=!r.has(n);return this.index[t]=r.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new et(q.comparator)).toArray()}}const vi=new Uint8Array(0);class Ii{constructor(e,t){this.databaseId=t,this.an=new wi,this.un=new Pn((e=>fn(e)),((e,t)=>mn(e,t))),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.an.has(t)){const n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener((()=>{this.an.add(t)}));const s={collectionId:n,parent:ve(r)};return _i(e).put(s)}return re.resolve()}getCollectionParents(e,t){const n=[],r=IDBKeyRange.bound([t,""],[F(t),""],!1,!0);return _i(e).W(r).next((e=>{for(const r of e){if(r.collectionId!==t)break;n.push(be(r.parent))}return n}))}addFieldIndex(e,t){const n=Ei(e),r=function(e){return{indexId:e.indexId,collectionGroup:e.collectionGroup,fields:e.fields.map((e=>[e.fieldPath.canonicalString(),e.kind]))}}(t);delete r.indexId;const s=n.add(r);if(t.indexState){const n=Ti(e);return s.next((e=>{n.put($s(e,this.uid,t.indexState.sequenceNumber,t.indexState.offset))}))}return s.next()}deleteFieldIndex(e,t){const n=Ei(e),r=Ti(e),s=bi(e);return n.delete(t.indexId).next((()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))).next((()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))))}deleteAllFieldIndexes(e){const t=Ei(e),n=bi(e),r=Ti(e);return t.H().next((()=>n.H())).next((()=>r.H()))}createTargetIndexes(e,t){return re.forEach(this.cn(t),(t=>this.getIndexType(e,t).next((n=>{if(0===n||1===n){const n=new ai(t).on();if(null!=n)return this.addFieldIndex(e,n)}}))))}getDocumentsMatchingTarget(e,t){const n=bi(e);let r=!0;const s=new Map;return re.forEach(this.cn(t),(t=>this.ln(e,t).next((e=>{r&&(r=!!e),s.set(t,e)})))).next((()=>{if(r){let e=jn();const r=[];return re.forEach(s,((s,i)=>{f("IndexedDbIndexManager",`Using index ${function(e){return`id=${e.indexId}|cg=${e.collectionGroup}|f=${e.fields.map((e=>`${e.fieldPath}:${e.kind}`)).join(",")}`}(s)} to execute ${fn(t)}`);const o=function(e,t){const n=K(t);if(void 0===n)return null;for(const r of pn(e,n.fieldPath))switch(r.op){case"array-contains-any":return r.value.arrayValue.values||[];case"array-contains":return[r.value]}return null}(i,s),a=function(e,t){const n=new Map;for(const r of $(t))for(const t of pn(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(i,s),c=function(e,t){const n=[];let r=!0;for(const s of $(t)){const t=0===s.kind?yn(e,s.fieldPath,e.startAt):wn(e,s.fieldPath,e.startAt);n.push(t.value),r&&(r=t.inclusive)}return new Ut(n,r)}(i,s),u=function(e,t){const n=[];let r=!0;for(const s of $(t)){const t=0===s.kind?wn(e,s.fieldPath,e.endAt):yn(e,s.fieldPath,e.endAt);n.push(t.value),r&&(r=t.inclusive)}return new Ut(n,r)}(i,s),l=this.hn(s,i,c),h=this.hn(s,i,u),d=this.Pn(s,i,a),m=this.In(s.indexId,o,l,c.inclusive,h,u.inclusive,d);return re.forEach(m,(s=>n.j(s,t.limit).next((t=>{t.forEach((t=>{const n=z.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),r.push(n))}))}))))})).next((()=>r))}return re.resolve(null)}))}cn(e){let t=this.un.get(e);return t||(t=0===e.filters.length?[e]:ui(jt.create(e.filters,"and")).map((t=>dn(e.path,e.collectionGroup,e.orderBy,t.getFilters(),e.limit,e.startAt,e.endAt))),this.un.set(e,t),t)}In(e,t,n,r,s,i,o){const a=(null!=t?t.length:1)*Math.max(n.length,s.length),c=a/(null!=t?t.length:1),u=[];for(let l=0;l<a;++l){const a=t?this.Tn(t[l/c]):vi,h=this.En(e,a,n[l%c],r),d=this.dn(e,a,s[l%c],i),f=o.map((t=>this.En(e,a,t,!0)));u.push(...this.createRange(h,d,f))}return u}En(e,t,n,r){const s=new si(e,z.empty(),t,n);return r?s:s.Jt()}dn(e,t,n,r){const s=new si(e,z.empty(),t,n);return r?s.Jt():s}ln(e,t){const n=new ai(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next((e=>{let t=null;for(const r of e)n.tn(r)&&(!t||r.fields.length>t.fields.length)&&(t=r);return t}))}getIndexType(e,t){let n=2;const r=this.cn(t);return re.forEach(r,(t=>this.ln(e,t).next((e=>{e?0!==n&&e.fields.length<function(e){let t=new et(B.comparator),n=!1;for(const r of e.filters)for(const e of r.getFlattenedFilters())e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field));for(const r of e.orderBy)r.field.isKeyField()||(t=t.add(r.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})))).next((()=>function(e){return null!==e.limit}(t)&&r.length>1&&2===n?1:n))}An(e,t){const n=new ri;for(const r of $(e)){const e=t.data.field(r.fieldPath);if(null==e)return null;const s=n.Ht(r.kind);Js.bt.Pt(e,s)}return n.Wt()}Tn(e){const t=new ri;return Js.bt.Pt(e,t.Ht(0)),t.Wt()}Rn(e,t){const n=new ri;return Js.bt.Pt(St(this.databaseId,t),n.Ht(function(e){const t=$(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.Wt()}Pn(e,t,n){if(null===n)return[];let r=[];r.push(new ri);let s=0;for(const i of $(e)){const e=n[s++];for(const n of r)if(this.Vn(t,i.fieldPath)&&Ct(e))r=this.mn(r,i,e);else{const t=n.Ht(i.kind);Js.bt.Pt(e,t)}}return this.fn(r)}hn(e,t,n){return this.Pn(e,t,n.position)}fn(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].Wt();return t}mn(e,t,n){const r=[...e],s=[];for(const i of n.arrayValue.values||[])for(const e of r){const n=new ri;n.seed(e.Wt()),Js.bt.Pt(i,n.Ht(t.kind)),s.push(n)}return s}Vn(e,t){return!!e.filters.find((e=>e instanceof Qt&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op)))}getFieldIndexes(e,t){const n=Ei(e),r=Ti(e);return(t?n.W("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.W()).next((e=>{const t=[];return re.forEach(e,(e=>r.get([e.indexId,this.uid]).next((n=>{t.push(function(e,t){const n=t?new Y(t.sequenceNumber,new X(Os(t.readTime),new z(be(t.documentKey)),t.largestBatchId)):Y.empty(),r=e.fields.map((([e,t])=>new j(B.fromServerFormat(e),t)));return new G(e.indexId,e.collectionGroup,r,n)}(e,n))})))).next((()=>t))}))}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next((e=>0===e.length?null:(e.sort(((e,t)=>{const n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:L(e.collectionGroup,t.collectionGroup)})),e[0].collectionGroup)))}updateCollectionGroup(e,t,n){const r=Ei(e),s=Ti(e);return this.gn(e).next((e=>r.W("collectionGroupIndex",IDBKeyRange.bound(t,t)).next((t=>re.forEach(t,(t=>s.put($s(t.indexId,this.uid,e,n))))))))}updateIndexEntries(e,t){const n=new Map;return re.forEach(t,((t,r)=>{const s=n.get(t.collectionGroup);return(s?re.resolve(s):this.getFieldIndexes(e,t.collectionGroup)).next((s=>(n.set(t.collectionGroup,s),re.forEach(s,(n=>this.pn(e,t,n).next((t=>{const s=this.yn(r,n);return t.isEqual(s)?re.resolve():this.wn(e,r,n,t,s)})))))))}))}Sn(e,t,n,r){return bi(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.Rn(n,t.key),documentKey:t.key.path.toArray()})}bn(e,t,n,r){return bi(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.Rn(n,t.key),t.key.path.toArray()])}pn(e,t,n){const r=bi(e);let s=new et(ii);return r.Y({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.Rn(n,t)])},((e,r)=>{s=s.add(new si(n.indexId,t,r.arrayValue,r.directionalValue))})).next((()=>s))}yn(e,t){let n=new et(ii);const r=this.An(t,e);if(null==r)return n;const s=K(t);if(null!=s){const i=e.data.field(s.fieldPath);if(Ct(i))for(const s of i.arrayValue.values||[])n=n.add(new si(t.indexId,e.key,this.Tn(s),r))}else n=n.add(new si(t.indexId,e.key,vi,r));return n}wn(e,t,n,r,s){f("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);const i=[];return function(e,t,n,r,s){const i=e.getIterator(),o=t.getIterator();let a=nt(i),c=nt(o);for(;a||c;){let e=!1,t=!1;if(a&&c){const r=n(a,c);r<0?t=!0:r>0&&(e=!0)}else null!=a?t=!0:e=!0;e?(r(c),c=nt(o)):t?(s(a),a=nt(i)):(a=nt(i),c=nt(o))}}(r,s,ii,(r=>{i.push(this.Sn(e,t,n,r))}),(r=>{i.push(this.bn(e,t,n,r))})),re.waitFor(i)}gn(e){let t=1;return Ti(e).Y({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((e,n,r)=>{r.done(),t=n.sequenceNumber+1})).next((()=>t))}createRange(e,t,n){n=n.sort(((e,t)=>ii(e,t))).filter(((e,t,n)=>!t||0!==ii(e,n[t-1])));const r=[];r.push(e);for(const i of n){const n=ii(i,e),s=ii(i,t);if(0===n)r[0]=e.Jt();else if(n>0&&s<0)r.push(i),r.push(i.Jt());else if(s>0)break}r.push(t);const s=[];for(let i=0;i<r.length;i+=2){if(this.Dn(r[i],r[i+1]))return[];const e=[r[i].indexId,this.uid,r[i].arrayValue,r[i].directionalValue,vi,[]],t=[r[i+1].indexId,this.uid,r[i+1].arrayValue,r[i+1].directionalValue,vi,[]];s.push(IDBKeyRange.bound(e,t))}return s}Dn(e,t){return ii(e,t)>0}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(Si)}getMinOffset(e,t){return re.mapArray(this.cn(t),(t=>this.ln(e,t).next((e=>e||y())))).next(Si)}}function _i(e){return je(e,"collectionParents")}function bi(e){return je(e,"indexEntries")}function Ei(e){return je(e,"indexConfiguration")}function Ti(e){return je(e,"indexState")}function Si(e){w(0!==e.length);let t=e[0].indexState.offset,n=t.largestBatchId;for(let r=1;r<e.length;r++){const s=e[r].indexState.offset;Z(s,t)<0&&(t=s),n<s.largestBatchId&&(n=s.largestBatchId)}return new X(t.readTime,t.documentKey,n)}const xi={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Ci{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new Ci(e,Ci.DEFAULT_COLLECTION_PERCENTILE,Ci.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function Di(e,t,n){const r=e.store("mutations"),s=e.store("documentMutations"),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const c=r.Y({range:o},((e,t,n)=>(a++,n.delete())));i.push(c.next((()=>{w(1===a)})));const u=[];for(const l of n.mutations){const e=Se(t,l.key.path,n.batchId);i.push(s.delete(e)),u.push(l.key)}return re.waitFor(i).next((()=>u))}function Ni(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw y();t=e.noDocument}return JSON.stringify(t).length}Ci.DEFAULT_COLLECTION_PERCENTILE=10,Ci.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Ci.DEFAULT=new Ci(41943040,Ci.DEFAULT_COLLECTION_PERCENTILE,Ci.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Ci.DISABLED=new Ci(-1,0,0);class Ai{constructor(e,t,n,r){this.userId=e,this.serializer=t,this.indexManager=n,this.referenceDelegate=r,this.Cn={}}static lt(e,t,n,r){w(""!==e.uid);const s=e.isAuthenticated()?e.uid:"";return new Ai(s,t,n,r)}checkEmpty(e){let t=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return Mi(e).Y({index:"userMutationsIndex",range:n},((e,n,r)=>{t=!1,r.done()})).next((()=>t))}addMutationBatch(e,t,n,r){const s=Li(e),i=Mi(e);return i.add({}).next((o=>{w("number"==typeof o);const a=new Dr(o,t,n,r),c=function(e,t,n){const r=n.baseMutations.map((t=>vs(e.ct,t))),s=n.mutations.map((t=>vs(e.ct,t)));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:s}}(this.serializer,this.userId,a),u=[];let l=new et(((e,t)=>L(e.canonicalString(),t.canonicalString())));for(const e of r){const t=Se(this.userId,e.key.path,o);l=l.add(e.key.path.popLast()),u.push(i.put(c)),u.push(s.put(t,xe))}return l.forEach((t=>{u.push(this.indexManager.addToCollectionParentIndex(e,t))})),e.addOnCommittedListener((()=>{this.Cn[o]=a.keys()})),re.waitFor(u).next((()=>a))}))}lookupMutationBatch(e,t){return Mi(e).get(t).next((e=>e?(w(e.userId===this.userId),qs(this.serializer,e)):null))}vn(e,t){return this.Cn[t]?re.resolve(this.Cn[t]):this.lookupMutationBatch(e,t).next((e=>{if(e){const n=e.keys();return this.Cn[t]=n,n}return null}))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]);let s=null;return Mi(e).Y({index:"userMutationsIndex",range:r},((e,t,r)=>{t.userId===this.userId&&(w(t.batchId>=n),s=qs(this.serializer,t)),r.done()})).next((()=>s))}getHighestUnacknowledgedBatchId(e){const t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return Mi(e).Y({index:"userMutationsIndex",range:t,reverse:!0},((e,t,r)=>{n=t.batchId,r.done()})).next((()=>n))}getAllMutationBatches(e){const t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return Mi(e).W("userMutationsIndex",t).next((e=>e.map((e=>qs(this.serializer,e)))))}getAllMutationBatchesAffectingDocumentKey(e,t){const n=Te(this.userId,t.path),r=IDBKeyRange.lowerBound(n),s=[];return Li(e).Y({range:r},((n,r,i)=>{const[o,a,c]=n,u=be(a);if(o===this.userId&&t.path.isEqual(u))return Mi(e).get(c).next((e=>{if(!e)throw y();w(e.userId===this.userId),s.push(qs(this.serializer,e))}));i.done()})).next((()=>s))}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new et(L);const r=[];return t.forEach((t=>{const s=Te(this.userId,t.path),i=IDBKeyRange.lowerBound(s),o=Li(e).Y({range:i},((e,r,s)=>{const[i,o,a]=e,c=be(o);i===this.userId&&t.path.isEqual(c)?n=n.add(a):s.done()}));r.push(o)})),re.waitFor(r).next((()=>this.Fn(e,n)))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1,s=Te(this.userId,n),i=IDBKeyRange.lowerBound(s);let o=new et(L);return Li(e).Y({range:i},((e,t,s)=>{const[i,a,c]=e,u=be(a);i===this.userId&&n.isPrefixOf(u)?u.length===r&&(o=o.add(c)):s.done()})).next((()=>this.Fn(e,o)))}Fn(e,t){const n=[],r=[];return t.forEach((t=>{r.push(Mi(e).get(t).next((e=>{if(null===e)throw y();w(e.userId===this.userId),n.push(qs(this.serializer,e))})))})),re.waitFor(r).next((()=>n))}removeMutationBatch(e,t){return Di(e.ae,this.userId,t).next((n=>(e.addOnCommittedListener((()=>{this.Mn(t.batchId)})),re.forEach(n,(t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))))}Mn(e){delete this.Cn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next((t=>{if(!t)return re.resolve();const n=IDBKeyRange.lowerBound(function(e){return[e]}(this.userId)),r=[];return Li(e).Y({range:n},((e,t,n)=>{if(e[0]===this.userId){const t=be(e[1]);r.push(t)}else n.done()})).next((()=>{w(0===r.length)}))}))}containsKey(e,t){return ki(e,this.userId,t)}xn(e){return Ri(e).get(this.userId).next((e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}))}}function ki(e,t,n){const r=Te(t,n.path),s=r[1],i=IDBKeyRange.lowerBound(r);let o=!1;return Li(e).Y({range:i,J:!0},((e,n,r)=>{const[i,a,c]=e;i===t&&a===s&&(o=!0),r.done()})).next((()=>o))}function Mi(e){return je(e,"mutations")}function Li(e){return je(e,"documentMutations")}function Ri(e){return je(e,"mutationQueues")}class Fi{constructor(e){this.On=e}next(){return this.On+=2,this.On}static Nn(){return new Fi(0)}static Bn(){return new Fi(-1)}}class Pi{constructor(e,t){this.referenceDelegate=e,this.serializer=t}allocateTargetId(e){return this.Ln(e).next((t=>{const n=new Fi(t.highestTargetId);return t.highestTargetId=n.next(),this.kn(e,t).next((()=>t.highestTargetId))}))}getLastRemoteSnapshotVersion(e){return this.Ln(e).next((e=>V.fromTimestamp(new P(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(e){return this.Ln(e).next((e=>e.highestListenSequenceNumber))}setTargetsMetadata(e,t,n){return this.Ln(e).next((r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.kn(e,r))))}addTargetData(e,t){return this.qn(e,t).next((()=>this.Ln(e).next((n=>(n.targetCount+=1,this.Qn(t,n),this.kn(e,n))))))}updateTargetData(e,t){return this.qn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next((()=>Vi(e).delete(t.targetId))).next((()=>this.Ln(e))).next((t=>(w(t.targetCount>0),t.targetCount-=1,this.kn(e,t))))}removeTargets(e,t,n){let r=0;const s=[];return Vi(e).Y(((i,o)=>{const a=Us(o);a.sequenceNumber<=t&&null===n.get(a.targetId)&&(r++,s.push(this.removeTargetData(e,a)))})).next((()=>re.waitFor(s))).next((()=>r))}forEachTarget(e,t){return Vi(e).Y(((e,n)=>{const r=Us(n);t(r)}))}Ln(e){return Oi(e).get("targetGlobalKey").next((e=>(w(null!==e),e)))}kn(e,t){return Oi(e).put("targetGlobalKey",t)}qn(e,t){return Vi(e).put(Bs(this.serializer,t))}Qn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.Ln(e).next((e=>e.targetCount))}getTargetData(e,t){const n=fn(t),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let s=null;return Vi(e).Y({range:r,index:"queryTargetsIndex"},((e,n,r)=>{const i=Us(n);mn(t,i.target)&&(s=i,r.done())})).next((()=>s))}addMatchingKeys(e,t,n){const r=[],s=qi(e);return t.forEach((t=>{const i=ve(t.path);r.push(s.put({targetId:n,path:i})),r.push(this.referenceDelegate.addReference(e,n,t))})),re.waitFor(r)}removeMatchingKeys(e,t,n){const r=qi(e);return re.forEach(t,(t=>{const s=ve(t.path);return re.waitFor([r.delete([n,s]),this.referenceDelegate.removeReference(e,n,t)])}))}removeMatchingKeysForTargetId(e,t){const n=qi(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=qi(e);let s=jn();return r.Y({range:n,J:!0},((e,t,n)=>{const r=be(e[1]),i=new z(r);s=s.add(i)})).next((()=>s))}containsKey(e,t){const n=ve(t.path),r=IDBKeyRange.bound([n],[F(n)],!1,!0);let s=0;return qi(e).Y({index:"documentTargetsIndex",J:!0,range:r},(([e,t],n,r)=>{0!==e&&(s++,r.done())})).next((()=>s>0))}_t(e,t){return Vi(e).get(t).next((e=>e?Us(e):null))}}function Vi(e){return je(e,"targets")}function Oi(e){return je(e,"targetGlobal")}function qi(e){return je(e,"targetDocuments")}function Ui([e,t],[n,r]){const s=L(e,n);return 0===s?L(t,r):s}class Bi{constructor(e){this.Kn=e,this.buffer=new et(Ui),this.$n=0}Un(){return++this.$n}Wn(e){const t=[e,this.Un()];if(this.buffer.size<this.Kn)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();Ui(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class zi{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Gn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.zn(6e4)}stop(){this.Gn&&(this.Gn.cancel(),this.Gn=null)}get started(){return null!==this.Gn}zn(e){f("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.Gn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,(async()=>{this.Gn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){ce(e)?f("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await ne(e)}await this.zn(3e5)}))}}class Gi{constructor(e,t){this.jn=e,this.params=t}calculateTargetCount(e,t){return this.jn.Hn(e).next((e=>Math.floor(t/100*e)))}nthSequenceNumber(e,t){if(0===t)return re.resolve(ge._e);const n=new Bi(t);return this.jn.forEachTarget(e,(e=>n.Wn(e.sequenceNumber))).next((()=>this.jn.Jn(e,(e=>n.Wn(e))))).next((()=>n.maxValue))}removeTargets(e,t,n){return this.jn.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.jn.removeOrphanedDocuments(e,t)}collect(e,t){return-1===this.params.cacheSizeCollectionThreshold?(f("LruGarbageCollector","Garbage collection skipped; disabled"),re.resolve(xi)):this.getCacheSize(e).next((n=>n<this.params.cacheSizeCollectionThreshold?(f("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),xi):this.Yn(e,t)))}getCacheSize(e){return this.jn.getCacheSize(e)}Yn(e,t){let n,r,s,o,a,c,u;const l=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next((t=>(t>this.params.maximumSequenceNumbersToCollect?(f("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),r=this.params.maximumSequenceNumbersToCollect):r=t,o=Date.now(),this.nthSequenceNumber(e,r)))).next((r=>(n=r,a=Date.now(),this.removeTargets(e,n,t)))).next((t=>(s=t,c=Date.now(),this.removeOrphanedDocuments(e,n)))).next((e=>(u=Date.now(),d()<=i.LogLevel.DEBUG&&f("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${o-l}ms\n\tDetermined least recently used ${r} in `+(a-o)+"ms\n"+`\tRemoved ${s} targets in `+(c-a)+"ms\n"+`\tRemoved ${e} documents in `+(u-c)+"ms\n"+`Total Duration: ${u-l}ms`),re.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:s,documentsRemoved:e}))))}}function Ki(e,t){return new Gi(e,t)}class $i{constructor(e,t){this.db=e,this.garbageCollector=Ki(this,t)}Hn(e){const t=this.Zn(e);return this.db.getTargetCache().getTargetCount(e).next((e=>t.next((t=>e+t))))}Zn(e){let t=0;return this.Jn(e,(e=>{t++})).next((()=>t))}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Jn(e,t){return this.Xn(e,((e,n)=>t(n)))}addReference(e,t,n){return Qi(e,n)}removeReference(e,t,n){return Qi(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return Qi(e,t)}er(e,t){return function(e,t){let n=!1;return Ri(e).Z((r=>ki(e,r,t).next((e=>(e&&(n=!0),re.resolve(!e)))))).next((()=>n))}(e,t)}removeOrphanedDocuments(e,t){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let s=0;return this.Xn(e,((i,o)=>{if(o<=t){const t=this.er(e,i).next((t=>{if(!t)return s++,n.getEntry(e,i).next((()=>(n.removeEntry(i,V.min()),qi(e).delete(function(e){return[0,ve(e.path)]}(i)))))}));r.push(t)}})).next((()=>re.waitFor(r))).next((()=>n.apply(e))).next((()=>s))}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return Qi(e,t)}Xn(e,t){const n=qi(e);let r,s=ge._e;return n.Y({index:"documentTargetsIndex"},(([e,n],{path:i,sequenceNumber:o})=>{0===e?(s!==ge._e&&t(new z(be(r)),s),s=o,r=i):s=ge._e})).next((()=>{s!==ge._e&&t(new z(be(r)),s)}))}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function Qi(e,t){return qi(e).put(function(e,t){return{targetId:0,path:ve(e.path),sequenceNumber:t}}(t,e.currentSequenceNumber))}class ji{constructor(){this.changes=new Pn((e=>e.toString()),((e,t)=>e.isEqual(t))),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,qt.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const n=this.changes.get(t);return void 0!==n?re.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class Wi{constructor(e){this.serializer=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return Xi(e).put(n)}removeEntry(e,t,n){return Xi(e).delete(function(e,t){const n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],Ps(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next((n=>(n.byteSize+=t,this.tr(e,n))))}getEntry(e,t){let n=qt.newInvalidDocument(t);return Xi(e).Y({index:"documentKeyIndex",range:IDBKeyRange.only(Zi(t))},((e,r)=>{n=this.nr(t,r)})).next((()=>n))}rr(e,t){let n={size:0,document:qt.newInvalidDocument(t)};return Xi(e).Y({index:"documentKeyIndex",range:IDBKeyRange.only(Zi(t))},((e,r)=>{n={document:this.nr(t,r),size:Ni(r)}})).next((()=>n))}getEntries(e,t){let n=On();return this.ir(e,t,((e,t)=>{const r=this.nr(e,t);n=n.insert(e,r)})).next((()=>n))}sr(e,t){let n=On(),r=new Je(z.comparator);return this.ir(e,t,((e,t)=>{const s=this.nr(e,t);n=n.insert(e,s),r=r.insert(e,Ni(t))})).next((()=>({documents:n,_r:r})))}ir(e,t,n){if(t.isEmpty())return re.resolve();let r=new et(to);t.forEach((e=>r=r.add(e)));const s=IDBKeyRange.bound(Zi(r.first()),Zi(r.last())),i=r.getIterator();let o=i.getNext();return Xi(e).Y({index:"documentKeyIndex",range:s},((e,t,r)=>{const s=z.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;o&&to(o,s)<0;)n(o,null),o=i.getNext();o&&o.isEqual(s)&&(n(o,t),o=i.hasNext()?i.getNext():null),o?r.U(Zi(o)):r.done()})).next((()=>{for(;o;)n(o,null),o=i.hasNext()?i.getNext():null}))}getDocumentsMatchingQuery(e,t,n,r,s){const i=t.path,o=[i.popLast().toArray(),i.lastSegment(),Ps(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],a=[i.popLast().toArray(),i.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Xi(e).W(IDBKeyRange.bound(o,a,!0)).next((e=>{null==s||s.incrementDocumentReadCount(e.length);let n=On();for(const s of e){const e=this.nr(z.fromSegments(s.prefixPath.concat(s.collectionGroup,s.documentId)),s);e.isFoundDocument()&&(Mn(t,e)||r.has(e.key))&&(n=n.insert(e.key,e))}return n}))}getAllFromCollectionGroup(e,t,n,r){let s=On();const i=eo(t,n),o=eo(t,X.max());return Xi(e).Y({index:"collectionGroupIndex",range:IDBKeyRange.bound(i,o,!0)},((e,t,n)=>{const i=this.nr(z.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);s=s.insert(i.key,i),s.size===r&&n.done()})).next((()=>s))}newChangeBuffer(e){return new Hi(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next((e=>e.byteSize))}getMetadata(e){return Ji(e).get("remoteDocumentGlobalKey").next((e=>(w(!!e),e)))}tr(e,t){return Ji(e).put("remoteDocumentGlobalKey",t)}nr(e,t){if(t){const e=function(e,t){let n;if(t.document)n=ws(e.ct,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=z.fromSegments(t.noDocument.path),r=Os(t.noDocument.readTime);n=qt.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return y();{const e=z.fromSegments(t.unknownDocument.path),r=Os(t.unknownDocument.version);n=qt.newUnknownDocument(e,r)}}return t.readTime&&n.setReadTime(function(e){const t=new P(e[0],e[1]);return V.fromTimestamp(t)}(t.readTime)),n}(this.serializer,t);if(!e.isNoDocument()||!e.version.isEqual(V.min()))return e}return qt.newInvalidDocument(e)}}function Yi(e){return new Wi(e)}class Hi extends ji{constructor(e,t){super(),this.ar=e,this.trackRemovals=t,this.ur=new Pn((e=>e.toString()),((e,t)=>e.isEqual(t)))}applyChanges(e){const t=[];let n=0,r=new et(((e,t)=>L(e.canonicalString(),t.canonicalString())));return this.changes.forEach(((s,i)=>{const o=this.ur.get(s);if(t.push(this.ar.removeEntry(e,s,o.readTime)),i.isValidDocument()){const a=Fs(this.ar.serializer,i);r=r.add(s.path.popLast());const c=Ni(a);n+=c-o.size,t.push(this.ar.addEntry(e,s,a))}else if(n-=o.size,this.trackRemovals){const n=Fs(this.ar.serializer,i.convertToNoDocument(V.min()));t.push(this.ar.addEntry(e,s,n))}})),r.forEach((n=>{t.push(this.ar.indexManager.addToCollectionParentIndex(e,n))})),t.push(this.ar.updateMetadata(e,n)),re.waitFor(t)}getFromCache(e,t){return this.ar.rr(e,t).next((e=>(this.ur.set(t,{size:e.size,readTime:e.document.readTime}),e.document)))}getAllFromCache(e,t){return this.ar.sr(e,t).next((({documents:e,_r:t})=>(t.forEach(((t,n)=>{this.ur.set(t,{size:n,readTime:e.get(t).readTime})})),e)))}}function Ji(e){return je(e,"remoteDocumentGlobal")}function Xi(e){return je(e,"remoteDocumentsV14")}function Zi(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function eo(e,t){const n=t.documentKey.path.toArray();return[e,Ps(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function to(e,t){const n=e.path.toArray(),r=t.path.toArray();let s=0;for(let i=0;i<n.length-2&&i<r.length-2;++i)if(s=L(n[i],r[i]),s)return s;return s=L(n.length,r.length),s||(s=L(n[n.length-2],r[r.length-2]),s||L(n[n.length-1],r[r.length-1]))}class no{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class ro{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next((r=>(n=r,this.remoteDocumentCache.getEntry(e,t)))).next((e=>(null!==n&&wr(n.mutation,e,rt.empty(),P.now()),e)))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.getLocalViewOfDocuments(e,t,jn()).next((()=>t))))}getLocalViewOfDocuments(e,t,n=jn()){const r=zn();return this.populateOverlays(e,r,t).next((()=>this.computeViews(e,t,r,n).next((e=>{let t=Un();return e.forEach(((e,n)=>{t=t.insert(e,n.overlayedDocument)})),t}))))}getOverlayedDocuments(e,t){const n=zn();return this.populateOverlays(e,n,t).next((()=>this.computeViews(e,t,n,jn())))}populateOverlays(e,t,n){const r=[];return n.forEach((e=>{t.has(e)||r.push(e)})),this.documentOverlayCache.getOverlays(e,r).next((e=>{e.forEach(((e,n)=>{t.set(e,n)}))}))}computeViews(e,t,n,r){let s=On();const i=Kn(),o=Kn();return t.forEach(((e,t)=>{const o=n.get(t.key);r.has(t.key)&&(void 0===o||o.mutation instanceof br)?s=s.insert(t.key,t):void 0!==o?(i.set(t.key,o.mutation.getFieldMask()),wr(o.mutation,t,o.mutation.getFieldMask(),P.now())):i.set(t.key,rt.empty())})),this.recalculateAndSaveOverlays(e,s).next((e=>(e.forEach(((e,t)=>i.set(e,t))),t.forEach(((e,t)=>{var n;return o.set(e,new no(t,null!==(n=i.get(e))&&void 0!==n?n:null))})),o)))}recalculateAndSaveOverlays(e,t){const n=Kn();let r=new Je(((e,t)=>e-t)),s=jn();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next((e=>{for(const s of e)s.keys().forEach((e=>{const i=t.get(e);if(null===i)return;let o=n.get(e)||rt.empty();o=s.applyToLocalView(i,o),n.set(e,o);const a=(r.get(s.batchId)||jn()).add(e);r=r.insert(s.batchId,a)}))})).next((()=>{const i=[],o=r.getReverseIterator();for(;o.hasNext();){const r=o.getNext(),a=r.key,c=r.value,u=Gn();c.forEach((e=>{if(!s.has(e)){const r=pr(t.get(e),n.get(e));null!==r&&u.set(e,r),s=s.add(e)}})),i.push(this.documentOverlayCache.saveOverlays(e,a,u))}return re.waitFor(i)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.recalculateAndSaveOverlays(e,t)))}getDocumentsMatchingQuery(e,t,n,r){return function(e){return z.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):En(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n,r):this.getDocumentsMatchingCollectionQuery(e,t,n,r)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next((s=>{const i=r-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-s.size):re.resolve(zn());let o=-1,a=s;return i.next((t=>re.forEach(t,((t,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),s.get(t)?re.resolve():this.remoteDocumentCache.getEntry(e,t).next((e=>{a=a.insert(t,e)}))))).next((()=>this.populateOverlays(e,t,s))).next((()=>this.computeViews(e,a,t,jn()))).next((e=>({batchId:o,changes:Bn(e)})))))}))}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new z(t)).next((e=>{let t=Un();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t}))}getDocumentsMatchingCollectionGroupQuery(e,t,n,r){const s=t.collectionGroup;let i=Un();return this.indexManager.getCollectionParents(e,s).next((o=>re.forEach(o,(o=>{const a=function(e,t){return new vn(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(t,o.child(s));return this.getDocumentsMatchingCollectionQuery(e,a,n,r).next((e=>{e.forEach(((e,t)=>{i=i.insert(e,t)}))}))})).next((()=>i))))}getDocumentsMatchingCollectionQuery(e,t,n,r){let s;return this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId).next((i=>(s=i,this.remoteDocumentCache.getDocumentsMatchingQuery(e,t,n,s,r)))).next((e=>{s.forEach(((t,n)=>{const r=n.getKey();null===e.get(r)&&(e=e.insert(r,qt.newInvalidDocument(r)))}));let n=Un();return e.forEach(((e,r)=>{const i=s.get(e);void 0!==i&&wr(i.mutation,r,rt.empty(),P.now()),Mn(t,r)&&(n=n.insert(e,r))})),n}))}}class so{constructor(e){this.serializer=e,this.cr=new Map,this.lr=new Map}getBundleMetadata(e,t){return re.resolve(this.cr.get(t))}saveBundleMetadata(e,t){return this.cr.set(t.id,function(e){return{id:e.id,version:e.version,createTime:as(e.createTime)}}(t)),re.resolve()}getNamedQuery(e,t){return re.resolve(this.lr.get(t))}saveNamedQuery(e,t){return this.lr.set(t.name,function(e){return{name:e.name,query:zs(e.bundledQuery),readTime:as(e.readTime)}}(t)),re.resolve()}}class io{constructor(){this.overlays=new Je(z.comparator),this.hr=new Map}getOverlay(e,t){return re.resolve(this.overlays.get(t))}getOverlays(e,t){const n=zn();return re.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){return n.forEach(((n,r)=>{this.ht(e,t,r)})),re.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.hr.get(n);return void 0!==r&&(r.forEach((e=>this.overlays=this.overlays.remove(e))),this.hr.delete(n)),re.resolve()}getOverlaysForCollection(e,t,n){const r=zn(),s=t.length+1,i=new z(t.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const e=o.getNext().value,i=e.getKey();if(!t.isPrefixOf(i.path))break;i.path.length===s&&e.largestBatchId>n&&r.set(e.getKey(),e)}return re.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let s=new Je(((e,t)=>e-t));const i=this.overlays.getIterator();for(;i.hasNext();){const e=i.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=s.get(e.largestBatchId);null===t&&(t=zn(),s=s.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}const o=zn(),a=s.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((e,t)=>o.set(e,t))),!(o.size()>=r)););return re.resolve(o)}ht(e,t,n){const r=this.overlays.get(n.key);if(null!==r){const e=this.hr.get(r.largestBatchId).delete(n.key);this.hr.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new Ar(t,n));let s=this.hr.get(t);void 0===s&&(s=jn(),this.hr.set(t,s)),this.hr.set(t,s.add(n.key))}}class oo{constructor(){this.Pr=new et(ao.Ir),this.Tr=new et(ao.Er)}isEmpty(){return this.Pr.isEmpty()}addReference(e,t){const n=new ao(e,t);this.Pr=this.Pr.add(n),this.Tr=this.Tr.add(n)}dr(e,t){e.forEach((e=>this.addReference(e,t)))}removeReference(e,t){this.Ar(new ao(e,t))}Rr(e,t){e.forEach((e=>this.removeReference(e,t)))}Vr(e){const t=new z(new q([])),n=new ao(t,e),r=new ao(t,e+1),s=[];return this.Tr.forEachInRange([n,r],(e=>{this.Ar(e),s.push(e.key)})),s}mr(){this.Pr.forEach((e=>this.Ar(e)))}Ar(e){this.Pr=this.Pr.delete(e),this.Tr=this.Tr.delete(e)}gr(e){const t=new z(new q([])),n=new ao(t,e),r=new ao(t,e+1);let s=jn();return this.Tr.forEachInRange([n,r],(e=>{s=s.add(e.key)})),s}containsKey(e){const t=new ao(e,0),n=this.Pr.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class ao{constructor(e,t){this.key=e,this.pr=t}static Ir(e,t){return z.comparator(e.key,t.key)||L(e.pr,t.pr)}static Er(e,t){return L(e.pr,t.pr)||z.comparator(e.key,t.key)}}class co{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.yr=1,this.wr=new et(ao.Ir)}checkEmpty(e){return re.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){const s=this.yr;this.yr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const i=new Dr(s,t,n,r);this.mutationQueue.push(i);for(const o of r)this.wr=this.wr.add(new ao(o.key,s)),this.indexManager.addToCollectionParentIndex(e,o.key.path.popLast());return re.resolve(i)}lookupMutationBatch(e,t){return re.resolve(this.Sr(t))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=this.br(n),s=r<0?0:r;return re.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return re.resolve(0===this.mutationQueue.length?-1:this.yr-1)}getAllMutationBatches(e){return re.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new ao(t,0),r=new ao(t,Number.POSITIVE_INFINITY),s=[];return this.wr.forEachInRange([n,r],(e=>{const t=this.Sr(e.pr);s.push(t)})),re.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new et(L);return t.forEach((e=>{const t=new ao(e,0),r=new ao(e,Number.POSITIVE_INFINITY);this.wr.forEachInRange([t,r],(e=>{n=n.add(e.pr)}))})),re.resolve(this.Dr(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let s=n;z.isDocumentKey(s)||(s=s.child(""));const i=new ao(new z(s),0);let o=new et(L);return this.wr.forEachWhile((e=>{const t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(o=o.add(e.pr)),!0)}),i),re.resolve(this.Dr(o))}Dr(e){const t=[];return e.forEach((e=>{const n=this.Sr(e);null!==n&&t.push(n)})),t}removeMutationBatch(e,t){w(0===this.Cr(t.batchId,"removed")),this.mutationQueue.shift();let n=this.wr;return re.forEach(t.mutations,(r=>{const s=new ao(r.key,t.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)})).next((()=>{this.wr=n}))}Mn(e){}containsKey(e,t){const n=new ao(t,0),r=this.wr.firstAfterOrEqual(n);return re.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,re.resolve()}Cr(e,t){return this.br(e)}br(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}Sr(e){const t=this.br(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class uo{constructor(e){this.vr=e,this.docs=new Je(z.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),s=r?r.size:0,i=this.vr(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return re.resolve(n?n.document.mutableCopy():qt.newInvalidDocument(t))}getEntries(e,t){let n=On();return t.forEach((e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():qt.newInvalidDocument(e))})),re.resolve(n)}getDocumentsMatchingQuery(e,t,n,r){let s=On();const i=t.path,o=new z(i.child("")),a=this.docs.getIteratorFrom(o);for(;a.hasNext();){const{key:e,value:{document:o}}=a.getNext();if(!i.isPrefixOf(e.path))break;e.path.length>i.length+1||Z(J(o),n)<=0||(r.has(o.key)||Mn(t,o))&&(s=s.insert(o.key,o.mutableCopy()))}return re.resolve(s)}getAllFromCollectionGroup(e,t,n,r){y()}Fr(e,t){return re.forEach(this.docs,(e=>t(e)))}newChangeBuffer(e){return new lo(this)}getSize(e){return re.resolve(this.size)}}class lo extends ji{constructor(e){super(),this.ar=e}applyChanges(e){const t=[];return this.changes.forEach(((n,r)=>{r.isValidDocument()?t.push(this.ar.addEntry(e,r)):this.ar.removeEntry(n)})),re.waitFor(t)}getFromCache(e,t){return this.ar.getEntry(e,t)}getAllFromCache(e,t){return this.ar.getEntries(e,t)}}class ho{constructor(e){this.persistence=e,this.Mr=new Pn((e=>fn(e)),mn),this.lastRemoteSnapshotVersion=V.min(),this.highestTargetId=0,this.Or=0,this.Nr=new oo,this.targetCount=0,this.Br=Fi.Nn()}forEachTarget(e,t){return this.Mr.forEach(((e,n)=>t(n))),re.resolve()}getLastRemoteSnapshotVersion(e){return re.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return re.resolve(this.Or)}allocateTargetId(e){return this.highestTargetId=this.Br.next(),re.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Or&&(this.Or=t),re.resolve()}qn(e){this.Mr.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.Br=new Fi(t),this.highestTargetId=t),e.sequenceNumber>this.Or&&(this.Or=e.sequenceNumber)}addTargetData(e,t){return this.qn(t),this.targetCount+=1,re.resolve()}updateTargetData(e,t){return this.qn(t),re.resolve()}removeTargetData(e,t){return this.Mr.delete(t.target),this.Nr.Vr(t.targetId),this.targetCount-=1,re.resolve()}removeTargets(e,t,n){let r=0;const s=[];return this.Mr.forEach(((i,o)=>{o.sequenceNumber<=t&&null===n.get(o.targetId)&&(this.Mr.delete(i),s.push(this.removeMatchingKeysForTargetId(e,o.targetId)),r++)})),re.waitFor(s).next((()=>r))}getTargetCount(e){return re.resolve(this.targetCount)}getTargetData(e,t){const n=this.Mr.get(t)||null;return re.resolve(n)}addMatchingKeys(e,t,n){return this.Nr.dr(t,n),re.resolve()}removeMatchingKeys(e,t,n){this.Nr.Rr(t,n);const r=this.persistence.referenceDelegate,s=[];return r&&t.forEach((t=>{s.push(r.markPotentiallyOrphaned(e,t))})),re.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.Nr.Vr(t),re.resolve()}getMatchingKeysForTargetId(e,t){const n=this.Nr.gr(t);return re.resolve(n)}containsKey(e,t){return re.resolve(this.Nr.containsKey(t))}}class fo{constructor(e,t){this.Lr={},this.overlays={},this.kr=new ge(0),this.qr=!1,this.qr=!0,this.referenceDelegate=e(this),this.Qr=new ho(this),this.indexManager=new yi,this.remoteDocumentCache=function(e){return new uo(e)}((e=>this.referenceDelegate.Kr(e))),this.serializer=new Rs(t),this.$r=new so(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.qr=!1,Promise.resolve()}get started(){return this.qr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new io,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.Lr[e.toKey()];return n||(n=new co(t,this.referenceDelegate),this.Lr[e.toKey()]=n),n}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.$r}runTransaction(e,t,n){f("MemoryPersistence","Starting transaction:",e);const r=new mo(this.kr.next());return this.referenceDelegate.Ur(),n(r).next((e=>this.referenceDelegate.Wr(r).next((()=>e)))).toPromise().then((e=>(r.raiseOnCommittedEvent(),e)))}Gr(e,t){return re.or(Object.values(this.Lr).map((n=>()=>n.containsKey(e,t))))}}class mo extends te{constructor(e){super(),this.currentSequenceNumber=e}}class go{constructor(e){this.persistence=e,this.zr=new oo,this.jr=null}static Hr(e){return new go(e)}get Jr(){if(this.jr)return this.jr;throw y()}addReference(e,t,n){return this.zr.addReference(n,t),this.Jr.delete(n.toString()),re.resolve()}removeReference(e,t,n){return this.zr.removeReference(n,t),this.Jr.add(n.toString()),re.resolve()}markPotentiallyOrphaned(e,t){return this.Jr.add(t.toString()),re.resolve()}removeTarget(e,t){this.zr.Vr(t.targetId).forEach((e=>this.Jr.add(e.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next((e=>{e.forEach((e=>this.Jr.add(e.toString())))})).next((()=>n.removeTargetData(e,t)))}Ur(){this.jr=new Set}Wr(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return re.forEach(this.Jr,(n=>{const r=z.fromPath(n);return this.Yr(e,r).next((e=>{e||t.removeEntry(r,V.min())}))})).next((()=>(this.jr=null,t.apply(e))))}updateLimboDocument(e,t){return this.Yr(e,t).next((e=>{e?this.Jr.delete(t.toString()):this.Jr.add(t.toString())}))}Kr(e){return 0}Yr(e,t){return re.or([()=>re.resolve(this.zr.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Gr(e,t)])}}class po{constructor(e,t){this.persistence=e,this.Zr=new Pn((e=>ve(e.path)),((e,t)=>e.isEqual(t))),this.garbageCollector=Ki(this,t)}static Hr(e,t){return new po(e,t)}Ur(){}Wr(e){return re.resolve()}forEachTarget(e,t){return this.persistence.getTargetCache().forEachTarget(e,t)}Hn(e){const t=this.Zn(e);return this.persistence.getTargetCache().getTargetCount(e).next((e=>t.next((t=>e+t))))}Zn(e){let t=0;return this.Jn(e,(e=>{t++})).next((()=>t))}Jn(e,t){return re.forEach(this.Zr,((n,r)=>this.er(e,n,r).next((e=>e?re.resolve():t(r)))))}removeTargets(e,t,n){return this.persistence.getTargetCache().removeTargets(e,t,n)}removeOrphanedDocuments(e,t){let n=0;const r=this.persistence.getRemoteDocumentCache(),s=r.newChangeBuffer();return r.Fr(e,(r=>this.er(e,r,t).next((e=>{e||(n++,s.removeEntry(r,V.min()))})))).next((()=>s.apply(e))).next((()=>n))}markPotentiallyOrphaned(e,t){return this.Zr.set(t,e.currentSequenceNumber),re.resolve()}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.persistence.getTargetCache().updateTargetData(e,n)}addReference(e,t,n){return this.Zr.set(n,e.currentSequenceNumber),re.resolve()}removeReference(e,t,n){return this.Zr.set(n,e.currentSequenceNumber),re.resolve()}updateLimboDocument(e,t){return this.Zr.set(t,e.currentSequenceNumber),re.resolve()}Kr(e){let t=e.key.toString().length;return e.isFoundDocument()&&(t+=Tt(e.data.value)),t}er(e,t,n){return re.or([()=>this.persistence.Gr(e,t),()=>this.persistence.getTargetCache().containsKey(e,t),()=>{const e=this.Zr.get(t);return re.resolve(void 0!==e&&e>n)}])}getCacheSize(e){return this.persistence.getRemoteDocumentCache().getSize(e)}}class yo{constructor(e){this.serializer=e}N(e,t,n,r){const s=new se("createOrUpgrade",t);n<1&&r>=1&&(function(e){e.createObjectStore("owner")}(e),function(e){e.createObjectStore("mutationQueues",{keyPath:"userId"}),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Ee,{unique:!0}),e.createObjectStore("documentMutations")}(e),wo(e),function(e){e.createObjectStore("remoteDocuments")}(e));let i=re.resolve();return n<3&&r>=3&&(0!==n&&(function(e){e.deleteObjectStore("targetDocuments"),e.deleteObjectStore("targets"),e.deleteObjectStore("targetGlobal")}(e),wo(e)),i=i.next((()=>function(e){const t=e.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:V.min().toTimestamp(),targetCount:0};return t.put("targetGlobalKey",n)}(s)))),n<4&&r>=4&&(0!==n&&(i=i.next((()=>function(e,t){return t.store("mutations").W().next((n=>{e.deleteObjectStore("mutations"),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Ee,{unique:!0});const r=t.store("mutations"),s=n.map((e=>r.put(e)));return re.waitFor(s)}))}(e,s)))),i=i.next((()=>{!function(e){e.createObjectStore("clientMetadata",{keyPath:"clientId"})}(e)}))),n<5&&r>=5&&(i=i.next((()=>this.Xr(s)))),n<6&&r>=6&&(i=i.next((()=>(function(e){e.createObjectStore("remoteDocumentGlobal")}(e),this.ei(s))))),n<7&&r>=7&&(i=i.next((()=>this.ti(s)))),n<8&&r>=8&&(i=i.next((()=>this.ni(e,s)))),n<9&&r>=9&&(i=i.next((()=>{!function(e){e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")}(e)}))),n<10&&r>=10&&(i=i.next((()=>this.ri(s)))),n<11&&r>=11&&(i=i.next((()=>{!function(e){e.createObjectStore("bundles",{keyPath:"bundleId"})}(e),function(e){e.createObjectStore("namedQueries",{keyPath:"name"})}(e)}))),n<12&&r>=12&&(i=i.next((()=>{!function(e){const t=e.createObjectStore("documentOverlays",{keyPath:Oe});t.createIndex("collectionPathOverlayIndex",qe,{unique:!1}),t.createIndex("collectionGroupOverlayIndex",Ue,{unique:!1})}(e)}))),n<13&&r>=13&&(i=i.next((()=>function(e){const t=e.createObjectStore("remoteDocumentsV14",{keyPath:Ce});t.createIndex("documentKeyIndex",De),t.createIndex("collectionGroupIndex",Ne)}(e))).next((()=>this.ii(e,s))).next((()=>e.deleteObjectStore("remoteDocuments")))),n<14&&r>=14&&(i=i.next((()=>this.si(e,s)))),n<15&&r>=15&&(i=i.next((()=>function(e){e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:Re}).createIndex("sequenceNumberIndex",Fe,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:Pe}).createIndex("documentKeyIndex",Ve,{unique:!1})}(e)))),i}ei(e){let t=0;return e.store("remoteDocuments").Y(((e,n)=>{t+=Ni(n)})).next((()=>{const n={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}Xr(e){const t=e.store("mutationQueues"),n=e.store("mutations");return t.W().next((t=>re.forEach(t,(t=>{const r=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.W("userMutationsIndex",r).next((n=>re.forEach(n,(n=>{w(n.userId===t.userId);const r=qs(this.serializer,n);return Di(e,t.userId,r).next((()=>{}))}))))}))))}ti(e){const t=e.store("targetDocuments"),n=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next((e=>{const r=[];return n.Y(((n,s)=>{const i=new q(n),o=function(e){return[0,ve(e)]}(i);r.push(t.get(o).next((n=>n?re.resolve():(n=>t.put({targetId:0,path:ve(n),sequenceNumber:e.highestListenSequenceNumber}))(i))))})).next((()=>re.waitFor(r)))}))}ni(e,t){e.createObjectStore("collectionParents",{keyPath:Le});const n=t.store("collectionParents"),r=new wi,s=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:ve(r)})}};return t.store("remoteDocuments").Y({J:!0},((e,t)=>{const n=new q(e);return s(n.popLast())})).next((()=>t.store("documentMutations").Y({J:!0},(([e,t,n],r)=>{const i=be(t);return s(i.popLast())}))))}ri(e){const t=e.store("targets");return t.Y(((e,n)=>{const r=Us(n),s=Bs(this.serializer,r);return t.put(s)}))}ii(e,t){const n=t.store("remoteDocuments"),r=[];return n.Y(((e,n)=>{const s=t.store("remoteDocumentsV14"),i=function(e){return e.document?new z(q.fromString(e.document.name).popFirst(5)):e.noDocument?z.fromSegments(e.noDocument.path):e.unknownDocument?z.fromSegments(e.unknownDocument.path):y()}(n).path.toArray(),o={prefixPath:i.slice(0,i.length-2),collectionGroup:i[i.length-2],documentId:i[i.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(s.put(o))})).next((()=>re.waitFor(r)))}si(e,t){const n=t.store("mutations"),r=Yi(this.serializer),s=new fo(go.Hr,this.serializer.ct);return n.W().next((e=>{const n=new Map;return e.forEach((e=>{var t;let r=null!==(t=n.get(e.userId))&&void 0!==t?t:jn();qs(this.serializer,e).keys().forEach((e=>r=r.add(e))),n.set(e.userId,r)})),re.forEach(n,((e,n)=>{const i=new u(n),o=Ys.lt(this.serializer,i),a=s.getIndexManager(i),c=Ai.lt(i,this.serializer,a,s.referenceDelegate);return new ro(r,c,o,a).recalculateAndSaveOverlaysForDocumentKeys(new Qe(t,ge._e),e).next()}))}))}}function wo(e){e.createObjectStore("targetDocuments",{keyPath:ke}).createIndex("documentTargetsIndex",Me,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",Ae,{unique:!0}),e.createObjectStore("targetGlobal")}const vo="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class Io{constructor(e,t,n,r,s,i,o,a,c,u,l=15){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.oi=s,this.window=i,this.document=o,this._i=c,this.ai=u,this.ui=l,this.kr=null,this.qr=!1,this.isPrimary=!1,this.networkEnabled=!0,this.ci=null,this.inForeground=!1,this.li=null,this.hi=null,this.Pi=Number.NEGATIVE_INFINITY,this.Ii=e=>Promise.resolve(),!Io.D())throw new _(I.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new $i(this,r),this.Ti=t+"main",this.serializer=new Rs(a),this.Ei=new ie(this.Ti,this.ui,new yo(this.serializer)),this.Qr=new Pi(this.referenceDelegate,this.serializer),this.remoteDocumentCache=Yi(this.serializer),this.$r=new Qs,this.window&&this.window.localStorage?this.di=this.window.localStorage:(this.di=null,!1===u&&m("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.Ai().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new _(I.FAILED_PRECONDITION,vo);return this.Ri(),this.Vi(),this.mi(),this.runTransaction("getHighestListenSequenceNumber","readonly",(e=>this.Qr.getHighestSequenceNumber(e)))})).then((e=>{this.kr=new ge(e,this._i)})).then((()=>{this.qr=!0})).catch((e=>(this.Ei&&this.Ei.close(),Promise.reject(e))))}fi(e){return this.Ii=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.Ei.L((async t=>{null===t.newVersion&&await e()}))}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.oi.enqueueAndForget((async()=>{this.started&&await this.Ai()})))}Ai(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(e=>bo(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.gi(e).next((e=>{e||(this.isPrimary=!1,this.oi.enqueueRetryable((()=>this.Ii(!1))))}))})).next((()=>this.pi(e))).next((t=>this.isPrimary&&!t?this.yi(e).next((()=>!1)):!!t&&this.wi(e).next((()=>!0)))))).catch((e=>{if(ce(e))return f("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return f("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1})).then((e=>{this.isPrimary!==e&&this.oi.enqueueRetryable((()=>this.Ii(e))),this.isPrimary=e}))}gi(e){return _o(e).get("owner").next((e=>re.resolve(this.Si(e))))}bi(e){return bo(e).delete(this.clientId)}async Di(){if(this.isPrimary&&!this.Ci(this.Pi,18e5)){this.Pi=Date.now();const e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(e=>{const t=je(e,"clientMetadata");return t.W().next((e=>{const n=this.vi(e,18e5),r=e.filter((e=>-1===n.indexOf(e)));return re.forEach(r,(e=>t.delete(e.clientId))).next((()=>r))}))})).catch((()=>[]));if(this.di)for(const t of e)this.di.removeItem(this.Fi(t.clientId))}}mi(){this.hi=this.oi.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.Ai().then((()=>this.Di())).then((()=>this.mi()))))}Si(e){return!!e&&e.ownerId===this.clientId}pi(e){return this.ai?re.resolve(!0):_o(e).get("owner").next((t=>{if(null!==t&&this.Ci(t.leaseTimestampMs,5e3)&&!this.Mi(t.ownerId)){if(this.Si(t)&&this.networkEnabled)return!0;if(!this.Si(t)){if(!t.allowTabSynchronization)throw new _(I.FAILED_PRECONDITION,vo);return!1}}return!(!this.networkEnabled||!this.inForeground)||bo(e).W().next((e=>void 0===this.vi(e,5e3).find((e=>{if(this.clientId!==e.clientId){const t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))))})).next((e=>(this.isPrimary!==e&&f("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e)))}async shutdown(){this.qr=!1,this.xi(),this.hi&&(this.hi.cancel(),this.hi=null),this.Oi(),this.Ni(),await this.Ei.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(e=>{const t=new Qe(e,ge._e);return this.yi(t).next((()=>this.bi(t)))})),this.Ei.close(),this.Bi()}vi(e,t){return e.filter((e=>this.Ci(e.updateTimeMs,t)&&!this.Mi(e.clientId)))}Li(){return this.runTransaction("getActiveClients","readonly",(e=>bo(e).W().next((e=>this.vi(e,18e5).map((e=>e.clientId))))))}get started(){return this.qr}getMutationQueue(e,t){return Ai.lt(e,this.serializer,t,this.referenceDelegate)}getTargetCache(){return this.Qr}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new Ii(e,this.serializer.ct.databaseId)}getDocumentOverlayCache(e){return Ys.lt(this.serializer,e)}getBundleCache(){return this.$r}runTransaction(e,t,n){f("IndexedDbPersistence","Starting transaction:",e);const r="readonly"===t?"readonly":"readwrite",s=function(e){return 15===e?$e:14===e?Ke:13===e?Ge:12===e?ze:11===e?Be:void y()}(this.ui);let i;return this.Ei.runTransaction(e,r,s,(r=>(i=new Qe(r,this.kr?this.kr.next():ge._e),"readwrite-primary"===t?this.gi(i).next((e=>!!e||this.pi(i))).next((t=>{if(!t)throw m(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.oi.enqueueRetryable((()=>this.Ii(!1))),new _(I.FAILED_PRECONDITION,ee);return n(i)})).next((e=>this.wi(i).next((()=>e)))):this.ki(i).next((()=>n(i)))))).then((e=>(i.raiseOnCommittedEvent(),e)))}ki(e){return _o(e).get("owner").next((e=>{if(null!==e&&this.Ci(e.leaseTimestampMs,5e3)&&!this.Mi(e.ownerId)&&!this.Si(e)&&!(this.ai||this.allowTabSynchronization&&e.allowTabSynchronization))throw new _(I.FAILED_PRECONDITION,vo)}))}wi(e){const t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return _o(e).put("owner",t)}static D(){return ie.D()}yi(e){const t=_o(e);return t.get("owner").next((e=>this.Si(e)?(f("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):re.resolve()))}Ci(e,t){const n=Date.now();return!(e<n-t||e>n&&(m(`Detected an update time that is in the future: ${e} > ${n}`),1))}Ri(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.li=()=>{this.oi.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.Ai())))},this.document.addEventListener("visibilitychange",this.li),this.inForeground="visible"===this.document.visibilityState)}Oi(){this.li&&(this.document.removeEventListener("visibilitychange",this.li),this.li=null)}Vi(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.ci=()=>{this.xi();const e=/(?:Version|Mobile)\/1[456]/;o.isSafari()&&(navigator.appVersion.match(e)||navigator.userAgent.match(e))&&this.oi.enterRestrictedMode(!0),this.oi.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.ci))}Ni(){this.ci&&(this.window.removeEventListener("pagehide",this.ci),this.ci=null)}Mi(e){var t;try{const n=null!==(null===(t=this.di)||void 0===t?void 0:t.getItem(this.Fi(e)));return f("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return m("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}xi(){if(this.di)try{this.di.setItem(this.Fi(this.clientId),String(Date.now()))}catch(e){m("Failed to set zombie client id.",e)}}Bi(){if(this.di)try{this.di.removeItem(this.Fi(this.clientId))}catch(e){}}Fi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function _o(e){return je(e,"owner")}function bo(e){return je(e,"clientMetadata")}function Eo(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class To{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.qi=n,this.Qi=r}static Ki(e,t){let n=jn(),r=jn();for(const s of t.docChanges)switch(s.type){case 0:n=n.add(s.doc.key);break;case 1:r=r.add(s.doc.key)}return new To(e,t.fromCache,n,r)}}class So{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(e){this._documentReadCount+=e}}class xo{constructor(){this.$i=!1,this.Ui=!1,this.Wi=100,this.Gi=o.isSafari()?8:ie.v(o.getUA())>0?6:4}initialize(e,t){this.zi=e,this.indexManager=t,this.$i=!0}getDocumentsMatchingQuery(e,t,n,r){const s={result:null};return this.ji(e,t).next((e=>{s.result=e})).next((()=>{if(!s.result)return this.Hi(e,t,r,n).next((e=>{s.result=e}))})).next((()=>{if(s.result)return;const n=new So;return this.Ji(e,t,n).next((r=>{if(s.result=r,this.Ui)return this.Yi(e,t,n,r.size)}))})).next((()=>s.result))}Yi(e,t,n,r){return n.documentReadCount<this.Wi?(d()<=i.LogLevel.DEBUG&&f("QueryEngine","SDK will not create cache indexes for query:",kn(t),"since it only creates cache indexes for collection contains","more than or equal to",this.Wi,"documents"),re.resolve()):(d()<=i.LogLevel.DEBUG&&f("QueryEngine","Query:",kn(t),"scans",n.documentReadCount,"local documents and returns",r,"documents as results."),n.documentReadCount>this.Gi*r?(d()<=i.LogLevel.DEBUG&&f("QueryEngine","The SDK decides to create cache indexes for query:",kn(t),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(e,Sn(t))):re.resolve())}ji(e,t){if(bn(t))return re.resolve(null);let n=Sn(t);return this.indexManager.getIndexType(e,n).next((r=>0===r?null:(null!==t.limit&&1===r&&(t=Dn(t,null,"F"),n=Sn(t)),this.indexManager.getDocumentsMatchingTarget(e,n).next((r=>{const s=jn(...r);return this.zi.getDocuments(e,s).next((r=>this.indexManager.getMinOffset(e,n).next((n=>{const i=this.Zi(t,r);return this.Xi(t,i,s,n.readTime)?this.ji(e,Dn(t,null,"F")):this.es(e,i,t,n)}))))})))))}Hi(e,t,n,r){return bn(t)||r.isEqual(V.min())?re.resolve(null):this.zi.getDocuments(e,n).next((s=>{const o=this.Zi(t,s);return this.Xi(t,o,n,r)?re.resolve(null):(d()<=i.LogLevel.DEBUG&&f("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),kn(t)),this.es(e,o,t,H(r,-1)).next((e=>e)))}))}Zi(e,t){let n=new et(Rn(e));return t.forEach(((t,r)=>{Mn(e,r)&&(n=n.add(r))})),n}Xi(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const s="F"===e.limitType?t.last():t.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(r)>0)}Ji(e,t,n){return d()<=i.LogLevel.DEBUG&&f("QueryEngine","Using full collection scan to execute query:",kn(t)),this.zi.getDocumentsMatchingQuery(e,t,X.min(),n)}es(e,t,n,r){return this.zi.getDocumentsMatchingQuery(e,n,r).next((e=>(t.forEach((t=>{e=e.insert(t.key,t)})),e)))}}class Co{constructor(e,t,n,r){this.persistence=e,this.ts=t,this.serializer=r,this.ns=new Je(L),this.rs=new Pn((e=>fn(e)),mn),this.ss=new Map,this.os=e.getRemoteDocumentCache(),this.Qr=e.getTargetCache(),this.$r=e.getBundleCache(),this._s(n)}_s(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new ro(this.os,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.os.setIndexManager(this.indexManager),this.ts.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(t=>e.collect(t,this.ns)))}}function Do(e,t,n,r){return new Co(e,t,n,r)}async function No(e,t){const n=v(e);return await n.persistence.runTransaction("Handle user change","readonly",(e=>{let r;return n.mutationQueue.getAllMutationBatches(e).next((s=>(r=s,n._s(t),n.mutationQueue.getAllMutationBatches(e)))).next((t=>{const s=[],i=[];let o=jn();for(const e of r){s.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}for(const e of t){i.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}return n.localDocuments.getDocuments(e,o).next((e=>({us:e,removedBatchIds:s,addedBatchIds:i})))}))}))}function Ao(e){const t=v(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",(e=>t.Qr.getLastRemoteSnapshotVersion(e)))}function ko(e,t,n){let r=jn(),s=jn();return n.forEach((e=>r=r.add(e))),t.getEntries(e,r).next((e=>{let r=On();return n.forEach(((n,i)=>{const o=e.get(n);i.isFoundDocument()!==o.isFoundDocument()&&(s=s.add(n)),i.isNoDocument()&&i.version.isEqual(V.min())?(t.removeEntry(n,i.readTime),r=r.insert(n,i)):!o.isValidDocument()||i.version.compareTo(o.version)>0||0===i.version.compareTo(o.version)&&o.hasPendingWrites?(t.addEntry(i),r=r.insert(n,i)):f("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",i.version)})),{cs:r,ls:s}}))}function Mo(e,t){const n=v(e);return n.persistence.runTransaction("Get next mutation batch","readonly",(e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t))))}function Lo(e,t){const n=v(e);return n.persistence.runTransaction("Allocate target","readwrite",(e=>{let r;return n.Qr.getTargetData(e,t).next((s=>s?(r=s,re.resolve(r)):n.Qr.allocateTargetId(e).next((s=>(r=new Ls(t,s,"TargetPurposeListen",e.currentSequenceNumber),n.Qr.addTargetData(e,r).next((()=>r)))))))})).then((e=>{const r=n.ns.get(e.targetId);return(null===r||e.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.ns=n.ns.insert(e.targetId,e),n.rs.set(t,e.targetId)),e}))}async function Ro(e,t,n){const r=v(e),s=r.ns.get(t),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,(e=>r.persistence.referenceDelegate.removeTarget(e,s)))}catch(e){if(!ce(e))throw e;f("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.ns=r.ns.remove(t),r.rs.delete(s.target)}function Fo(e,t,n){const r=v(e);let s=V.min(),i=jn();return r.persistence.runTransaction("Execute query","readwrite",(e=>function(e,t,n){const r=v(e),s=r.rs.get(n);return void 0!==s?re.resolve(r.ns.get(s)):r.Qr.getTargetData(t,n)}(r,e,Sn(t)).next((t=>{if(t)return s=t.lastLimboFreeSnapshotVersion,r.Qr.getMatchingKeysForTargetId(e,t.targetId).next((e=>{i=e}))})).next((()=>r.ts.getDocumentsMatchingQuery(e,t,n?s:V.min(),n?i:jn()))).next((e=>(Oo(r,Ln(t),e),{documents:e,hs:i})))))}function Po(e,t){const n=v(e),r=v(n.Qr),s=n.ns.get(t);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",(e=>r._t(e,t).next((e=>e?e.target:null))))}function Vo(e,t){const n=v(e),r=n.ss.get(t)||V.min();return n.persistence.runTransaction("Get new document changes","readonly",(e=>n.os.getAllFromCollectionGroup(e,t,H(r,-1),Number.MAX_SAFE_INTEGER))).then((e=>(Oo(n,t,e),e)))}function Oo(e,t,n){let r=e.ss.get(t)||V.min();n.forEach(((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)})),e.ss.set(t,r)}async function qo(e,t,n=jn()){const r=await Lo(e,Sn(zs(t.bundledQuery))),s=v(e);return s.persistence.runTransaction("Save named query","readwrite",(e=>{const i=as(t.readTime);if(r.snapshotVersion.compareTo(i)>=0)return s.$r.saveNamedQuery(e,t);const o=r.withResumeToken(it.EMPTY_BYTE_STRING,i);return s.ns=s.ns.insert(o.targetId,o),s.Qr.updateTargetData(e,o).next((()=>s.Qr.removeMatchingKeysForTargetId(e,r.targetId))).next((()=>s.Qr.addMatchingKeys(e,n,r.targetId))).next((()=>s.$r.saveNamedQuery(e,t)))}))}function Uo(e,t){return`firestore_clients_${e}_${t}`}function Bo(e,t,n){let r=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function zo(e,t){return`firestore_targets_${e}_${t}`}class Go{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Es(e,t,n){const r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new _(r.error.code,r.error.message))),i?new Go(e,t,r.state,s):(m("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}ds(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class Ko{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Es(e,t){const n=JSON.parse(t);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new _(n.error.code,n.error.message))),s?new Ko(e,n.state,r):(m("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}ds(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class $o{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Es(e,t){const n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=Yn();for(let i=0;r&&i<n.activeTargetIds.length;++i)r=we(n.activeTargetIds[i]),s=s.add(n.activeTargetIds[i]);return r?new $o(e,s):(m("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class Qo{constructor(e,t){this.clientId=e,this.onlineState=t}static Es(e){const t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new Qo(t.clientId,t.onlineState):(m("SharedClientState",`Failed to parse online state: ${e}`),null)}}class jo{constructor(){this.activeTargetIds=Yn()}As(e){this.activeTargetIds=this.activeTargetIds.add(e)}Rs(e){this.activeTargetIds=this.activeTargetIds.delete(e)}ds(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class Wo{constructor(e,t,n,r,s){this.window=e,this.oi=t,this.persistenceKey=n,this.Vs=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.fs=this.gs.bind(this),this.ps=new Je(L),this.started=!1,this.ys=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.ws=Uo(this.persistenceKey,this.Vs),this.Ss=function(e){return`firestore_sequence_number_${e}`}(this.persistenceKey),this.ps=this.ps.insert(this.Vs,new jo),this.bs=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.Ds=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.Cs=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.vs=function(e){return`firestore_online_state_${e}`}(this.persistenceKey),this.Fs=function(e){return`firestore_bundle_loaded_v2_${e}`}(this.persistenceKey),this.window.addEventListener("storage",this.fs)}static D(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.Li();for(const n of e){if(n===this.Vs)continue;const e=this.getItem(Uo(this.persistenceKey,n));if(e){const t=$o.Es(n,e);t&&(this.ps=this.ps.insert(t.clientId,t))}}this.Ms();const t=this.storage.getItem(this.vs);if(t){const e=this.xs(t);e&&this.Os(e)}for(const n of this.ys)this.gs(n);this.ys=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(e){this.setItem(this.Ss,JSON.stringify(e))}getAllActiveQueryTargets(){return this.Ns(this.ps)}isActiveQueryTarget(e){let t=!1;return this.ps.forEach(((n,r)=>{r.activeTargetIds.has(e)&&(t=!0)})),t}addPendingMutation(e){this.Bs(e,"pending")}updateMutationState(e,t,n){this.Bs(e,t,n),this.Ls(e)}addLocalQueryTarget(e){let t="not-current";if(this.isActiveQueryTarget(e)){const n=this.storage.getItem(zo(this.persistenceKey,e));if(n){const r=Ko.Es(e,n);r&&(t=r.state)}}return this.ks.As(e),this.Ms(),t}removeLocalQueryTarget(e){this.ks.Rs(e),this.Ms()}isLocalQueryTarget(e){return this.ks.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(zo(this.persistenceKey,e))}updateQueryState(e,t,n){this.qs(e,t,n)}handleUserChange(e,t,n){t.forEach((e=>{this.Ls(e)})),this.currentUser=e,n.forEach((e=>{this.addPendingMutation(e)}))}setOnlineState(e){this.Qs(e)}notifyBundleLoaded(e){this.Ks(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.fs),this.removeItem(this.ws),this.started=!1)}getItem(e){const t=this.storage.getItem(e);return f("SharedClientState","READ",e,t),t}setItem(e,t){f("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){f("SharedClientState","REMOVE",e),this.storage.removeItem(e)}gs(e){const t=e;if(t.storageArea===this.storage){if(f("SharedClientState","EVENT",t.key,t.newValue),t.key===this.ws)return void m("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.oi.enqueueRetryable((async()=>{if(this.started){if(null!==t.key)if(this.bs.test(t.key)){if(null==t.newValue){const e=this.$s(t.key);return this.Us(e,null)}{const e=this.Ws(t.key,t.newValue);if(e)return this.Us(e.clientId,e)}}else if(this.Ds.test(t.key)){if(null!==t.newValue){const e=this.Gs(t.key,t.newValue);if(e)return this.zs(e)}}else if(this.Cs.test(t.key)){if(null!==t.newValue){const e=this.js(t.key,t.newValue);if(e)return this.Hs(e)}}else if(t.key===this.vs){if(null!==t.newValue){const e=this.xs(t.newValue);if(e)return this.Os(e)}}else if(t.key===this.Ss){const e=function(e){let t=ge._e;if(null!=e)try{const n=JSON.parse(e);w("number"==typeof n),t=n}catch(e){m("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(t.newValue);e!==ge._e&&this.sequenceNumberHandler(e)}else if(t.key===this.Fs){const e=this.Js(t.newValue);await Promise.all(e.map((e=>this.syncEngine.Ys(e))))}}else this.ys.push(t)}))}}get ks(){return this.ps.get(this.Vs)}Ms(){this.setItem(this.ws,this.ks.ds())}Bs(e,t,n){const r=new Go(this.currentUser,e,t,n),s=Bo(this.persistenceKey,this.currentUser,e);this.setItem(s,r.ds())}Ls(e){const t=Bo(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Qs(e){const t={clientId:this.Vs,onlineState:e};this.storage.setItem(this.vs,JSON.stringify(t))}qs(e,t,n){const r=zo(this.persistenceKey,e),s=new Ko(e,t,n);this.setItem(r,s.ds())}Ks(e){const t=JSON.stringify(Array.from(e));this.setItem(this.Fs,t)}$s(e){const t=this.bs.exec(e);return t?t[1]:null}Ws(e,t){const n=this.$s(e);return $o.Es(n,t)}Gs(e,t){const n=this.Ds.exec(e),r=Number(n[1]),s=void 0!==n[2]?n[2]:null;return Go.Es(new u(s),r,t)}js(e,t){const n=this.Cs.exec(e),r=Number(n[1]);return Ko.Es(r,t)}xs(e){return Qo.Es(e)}Js(e){return JSON.parse(e)}async zs(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.Zs(e.batchId,e.state,e.error);f("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}Hs(e){return this.syncEngine.Xs(e.targetId,e.state,e.error)}Us(e,t){const n=t?this.ps.insert(e,t):this.ps.remove(e),r=this.Ns(this.ps),s=this.Ns(n),i=[],o=[];return s.forEach((e=>{r.has(e)||i.push(e)})),r.forEach((e=>{s.has(e)||o.push(e)})),this.syncEngine.eo(i,o).then((()=>{this.ps=n}))}Os(e){this.ps.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}Ns(e){let t=Yn();return e.forEach(((e,n)=>{t=t.unionWith(n.activeTargetIds)})),t}}class Yo{constructor(){this.no=new jo,this.ro={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.no.As(e),this.ro[e]||"not-current"}updateQueryState(e,t,n){this.ro[e]=t}removeLocalQueryTarget(e){this.no.Rs(e)}isLocalQueryTarget(e){return this.no.activeTargetIds.has(e)}clearQueryState(e){delete this.ro[e]}getAllActiveQueryTargets(){return this.no.activeTargetIds}isActiveQueryTarget(e){return this.no.activeTargetIds.has(e)}start(){return this.no=new jo,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class Ho{io(e){}shutdown(){}}class Jo{constructor(){this.so=()=>this.oo(),this._o=()=>this.ao(),this.uo=[],this.co()}io(e){this.uo.push(e)}shutdown(){window.removeEventListener("online",this.so),window.removeEventListener("offline",this._o)}co(){window.addEventListener("online",this.so),window.addEventListener("offline",this._o)}oo(){f("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.uo)e(0)}ao(){f("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.uo)e(1)}static D(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}let Xo=null;function Zo(){return null===Xo?Xo=268435456+Math.round(2147483648*Math.random()):Xo++,"0x"+Xo.toString(16)}const ea={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};class ta{constructor(e){this.lo=e.lo,this.ho=e.ho}Po(e){this.Io=e}To(e){this.Eo=e}onMessage(e){this.Ao=e}close(){this.ho()}send(e){this.lo(e)}Ro(){this.Io()}Vo(e){this.Eo(e)}mo(e){this.Ao(e)}}const na="WebChannelConnection";class ra extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;const t=e.ssl?"https":"http",n=encodeURIComponent(this.databaseId.projectId),r=encodeURIComponent(this.databaseId.database);this.fo=t+"://"+e.host,this.po=`projects/${n}/databases/${r}`,this.yo="(default)"===this.databaseId.database?`project_id=${n}`:`project_id=${n}&database_id=${r}`}get wo(){return!1}So(e,t,n,r,s){const i=Zo(),o=this.bo(e,t.toUriEncodedString());f("RestConnection",`Sending RPC '${e}' ${i}:`,o,n);const a={"google-cloud-resource-prefix":this.po,"x-goog-request-params":this.yo};return this.Do(a,r,s),this.Co(e,o,a,n).then((t=>(f("RestConnection",`Received RPC '${e}' ${i}: `,t),t)),(t=>{throw g("RestConnection",`RPC '${e}' ${i} failed with error: `,t,"url: ",o,"request:",n),t}))}vo(e,t,n,r,s,i){return this.So(e,t,n,r,s)}Do(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+l,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach(((t,n)=>e[n]=t)),n&&n.headers.forEach(((t,n)=>e[n]=t))}bo(e,t){const n=ea[e];return`${this.fo}/v1/${t}:${n}`}terminate(){}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams,this.longPollingOptions=e.longPollingOptions}Co(e,t,n,r){const s=Zo();return new Promise(((i,o)=>{const c=new a.XhrIo;c.setWithCredentials(!0),c.listenOnce(a.EventType.COMPLETE,(()=>{try{switch(c.getLastErrorCode()){case a.ErrorCode.NO_ERROR:const t=c.getResponseJson();f(na,`XHR for RPC '${e}' ${s} received:`,JSON.stringify(t)),i(t);break;case a.ErrorCode.TIMEOUT:f(na,`RPC '${e}' ${s} timed out`),o(new _(I.DEADLINE_EXCEEDED,"Request time out"));break;case a.ErrorCode.HTTP_ERROR:const n=c.getStatus();if(f(na,`RPC '${e}' ${s} failed with status:`,n,"response text:",c.getResponseText()),n>0){let e=c.getResponseJson();Array.isArray(e)&&(e=e[0]);const t=null==e?void 0:e.error;if(t&&t.status&&t.message){const e=function(e){const t=e.toLowerCase().replace(/_/g,"-");return Object.values(I).indexOf(t)>=0?t:I.UNKNOWN}(t.status);o(new _(e,t.message))}else o(new _(I.UNKNOWN,"Server responded with status "+c.getStatus()))}else o(new _(I.UNAVAILABLE,"Connection failed."));break;default:y()}}finally{f(na,`RPC '${e}' ${s} completed.`)}}));const u=JSON.stringify(r);f(na,`RPC '${e}' ${s} sending request:`,r),c.send(t,"POST",u,n,15)}))}Fo(e,t,n){const r=Zo(),s=[this.fo,"/","google.firestore.v1.Firestore","/",e,"/channel"],i=a.createWebChannelTransport(),o=a.getStatEventTarget(),c={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},u=this.longPollingOptions.timeoutSeconds;void 0!==u&&(c.longPollingTimeout=Math.round(1e3*u)),this.useFetchStreams&&(c.useFetchStreams=!0),this.Do(c.initMessageHeaders,t,n),c.encodeInitMessageHeaders=!0;const l=s.join("");f(na,`Creating RPC '${e}' stream ${r}: ${l}`,c);const h=i.createWebChannel(l,c);let d=!1,m=!1;const p=new ta({lo:t=>{m?f(na,`Not sending because RPC '${e}' stream ${r} is closed:`,t):(d||(f(na,`Opening RPC '${e}' stream ${r} transport.`),h.open(),d=!0),f(na,`RPC '${e}' stream ${r} sending:`,t),h.send(t))},ho:()=>h.close()}),y=(e,t,n)=>{e.listen(t,(e=>{try{n(e)}catch(e){setTimeout((()=>{throw e}),0)}}))};return y(h,a.WebChannel.EventType.OPEN,(()=>{m||f(na,`RPC '${e}' stream ${r} transport opened.`)})),y(h,a.WebChannel.EventType.CLOSE,(()=>{m||(m=!0,f(na,`RPC '${e}' stream ${r} transport closed`),p.Vo())})),y(h,a.WebChannel.EventType.ERROR,(t=>{m||(m=!0,g(na,`RPC '${e}' stream ${r} transport errored:`,t),p.Vo(new _(I.UNAVAILABLE,"The operation could not be completed")))})),y(h,a.WebChannel.EventType.MESSAGE,(t=>{var n;if(!m){const s=t.data[0];w(!!s);const i=s,o=i.error||(null===(n=i[0])||void 0===n?void 0:n.error);if(o){f(na,`RPC '${e}' stream ${r} received error:`,o);const t=o.status;let n=function(e){const t=Lr[e];if(void 0!==t)return Pr(t)}(t),s=o.message;void 0===n&&(n=I.INTERNAL,s="Unknown error status: "+t+" with message "+o.message),m=!0,p.Vo(new _(n,s)),h.close()}else f(na,`RPC '${e}' stream ${r} received:`,s),p.mo(s)}})),y(o,a.Event.STAT_EVENT,(t=>{t.stat===a.Stat.PROXY?f(na,`RPC '${e}' stream ${r} detected buffering proxy`):t.stat===a.Stat.NOPROXY&&f(na,`RPC '${e}' stream ${r} detected no buffering proxy`)})),setTimeout((()=>{p.Ro()}),0),p}}function sa(){return"undefined"!=typeof window?window:null}function ia(){return"undefined"!=typeof document?document:null}function oa(e){return new ns(e,!0)}class aa{constructor(e,t,n=1e3,r=1.5,s=6e4){this.oi=e,this.timerId=t,this.Mo=n,this.xo=r,this.Oo=s,this.No=0,this.Bo=null,this.Lo=Date.now(),this.reset()}reset(){this.No=0}ko(){this.No=this.Oo}qo(e){this.cancel();const t=Math.floor(this.No+this.Qo()),n=Math.max(0,Date.now()-this.Lo),r=Math.max(0,t-n);r>0&&f("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.No} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.Bo=this.oi.enqueueAfterDelay(this.timerId,r,(()=>(this.Lo=Date.now(),e()))),this.No*=this.xo,this.No<this.Mo&&(this.No=this.Mo),this.No>this.Oo&&(this.No=this.Oo)}Ko(){null!==this.Bo&&(this.Bo.skipDelay(),this.Bo=null)}cancel(){null!==this.Bo&&(this.Bo.cancel(),this.Bo=null)}Qo(){return(Math.random()-.5)*this.No}}class ca{constructor(e,t,n,r,s,i,o,a){this.oi=e,this.$o=n,this.Uo=r,this.connection=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.Wo=0,this.Go=null,this.zo=null,this.stream=null,this.jo=new aa(e,t)}Ho(){return 1===this.state||5===this.state||this.Jo()}Jo(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.Yo()}async stop(){this.Ho()&&await this.close(0)}Zo(){this.state=0,this.jo.reset()}Xo(){this.Jo()&&null===this.Go&&(this.Go=this.oi.enqueueAfterDelay(this.$o,6e4,(()=>this.e_())))}t_(e){this.n_(),this.stream.send(e)}async e_(){if(this.Jo())return this.close(0)}n_(){this.Go&&(this.Go.cancel(),this.Go=null)}r_(){this.zo&&(this.zo.cancel(),this.zo=null)}async close(e,t){this.n_(),this.r_(),this.jo.cancel(),this.Wo++,4!==e?this.jo.reset():t&&t.code===I.RESOURCE_EXHAUSTED?(m(t.toString()),m("Using maximum backoff delay to prevent overloading the backend."),this.jo.ko()):t&&t.code===I.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.i_(),this.stream.close(),this.stream=null),this.state=e,await this.listener.To(t)}i_(){}auth(){this.state=1;const e=this.s_(this.Wo),t=this.Wo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([e,n])=>{this.Wo===t&&this.o_(e,n)}),(t=>{e((()=>{const e=new _(I.UNKNOWN,"Fetching auth token failed: "+t.message);return this.__(e)}))}))}o_(e,t){const n=this.s_(this.Wo);this.stream=this.a_(e,t),this.stream.Po((()=>{n((()=>(this.state=2,this.zo=this.oi.enqueueAfterDelay(this.Uo,1e4,(()=>(this.Jo()&&(this.state=3),Promise.resolve()))),this.listener.Po())))})),this.stream.To((e=>{n((()=>this.__(e)))})),this.stream.onMessage((e=>{n((()=>this.onMessage(e)))}))}Yo(){this.state=5,this.jo.qo((async()=>{this.state=0,this.start()}))}__(e){return f("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}s_(e){return t=>{this.oi.enqueueAndForget((()=>this.Wo===e?t():(f("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class ua extends ca{constructor(e,t,n,r,s,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,i),this.serializer=s}a_(e,t){return this.connection.Fo("Listen",e,t)}onMessage(e){this.jo.reset();const t=function(e,t){let n;if("targetChange"in t){t.targetChange;const r=function(e){return"NO_CHANGE"===e?0:"ADD"===e?1:"REMOVE"===e?2:"CURRENT"===e?3:"RESET"===e?4:y()}(t.targetChange.targetChangeType||"NO_CHANGE"),s=t.targetChange.targetIds||[],i=function(e,t){return e.useProto3Json?(w(void 0===t||"string"==typeof t),it.fromBase64String(t||"")):(w(void 0===t||t instanceof Uint8Array),it.fromUint8Array(t||new Uint8Array))}(e,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(e){const t=void 0===e.code?I.UNKNOWN:Pr(e.code);return new _(t,e.message||"")}(o);n=new Wr(r,s,i,a||null)}else if("documentChange"in t){t.documentChange;const r=t.documentChange;r.document,r.document.name,r.document.updateTime;const s=ds(e,r.document.name),i=as(r.document.updateTime),o=r.document.createTime?as(r.document.createTime):V.min(),a=new Vt({mapValue:{fields:r.document.fields}}),c=qt.newFoundDocument(s,i,o,a),u=r.targetIds||[],l=r.removedTargetIds||[];n=new Qr(u,l,c.key,c)}else if("documentDelete"in t){t.documentDelete;const r=t.documentDelete;r.document;const s=ds(e,r.document),i=r.readTime?as(r.readTime):V.min(),o=qt.newNoDocument(s,i),a=r.removedTargetIds||[];n=new Qr([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const r=t.documentRemove;r.document;const s=ds(e,r.document),i=r.removedTargetIds||[];n=new Qr([],i,s,null)}else{if(!("filter"in t))return y();{t.filter;const e=t.filter;e.targetId;const{count:r=0,unchangedNames:s}=e,i=new Mr(r,s),o=e.targetId;n=new jr(o,i)}}return n}(this.serializer,e),n=function(e){if(!("targetChange"in e))return V.min();const t=e.targetChange;return t.targetIds&&t.targetIds.length?V.min():t.readTime?as(t.readTime):V.min()}(e);return this.listener.u_(t,n)}c_(e){const t={};t.database=gs(this.serializer),t.addTarget=function(e,t){let n;const r=t.target;if(n=gn(r)?{documents:_s(e,r)}:{query:bs(e,r).ut},n.targetId=t.targetId,t.resumeToken.approximateByteSize()>0){n.resumeToken=is(e,t.resumeToken);const r=rs(e,t.expectedCount);null!==r&&(n.expectedCount=r)}else if(t.snapshotVersion.compareTo(V.min())>0){n.readTime=ss(e,t.snapshotVersion.toTimestamp());const r=rs(e,t.expectedCount);null!==r&&(n.expectedCount=r)}return n}(this.serializer,e);const n=function(e,t){const n=function(e){switch(e){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return y()}}(t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.serializer,e);n&&(t.labels=n),this.t_(t)}l_(e){const t={};t.database=gs(this.serializer),t.removeTarget=e,this.t_(t)}}class la extends ca{constructor(e,t,n,r,s,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,i),this.serializer=s,this.h_=!1}get P_(){return this.h_}start(){this.h_=!1,this.lastStreamToken=void 0,super.start()}i_(){this.h_&&this.I_([])}a_(e,t){return this.connection.Fo("Write",e,t)}onMessage(e){if(w(!!e.streamToken),this.lastStreamToken=e.streamToken,this.h_){this.jo.reset();const t=function(e,t){return e&&e.length>0?(w(void 0!==t),e.map((e=>function(e,t){let n=e.updateTime?as(e.updateTime):as(t);return n.isEqual(V.min())&&(n=as(t)),new dr(n,e.transformResults||[])}(e,t)))):[]}(e.writeResults,e.commitTime),n=as(e.commitTime);return this.listener.T_(n,t)}return w(!e.writeResults||0===e.writeResults.length),this.h_=!0,this.listener.E_()}d_(){const e={};e.database=gs(this.serializer),this.t_(e)}I_(e){const t={streamToken:this.lastStreamToken,writes:e.map((e=>vs(this.serializer,e)))};this.t_(t)}}class ha extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.connection=n,this.serializer=r,this.A_=!1}R_(){if(this.A_)throw new _(I.FAILED_PRECONDITION,"The client has already been terminated.")}So(e,t,n,r){return this.R_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,i])=>this.connection.So(e,us(t,n),r,s,i))).catch((e=>{throw"FirebaseError"===e.name?(e.code===I.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new _(I.UNKNOWN,e.toString())}))}vo(e,t,n,r,s){return this.R_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([i,o])=>this.connection.vo(e,us(t,n),r,i,o,s))).catch((e=>{throw"FirebaseError"===e.name?(e.code===I.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new _(I.UNKNOWN,e.toString())}))}terminate(){this.A_=!0,this.connection.terminate()}}class da{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.m_=0,this.f_=null,this.g_=!0}p_(){0===this.m_&&(this.y_("Unknown"),this.f_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.f_=null,this.w_("Backend didn't respond within 10 seconds."),this.y_("Offline"),Promise.resolve()))))}S_(e){"Online"===this.state?this.y_("Unknown"):(this.m_++,this.m_>=1&&(this.b_(),this.w_(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.y_("Offline")))}set(e){this.b_(),this.m_=0,"Online"===e&&(this.g_=!1),this.y_(e)}y_(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}w_(e){const t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.g_?(m(t),this.g_=!1):f("OnlineStateTracker",t)}b_(){null!==this.f_&&(this.f_.cancel(),this.f_=null)}}class fa{constructor(e,t,n,r,s){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.D_=[],this.C_=new Map,this.v_=new Set,this.F_=[],this.M_=s,this.M_.io((e=>{n.enqueueAndForget((async()=>{ba(this)&&(f("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=v(e);t.v_.add(4),await ga(t),t.x_.set("Unknown"),t.v_.delete(4),await ma(t)}(this))}))})),this.x_=new da(n,r)}}async function ma(e){if(ba(e))for(const t of e.F_)await t(!0)}async function ga(e){for(const t of e.F_)await t(!1)}function pa(e,t){const n=v(e);n.C_.has(t.targetId)||(n.C_.set(t.targetId,t),_a(n)?Ia(n):Ua(n).Jo()&&wa(n,t))}function ya(e,t){const n=v(e),r=Ua(n);n.C_.delete(t),r.Jo()&&va(n,t),0===n.C_.size&&(r.Jo()?r.Xo():ba(n)&&n.x_.set("Unknown"))}function wa(e,t){if(e.O_.Oe(t.targetId),t.resumeToken.approximateByteSize()>0||t.snapshotVersion.compareTo(V.min())>0){const n=e.remoteSyncer.getRemoteKeysForTarget(t.targetId).size;t=t.withExpectedCount(n)}Ua(e).c_(t)}function va(e,t){e.O_.Oe(t),Ua(e).l_(t)}function Ia(e){e.O_=new Hr({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),_t:t=>e.C_.get(t)||null,nt:()=>e.datastore.serializer.databaseId}),Ua(e).start(),e.x_.p_()}function _a(e){return ba(e)&&!Ua(e).Ho()&&e.C_.size>0}function ba(e){return 0===v(e).v_.size}function Ea(e){e.O_=void 0}async function Ta(e){e.C_.forEach(((t,n)=>{wa(e,t)}))}async function Sa(e,t){Ea(e),_a(e)?(e.x_.S_(t),Ia(e)):e.x_.set("Unknown")}async function xa(e,t,n){if(e.x_.set("Online"),t instanceof Wr&&2===t.state&&t.cause)try{await async function(e,t){const n=t.cause;for(const r of t.targetIds)e.C_.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.C_.delete(r),e.O_.removeTarget(r))}(e,t)}catch(n){f("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await Ca(e,n)}else if(t instanceof Qr?e.O_.$e(t):t instanceof jr?e.O_.Je(t):e.O_.Ge(t),!n.isEqual(V.min()))try{const t=await Ao(e.localStore);n.compareTo(t)>=0&&await function(e,t){const n=e.O_.it(t);return n.targetChanges.forEach(((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const s=e.C_.get(r);s&&e.C_.set(r,s.withResumeToken(n.resumeToken,t))}})),n.targetMismatches.forEach(((t,n)=>{const r=e.C_.get(t);if(!r)return;e.C_.set(t,r.withResumeToken(it.EMPTY_BYTE_STRING,r.snapshotVersion)),va(e,t);const s=new Ls(r.target,t,n,r.sequenceNumber);wa(e,s)})),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){f("RemoteStore","Failed to raise snapshot:",t),await Ca(e,t)}}async function Ca(e,t,n){if(!ce(t))throw t;e.v_.add(1),await ga(e),e.x_.set("Offline"),n||(n=()=>Ao(e.localStore)),e.asyncQueue.enqueueRetryable((async()=>{f("RemoteStore","Retrying IndexedDB access"),await n(),e.v_.delete(1),await ma(e)}))}function Da(e,t){return t().catch((n=>Ca(e,n,t)))}async function Na(e){const t=v(e),n=Ba(t);let r=t.D_.length>0?t.D_[t.D_.length-1].batchId:-1;for(;Aa(t);)try{const e=await Mo(t.localStore,r);if(null===e){0===t.D_.length&&n.Xo();break}r=e.batchId,ka(t,e)}catch(e){await Ca(t,e)}Ma(t)&&La(t)}function Aa(e){return ba(e)&&e.D_.length<10}function ka(e,t){e.D_.push(t);const n=Ba(e);n.Jo()&&n.P_&&n.I_(t.mutations)}function Ma(e){return ba(e)&&!Ba(e).Ho()&&e.D_.length>0}function La(e){Ba(e).start()}async function Ra(e){Ba(e).d_()}async function Fa(e){const t=Ba(e);for(const n of e.D_)t.I_(n.mutations)}async function Pa(e,t,n){const r=e.D_.shift(),s=Nr.from(r,t,n);await Da(e,(()=>e.remoteSyncer.applySuccessfulWrite(s))),await Na(e)}async function Va(e,t){t&&Ba(e).P_&&await async function(e,t){if(function(e){return Fr(e)&&e!==I.ABORTED}(t.code)){const n=e.D_.shift();Ba(e).Zo(),await Da(e,(()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t))),await Na(e)}}(e,t),Ma(e)&&La(e)}async function Oa(e,t){const n=v(e);n.asyncQueue.verifyOperationInProgress(),f("RemoteStore","RemoteStore received new credentials");const r=ba(n);n.v_.add(3),await ga(n),r&&n.x_.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.v_.delete(3),await ma(n)}async function qa(e,t){const n=v(e);t?(n.v_.delete(2),await ma(n)):t||(n.v_.add(2),await ga(n),n.x_.set("Unknown"))}function Ua(e){return e.N_||(e.N_=function(e,t,n){const r=v(e);return r.R_(),new ua(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{Po:Ta.bind(null,e),To:Sa.bind(null,e),u_:xa.bind(null,e)}),e.F_.push((async t=>{t?(e.N_.Zo(),_a(e)?Ia(e):e.x_.set("Unknown")):(await e.N_.stop(),Ea(e))}))),e.N_}function Ba(e){return e.B_||(e.B_=function(e,t,n){const r=v(e);return r.R_(),new la(t,r.connection,r.authCredentials,r.appCheckCredentials,r.serializer,n)}(e.datastore,e.asyncQueue,{Po:Ra.bind(null,e),To:Va.bind(null,e),E_:Fa.bind(null,e),T_:Pa.bind(null,e)}),e.F_.push((async t=>{t?(e.B_.Zo(),await Na(e)):(await e.B_.stop(),e.D_.length>0&&(f("RemoteStore",`Stopping write stream with ${e.D_.length} pending writes`),e.D_=[]))}))),e.B_}class za{constructor(e,t,n,r,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new b,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((e=>{}))}get promise(){return this.deferred.promise}static createAndSchedule(e,t,n,r,s){const i=Date.now()+n,o=new za(e,t,i,r,s);return o.start(n),o}start(e){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new _(I.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((e=>this.deferred.resolve(e)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Ga(e,t){if(m("AsyncQueue",`${t}: ${e}`),ce(e))return new _(I.UNAVAILABLE,`${t}: ${e}`);throw e}class Ka{constructor(e){this.comparator=e?(t,n)=>e(t,n)||z.comparator(t.key,n.key):(e,t)=>z.comparator(e.key,t.key),this.keyedMap=Un(),this.sortedSet=new Je(this.comparator)}static emptySet(e){return new Ka(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal(((t,n)=>(e(t),!1)))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof Ka))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const e=[];return this.forEach((t=>{e.push(t.toString())})),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new Ka;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class $a{constructor(){this.L_=new Je(z.comparator)}track(e){const t=e.doc.key,n=this.L_.get(t);n?0!==e.type&&3===n.type?this.L_=this.L_.insert(t,e):3===e.type&&1!==n.type?this.L_=this.L_.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.L_=this.L_.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.L_=this.L_.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.L_=this.L_.remove(t):1===e.type&&2===n.type?this.L_=this.L_.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.L_=this.L_.insert(t,{type:2,doc:e.doc}):y():this.L_=this.L_.insert(t,e)}k_(){const e=[];return this.L_.inorderTraversal(((t,n)=>{e.push(n)})),e}}class Qa{constructor(e,t,n,r,s,i,o,a,c){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a,this.hasCachedResults=c}static fromInitialDocuments(e,t,n,r,s){const i=[];return t.forEach((e=>{i.push({type:0,doc:e})})),new Qa(e,t,Ka.emptySet(t),i,n,r,!0,!1,s)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.hasCachedResults===e.hasCachedResults&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Nn(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(t[r].type!==n[r].type||!t[r].doc.isEqual(n[r].doc))return!1;return!0}}class ja{constructor(){this.q_=void 0,this.Q_=[]}}class Wa{constructor(){this.queries=new Pn((e=>An(e)),Nn),this.onlineState="Unknown",this.K_=new Set}}async function Ya(e,t){const n=v(e),r=t.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new ja),s)try{i.q_=await n.onListen(r)}catch(e){const n=Ga(e,`Initialization of query '${kn(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,i),i.Q_.push(t),t.U_(n.onlineState),i.q_&&t.W_(i.q_)&&Za(n)}async function Ha(e,t){const n=v(e),r=t.query;let s=!1;const i=n.queries.get(r);if(i){const e=i.Q_.indexOf(t);e>=0&&(i.Q_.splice(e,1),s=0===i.Q_.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function Ja(e,t){const n=v(e);let r=!1;for(const s of t){const e=s.query,t=n.queries.get(e);if(t){for(const e of t.Q_)e.W_(s)&&(r=!0);t.q_=s}}r&&Za(n)}function Xa(e,t,n){const r=v(e),s=r.queries.get(t);if(s)for(const i of s.Q_)i.onError(n);r.queries.delete(t)}function Za(e){e.K_.forEach((e=>{e.next()}))}class ec{constructor(e,t,n){this.query=e,this.G_=t,this.z_=!1,this.j_=null,this.onlineState="Unknown",this.options=n||{}}W_(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new Qa(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0,e.hasCachedResults)}let t=!1;return this.z_?this.H_(e)&&(this.G_.next(e),t=!0):this.J_(e,this.onlineState)&&(this.Y_(e),t=!0),this.j_=e,t}onError(e){this.G_.error(e)}U_(e){this.onlineState=e;let t=!1;return this.j_&&!this.z_&&this.J_(this.j_,e)&&(this.Y_(this.j_),t=!0),t}J_(e,t){if(!e.fromCache)return!0;const n="Offline"!==t;return(!this.options.Z_||!n)&&(!e.docs.isEmpty()||e.hasCachedResults||"Offline"===t)}H_(e){if(e.docChanges.length>0)return!0;const t=this.j_&&this.j_.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}Y_(e){e=Qa.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache,e.hasCachedResults),this.z_=!0,this.G_.next(e)}}class tc{constructor(e,t){this.X_=e,this.byteLength=t}ea(){return"metadata"in this.X_}}class nc{constructor(e){this.serializer=e}Ps(e){return ds(this.serializer,e)}Is(e){return e.metadata.exists?ws(this.serializer,e.document,!1):qt.newNoDocument(this.Ps(e.metadata.name),this.Ts(e.metadata.readTime))}Ts(e){return as(e)}}class rc{constructor(e,t,n){this.ta=e,this.localStore=t,this.serializer=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=sc(e)}na(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.X_.namedQuery)this.queries.push(e.X_.namedQuery);else if(e.X_.documentMetadata){this.documents.push({metadata:e.X_.documentMetadata}),e.X_.documentMetadata.exists||++t;const n=q.fromString(e.X_.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.X_.document&&(this.documents[this.documents.length-1].document=e.X_.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}ra(e){const t=new Map,n=new nc(this.serializer);for(const r of e)if(r.metadata.queries){const e=n.Ps(r.metadata.name);for(const n of r.metadata.queries){const r=(t.get(n)||jn()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const s=v(e);let i=jn(),o=On();for(const u of n){const e=t.Ps(u.metadata.name);u.document&&(i=i.add(e));const n=t.Is(u);n.setReadTime(t.Ts(u.metadata.readTime)),o=o.insert(e,n)}const a=s.os.newChangeBuffer({trackRemovals:!0}),c=await Lo(s,function(e){return Sn(_n(q.fromString(`__bundle__/docs/${e}`)))}(r));return s.persistence.runTransaction("Apply bundle documents","readwrite",(e=>ko(e,a,o).next((t=>(a.apply(e),t))).next((t=>s.Qr.removeMatchingKeysForTargetId(e,c.targetId).next((()=>s.Qr.addMatchingKeys(e,i,c.targetId))).next((()=>s.localDocuments.getLocalViewOfDocuments(e,t.cs,t.ls))).next((()=>t.cs))))))}(this.localStore,new nc(this.serializer),this.documents,this.ta.id),t=this.ra(this.documents);for(const n of this.queries)await qo(this.localStore,n,t.get(n.name));return this.progress.taskState="Success",{progress:this.progress,ia:this.collectionGroups,sa:e}}}function sc(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class ic{constructor(e){this.key=e}}class oc{constructor(e){this.key=e}}class ac{constructor(e,t){this.query=e,this.oa=t,this._a=null,this.hasCachedResults=!1,this.current=!1,this.aa=jn(),this.mutatedKeys=jn(),this.ua=Rn(e),this.ca=new Ka(this.ua)}get la(){return this.oa}ha(e,t){const n=t?t.Pa:new $a,r=t?t.ca:this.ca;let s=t?t.mutatedKeys:this.mutatedKeys,i=r,o=!1;const a="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,c="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal(((e,t)=>{const u=r.get(e),l=Mn(this.query,t)?t:null,h=!!u&&this.mutatedKeys.has(u.key),d=!!l&&(l.hasLocalMutations||this.mutatedKeys.has(l.key)&&l.hasCommittedMutations);let f=!1;u&&l?u.data.isEqual(l.data)?h!==d&&(n.track({type:3,doc:l}),f=!0):this.Ia(u,l)||(n.track({type:2,doc:l}),f=!0,(a&&this.ua(l,a)>0||c&&this.ua(l,c)<0)&&(o=!0)):!u&&l?(n.track({type:0,doc:l}),f=!0):u&&!l&&(n.track({type:1,doc:u}),f=!0,(a||c)&&(o=!0)),f&&(l?(i=i.add(l),s=d?s.add(e):s.delete(e)):(i=i.delete(e),s=s.delete(e)))})),null!==this.query.limit)for(;i.size>this.query.limit;){const e="F"===this.query.limitType?i.last():i.first();i=i.delete(e.key),s=s.delete(e.key),n.track({type:1,doc:e})}return{ca:i,Pa:n,Xi:o,mutatedKeys:s}}Ia(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n,r){const s=this.ca;this.ca=e.ca,this.mutatedKeys=e.mutatedKeys;const i=e.Pa.k_();i.sort(((e,t)=>function(e,t){const n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return y()}};return n(e)-n(t)}(e.type,t.type)||this.ua(e.doc,t.doc))),this.Ta(n),r=null!=r&&r;const o=t&&!r?this.Ea():[],a=0===this.aa.size&&this.current&&!r?1:0,c=a!==this._a;return this._a=a,0!==i.length||c?{snapshot:new Qa(this.query,e.ca,s,i,e.mutatedKeys,0===a,c,!1,!!n&&n.resumeToken.approximateByteSize()>0),da:o}:{da:o}}U_(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({ca:this.ca,Pa:new $a,mutatedKeys:this.mutatedKeys,Xi:!1},!1)):{da:[]}}Aa(e){return!this.oa.has(e)&&!!this.ca.has(e)&&!this.ca.get(e).hasLocalMutations}Ta(e){e&&(e.addedDocuments.forEach((e=>this.oa=this.oa.add(e))),e.modifiedDocuments.forEach((e=>{})),e.removedDocuments.forEach((e=>this.oa=this.oa.delete(e))),this.current=e.current)}Ea(){if(!this.current)return[];const e=this.aa;this.aa=jn(),this.ca.forEach((e=>{this.Aa(e.key)&&(this.aa=this.aa.add(e.key))}));const t=[];return e.forEach((e=>{this.aa.has(e)||t.push(new oc(e))})),this.aa.forEach((n=>{e.has(n)||t.push(new ic(n))})),t}Ra(e){this.oa=e.hs,this.aa=jn();const t=this.ha(e.documents);return this.applyChanges(t,!0)}Va(){return Qa.fromInitialDocuments(this.query,this.ca,this.mutatedKeys,0===this._a,this.hasCachedResults)}}class cc{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class uc{constructor(e){this.key=e,this.ma=!1}}class lc{constructor(e,t,n,r,s,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.fa={},this.ga=new Pn((e=>An(e)),Nn),this.pa=new Map,this.ya=new Set,this.wa=new Je(z.comparator),this.Sa=new Map,this.ba=new oo,this.Da={},this.Ca=new Map,this.va=Fi.Bn(),this.onlineState="Unknown",this.Fa=void 0}get isPrimaryClient(){return!0===this.Fa}}async function hc(e,t){const n=Vc(e);let r,s;const i=n.ga.get(t);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.Va();else{const e=await Lo(n.localStore,Sn(t)),i=n.sharedClientState.addLocalQueryTarget(e.targetId);r=e.targetId,s=await dc(n,t,r,"current"===i,e.resumeToken),n.isPrimaryClient&&pa(n.remoteStore,e)}return s}async function dc(e,t,n,r,s){e.Ma=(t,n,r)=>async function(e,t,n,r){let s=t.view.ha(n);s.Xi&&(s=await Fo(e.localStore,t.query,!1).then((({documents:e})=>t.view.ha(e,s))));const i=r&&r.targetChanges.get(t.targetId),o=r&&null!=r.targetMismatches.get(t.targetId),a=t.view.applyChanges(s,e.isPrimaryClient,i,o);return Ec(e,t.targetId,a.da),a.snapshot}(e,t,n,r);const i=await Fo(e.localStore,t,!0),o=new ac(t,i.hs),a=o.ha(i.documents),c=$r.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState,s),u=o.applyChanges(a,e.isPrimaryClient,c);Ec(e,n,u.da);const l=new cc(t,n,o);return e.ga.set(t,l),e.pa.has(n)?e.pa.get(n).push(t):e.pa.set(n,[t]),u.snapshot}async function fc(e,t){const n=v(e),r=n.ga.get(t),s=n.pa.get(r.targetId);if(s.length>1)return n.pa.set(r.targetId,s.filter((e=>!Nn(e,t)))),void n.ga.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await Ro(n.localStore,r.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(r.targetId),ya(n.remoteStore,r.targetId),_c(n,r.targetId)})).catch(ne)):(_c(n,r.targetId),await Ro(n.localStore,r.targetId,!0))}async function mc(e,t){const n=v(e);try{const e=await function(e,t){const n=v(e),r=t.snapshotVersion;let s=n.ns;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(e=>{const i=n.os.newChangeBuffer({trackRemovals:!0});s=n.ns;const o=[];t.targetChanges.forEach(((i,a)=>{const c=s.get(a);if(!c)return;o.push(n.Qr.removeMatchingKeys(e,i.removedDocuments,a).next((()=>n.Qr.addMatchingKeys(e,i.addedDocuments,a))));let u=c.withSequenceNumber(e.currentSequenceNumber);null!==t.targetMismatches.get(a)?u=u.withResumeToken(it.EMPTY_BYTE_STRING,V.min()).withLastLimboFreeSnapshotVersion(V.min()):i.resumeToken.approximateByteSize()>0&&(u=u.withResumeToken(i.resumeToken,r)),s=s.insert(a,u),function(e,t,n){return 0===e.resumeToken.approximateByteSize()||t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(c,u,i)&&o.push(n.Qr.updateTargetData(e,u))}));let a=On(),c=jn();if(t.documentUpdates.forEach((r=>{t.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(e,r))})),o.push(ko(e,i,t.documentUpdates).next((e=>{a=e.cs,c=e.ls}))),!r.isEqual(V.min())){const t=n.Qr.getLastRemoteSnapshotVersion(e).next((t=>n.Qr.setTargetsMetadata(e,e.currentSequenceNumber,r)));o.push(t)}return re.waitFor(o).next((()=>i.apply(e))).next((()=>n.localDocuments.getLocalViewOfDocuments(e,a,c))).next((()=>a))})).then((e=>(n.ns=s,e)))}(n.localStore,t);t.targetChanges.forEach(((e,t)=>{const r=n.Sa.get(t);r&&(w(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),e.addedDocuments.size>0?r.ma=!0:e.modifiedDocuments.size>0?w(r.ma):e.removedDocuments.size>0&&(w(r.ma),r.ma=!1))})),await xc(n,e,t)}catch(e){await ne(e)}}function gc(e,t,n){const r=v(e);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const e=[];r.ga.forEach(((n,r)=>{const s=r.view.U_(t);s.snapshot&&e.push(s.snapshot)})),function(e,t){const n=v(e);n.onlineState=t;let r=!1;n.queries.forEach(((e,n)=>{for(const s of n.Q_)s.U_(t)&&(r=!0)})),r&&Za(n)}(r.eventManager,t),e.length&&r.fa.u_(e),r.onlineState=t,r.isPrimaryClient&&r.sharedClientState.setOnlineState(t)}}async function pc(e,t,n){const r=v(e);r.sharedClientState.updateQueryState(t,"rejected",n);const s=r.Sa.get(t),i=s&&s.key;if(i){let e=new Je(z.comparator);e=e.insert(i,qt.newNoDocument(i,V.min()));const n=jn().add(i),s=new Kr(V.min(),new Map,new Je(L),e,n);await mc(r,s),r.wa=r.wa.remove(i),r.Sa.delete(t),Sc(r)}else await Ro(r.localStore,t,!1).then((()=>_c(r,t,n))).catch(ne)}async function yc(e,t){const n=v(e),r=t.batch.batchId;try{const e=await function(e,t){const n=v(e);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(e=>{const r=t.batch.keys(),s=n.os.newChangeBuffer({trackRemovals:!0});return function(e,t,n,r){const s=n.batch,i=s.keys();let o=re.resolve();return i.forEach((e=>{o=o.next((()=>r.getEntry(t,e))).next((t=>{const i=n.docVersions.get(e);w(null!==i),t.version.compareTo(i)<0&&(s.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))}))})),o.next((()=>e.mutationQueue.removeMutationBatch(t,s)))}(n,e,t,s).next((()=>s.apply(e))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=jn();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t)))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(n.localStore,t);Ic(n,r,null),vc(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await xc(n,e)}catch(e){await ne(e)}}async function wc(e,t,n){const r=v(e);try{const e=await function(e,t){const n=v(e);return n.persistence.runTransaction("Reject batch","readwrite-primary",(e=>{let r;return n.mutationQueue.lookupMutationBatch(e,t).next((t=>(w(null!==t),r=t.keys(),n.mutationQueue.removeMutationBatch(e,t)))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,r))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(r.localStore,t);Ic(r,t,n),vc(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await xc(r,e)}catch(n){await ne(n)}}function vc(e,t){(e.Ca.get(t)||[]).forEach((e=>{e.resolve()})),e.Ca.delete(t)}function Ic(e,t,n){const r=v(e);let s=r.Da[r.currentUser.toKey()];if(s){const e=s.get(t);e&&(n?e.reject(n):e.resolve(),s=s.remove(t)),r.Da[r.currentUser.toKey()]=s}}function _c(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const r of e.pa.get(t))e.ga.delete(r),n&&e.fa.xa(r,n);e.pa.delete(t),e.isPrimaryClient&&e.ba.Vr(t).forEach((t=>{e.ba.containsKey(t)||bc(e,t)}))}function bc(e,t){e.ya.delete(t.path.canonicalString());const n=e.wa.get(t);null!==n&&(ya(e.remoteStore,n),e.wa=e.wa.remove(t),e.Sa.delete(n),Sc(e))}function Ec(e,t,n){for(const r of n)r instanceof ic?(e.ba.addReference(r.key,t),Tc(e,r)):r instanceof oc?(f("SyncEngine","Document no longer in limbo: "+r.key),e.ba.removeReference(r.key,t),e.ba.containsKey(r.key)||bc(e,r.key)):y()}function Tc(e,t){const n=t.key,r=n.path.canonicalString();e.wa.get(n)||e.ya.has(r)||(f("SyncEngine","New document in limbo: "+n),e.ya.add(r),Sc(e))}function Sc(e){for(;e.ya.size>0&&e.wa.size<e.maxConcurrentLimboResolutions;){const t=e.ya.values().next().value;e.ya.delete(t);const n=new z(q.fromString(t)),r=e.va.next();e.Sa.set(r,new uc(n)),e.wa=e.wa.insert(n,r),pa(e.remoteStore,new Ls(Sn(_n(n.path)),r,"TargetPurposeLimboResolution",ge._e))}}async function xc(e,t,n){const r=v(e),s=[],i=[],o=[];r.ga.isEmpty()||(r.ga.forEach(((e,a)=>{o.push(r.Ma(a,t,n).then((e=>{if((e||n)&&r.isPrimaryClient&&r.sharedClientState.updateQueryState(a.targetId,(null==e?void 0:e.fromCache)?"not-current":"current"),e){s.push(e);const t=To.Ki(a.targetId,e);i.push(t)}})))})),await Promise.all(o),r.fa.u_(s),await async function(e,t){const n=v(e);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(e=>re.forEach(t,(t=>re.forEach(t.qi,(r=>n.persistence.referenceDelegate.addReference(e,t.targetId,r))).next((()=>re.forEach(t.Qi,(r=>n.persistence.referenceDelegate.removeReference(e,t.targetId,r)))))))))}catch(e){if(!ce(e))throw e;f("LocalStore","Failed to update sequence numbers: "+e)}for(const r of t){const e=r.targetId;if(!r.fromCache){const t=n.ns.get(e),r=t.snapshotVersion,s=t.withLastLimboFreeSnapshotVersion(r);n.ns=n.ns.insert(e,s)}}}(r.localStore,i))}async function Cc(e,t){const n=v(e);if(!n.currentUser.isEqual(t)){f("SyncEngine","User change. New user:",t.toKey());const e=await No(n.localStore,t);n.currentUser=t,function(e,t){e.Ca.forEach((e=>{e.forEach((e=>{e.reject(new _(I.CANCELLED,t))}))})),e.Ca.clear()}(n,"'waitForPendingWrites' promise is rejected due to a user change."),n.sharedClientState.handleUserChange(t,e.removedBatchIds,e.addedBatchIds),await xc(n,e.us)}}function Dc(e,t){const n=v(e),r=n.Sa.get(t);if(r&&r.ma)return jn().add(r.key);{let e=jn();const r=n.pa.get(t);if(!r)return e;for(const t of r){const r=n.ga.get(t);e=e.unionWith(r.view.la)}return e}}async function Nc(e,t){const n=v(e),r=await Fo(n.localStore,t.query,!0),s=t.view.Ra(r);return n.isPrimaryClient&&Ec(n,t.targetId,s.da),s}async function Ac(e,t){const n=v(e);return Vo(n.localStore,t).then((e=>xc(n,e)))}async function kc(e,t,n,r){const s=v(e),i=await function(e,t){const n=v(e),r=v(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",(e=>r.vn(e,t).next((t=>t?n.localDocuments.getDocuments(e,t):re.resolve(null)))))}(s.localStore,t);null!==i?("pending"===n?await Na(s.remoteStore):"acknowledged"===n||"rejected"===n?(Ic(s,t,r||null),vc(s,t),function(e,t){v(v(e).mutationQueue).Mn(t)}(s.localStore,t)):y(),await xc(s,i)):f("SyncEngine","Cannot apply mutation batch with id: "+t)}async function Mc(e,t,n){const r=v(e),s=[],i=[];for(const o of t){let e;const t=r.pa.get(o);if(t&&0!==t.length){e=await Lo(r.localStore,Sn(t[0]));for(const e of t){const t=r.ga.get(e),n=await Nc(r,t);n.snapshot&&i.push(n.snapshot)}}else{const t=await Po(r.localStore,o);e=await Lo(r.localStore,t),await dc(r,Lc(t),o,!1,e.resumeToken)}s.push(e)}return r.fa.u_(i),s}function Lc(e){return In(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function Rc(e){return function(e){return v(v(e).persistence).Li()}(v(e).localStore)}async function Fc(e,t,n,r){const s=v(e);if(s.Fa)return void f("SyncEngine","Ignoring unexpected query state notification.");const i=s.pa.get(t);if(i&&i.length>0)switch(n){case"current":case"not-current":{const e=await Vo(s.localStore,Ln(i[0])),r=Kr.createSynthesizedRemoteEventForCurrentChange(t,"current"===n,it.EMPTY_BYTE_STRING);await xc(s,e,r);break}case"rejected":await Ro(s.localStore,t,!0),_c(s,t,r);break;default:y()}}async function Pc(e,t,n){const r=Vc(e);if(r.Fa){for(const e of t){if(r.pa.has(e)){f("SyncEngine","Adding an already active target "+e);continue}const t=await Po(r.localStore,e),n=await Lo(r.localStore,t);await dc(r,Lc(t),n.targetId,!1,n.resumeToken),pa(r.remoteStore,n)}for(const e of n)r.pa.has(e)&&await Ro(r.localStore,e,!1).then((()=>{ya(r.remoteStore,e),_c(r,e)})).catch(ne)}}function Vc(e){const t=v(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=mc.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=Dc.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=pc.bind(null,t),t.fa.u_=Ja.bind(null,t.eventManager),t.fa.xa=Xa.bind(null,t.eventManager),t}function Oc(e){const t=v(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=yc.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=wc.bind(null,t),t}class qc{constructor(){this.synchronizeTabs=!1}async initialize(e){this.serializer=oa(e.databaseInfo.databaseId),this.sharedClientState=this.createSharedClientState(e),this.persistence=this.createPersistence(e),await this.persistence.start(),this.localStore=this.createLocalStore(e),this.gcScheduler=this.createGarbageCollectionScheduler(e,this.localStore),this.indexBackfillerScheduler=this.createIndexBackfillerScheduler(e,this.localStore)}createGarbageCollectionScheduler(e,t){return null}createIndexBackfillerScheduler(e,t){return null}createLocalStore(e){return Do(this.persistence,new xo,e.initialUser,this.serializer)}createPersistence(e){return new fo(go.Hr,this.serializer)}createSharedClientState(e){return new Yo}async terminate(){var e,t;null===(e=this.gcScheduler)||void 0===e||e.stop(),null===(t=this.indexBackfillerScheduler)||void 0===t||t.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class Uc extends qc{constructor(e){super(),this.cacheSizeBytes=e}createGarbageCollectionScheduler(e,t){w(this.persistence.referenceDelegate instanceof po);const n=this.persistence.referenceDelegate.garbageCollector;return new zi(n,e.asyncQueue,t)}createPersistence(e){const t=void 0!==this.cacheSizeBytes?Ci.withCacheSize(this.cacheSizeBytes):Ci.DEFAULT;return new fo((e=>po.Hr(e,t)),this.serializer)}}class Bc extends qc{constructor(e,t,n){super(),this.Na=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.Na.initialize(this,e),await Oc(this.Na.syncEngine),await Na(this.Na.remoteStore),await this.persistence.fi((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve())))}createLocalStore(e){return Do(this.persistence,new xo,e.initialUser,this.serializer)}createGarbageCollectionScheduler(e,t){const n=this.persistence.referenceDelegate.garbageCollector;return new zi(n,e.asyncQueue,t)}createIndexBackfillerScheduler(e,t){const n=new me(t,this.persistence);return new fe(e.asyncQueue,n)}createPersistence(e){const t=Eo(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Ci.withCacheSize(this.cacheSizeBytes):Ci.DEFAULT;return new Io(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,sa(),ia(),this.serializer,this.sharedClientState,!!this.forceOwnership)}createSharedClientState(e){return new Yo}}class zc extends Bc{constructor(e,t){super(e,t,!1),this.Na=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);const t=this.Na.syncEngine;this.sharedClientState instanceof Wo&&(this.sharedClientState.syncEngine={Zs:kc.bind(null,t),Xs:Fc.bind(null,t),eo:Pc.bind(null,t),Li:Rc.bind(null,t),Ys:Ac.bind(null,t)},await this.sharedClientState.start()),await this.persistence.fi((async e=>{await async function(e,t){const n=v(e);if(Vc(n),Oc(n),!0===t&&!0!==n.Fa){const e=n.sharedClientState.getAllActiveQueryTargets(),t=await Mc(n,e.toArray());n.Fa=!0,await qa(n.remoteStore,!0);for(const r of t)pa(n.remoteStore,r)}else if(!1===t&&!1!==n.Fa){const e=[];let t=Promise.resolve();n.pa.forEach(((r,s)=>{n.sharedClientState.isLocalQueryTarget(s)?e.push(s):t=t.then((()=>(_c(n,s),Ro(n.localStore,s,!0)))),ya(n.remoteStore,s)})),await t,await Mc(n,e),function(e){const t=v(e);t.Sa.forEach(((e,n)=>{ya(t.remoteStore,n)})),t.ba.mr(),t.Sa=new Map,t.wa=new Je(z.comparator)}(n),n.Fa=!1,await qa(n.remoteStore,!1)}}(this.Na.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())}))}createSharedClientState(e){const t=sa();if(!Wo.D(t))throw new _(I.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=Eo(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new Wo(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class Gc{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>gc(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=Cc.bind(null,this.syncEngine),await qa(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new Wa}createDatastore(e){const t=oa(e.databaseInfo.databaseId),n=function(e){return new ra(e)}(e.databaseInfo);return function(e,t,n,r){return new ha(e,t,n,r)}(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){return function(e,t,n,r,s){return new fa(e,t,n,r,s)}(this.localStore,this.datastore,e.asyncQueue,(e=>gc(this.syncEngine,e,0)),Jo.D()?new Jo:new Ho)}createSyncEngine(e,t){return function(e,t,n,r,s,i,o){const a=new lc(e,t,n,r,s,i);return o&&(a.Fa=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}async terminate(){var e;await async function(e){const t=v(e);f("RemoteStore","RemoteStore shutting down."),t.v_.add(5),await ga(t),t.M_.shutdown(),t.x_.set("Unknown")}(this.remoteStore),null===(e=this.datastore)||void 0===e||e.terminate()}}function Kc(e,t=10240){let n=0;return{async read(){if(n<e.byteLength){const r={value:e.slice(n,n+t),done:!1};return n+=t,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.resolve()}}class $c{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Ba(this.observer.next,e)}error(e){this.observer.error?this.Ba(this.observer.error,e):m("Uncaught Error in snapshot listener:",e.toString())}La(){this.muted=!0}Ba(e,t){this.muted||setTimeout((()=>{this.muted||e(t)}),0)}}class Qc{constructor(e,t){this.ka=e,this.serializer=t,this.metadata=new b,this.buffer=new Uint8Array,this.qa=new TextDecoder("utf-8"),this.Qa().then((e=>{e&&e.ea()?this.metadata.resolve(e.X_.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.X_)}`))}),(e=>this.metadata.reject(e)))}close(){return this.ka.cancel()}async getMetadata(){return this.metadata.promise}async Oa(){return await this.getMetadata(),this.Qa()}async Qa(){const e=await this.Ka();if(null===e)return null;const t=this.qa.decode(e),n=Number(t);isNaN(n)&&this.$a(`length string (${t}) is not valid number`);const r=await this.Ua(n);return new tc(JSON.parse(r),e.length+n)}Wa(){return this.buffer.findIndex((e=>e==="{".charCodeAt(0)))}async Ka(){for(;this.Wa()<0&&!await this.Ga(););if(0===this.buffer.length)return null;const e=this.Wa();e<0&&this.$a("Reached the end of bundle when a length string is expected.");const t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async Ua(e){for(;this.buffer.length<e;)await this.Ga()&&this.$a("Reached the end of bundle when more is expected.");const t=this.qa.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}$a(e){throw this.ka.cancel(),new Error(`Invalid bundle format: ${e}`)}async Ga(){const e=await this.ka.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class jc{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastTransactionError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw this.lastTransactionError=new _(I.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes."),this.lastTransactionError;const t=await async function(e,t){const n=v(e),r={documents:t.map((e=>hs(n.serializer,e)))},s=await n.vo("BatchGetDocuments",n.serializer.databaseId,q.emptyPath(),r,t.length),i=new Map;s.forEach((e=>{const t=function(e,t){return"found"in t?function(e,t){w(!!t.found),t.found.name,t.found.updateTime;const n=ds(e,t.found.name),r=as(t.found.updateTime),s=t.found.createTime?as(t.found.createTime):V.min(),i=new Vt({mapValue:{fields:t.found.fields}});return qt.newFoundDocument(n,r,s,i)}(e,t):"missing"in t?function(e,t){w(!!t.missing),w(!!t.readTime);const n=ds(e,t.missing),r=as(t.readTime);return qt.newNoDocument(n,r)}(e,t):y()}(n.serializer,e);i.set(t.key.toString(),t)}));const o=[];return t.forEach((e=>{const t=i.get(e.toString());w(!!t),o.push(t)})),o}(this.datastore,e);return t.forEach((e=>this.recordVersion(e))),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastTransactionError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new xr(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastTransactionError)throw this.lastTransactionError;const e=this.readVersions;this.mutations.forEach((t=>{e.delete(t.key.toString())})),e.forEach(((e,t)=>{const n=z.fromPath(t);this.mutations.push(new Cr(n,this.precondition(n)))})),await async function(e,t){const n=v(e),r={writes:t.map((e=>vs(n.serializer,e)))};await n.So("Commit",n.serializer.databaseId,q.emptyPath(),r)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw y();t=V.min()}const n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new _(I.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?t.isEqual(V.min())?fr.exists(!1):fr.updateTime(t):fr.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(V.min()))throw new _(I.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return fr.updateTime(t)}return fr.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class Wc{constructor(e,t,n,r,s){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=s,this.za=n.maxAttempts,this.jo=new aa(this.asyncQueue,"transaction_retry")}ja(){this.za-=1,this.Ha()}Ha(){this.jo.qo((async()=>{const e=new jc(this.datastore),t=this.Ja(e);t&&t.then((t=>{this.asyncQueue.enqueueAndForget((()=>e.commit().then((()=>{this.deferred.resolve(t)})).catch((e=>{this.Ya(e)}))))})).catch((e=>{this.Ya(e)}))}))}Ja(e){try{const t=this.updateFunction(e);return!pe(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}Ya(e){this.za>0&&this.Za(e)?(this.za-=1,this.asyncQueue.enqueueAndForget((()=>(this.Ha(),Promise.resolve())))):this.deferred.reject(e)}Za(e){if("FirebaseError"===e.name){const t=e.code;return"aborted"===t||"failed-precondition"===t||"already-exists"===t||!Fr(t)}return!1}}class Yc{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=u.UNAUTHENTICATED,this.clientId=M.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async e=>{f("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e})),this.appCheckCredentials.start(n,(e=>(f("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user))))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new _(I.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const e=new b;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){const n=Ga(t,"Failed to shutdown persistence");e.reject(n)}})),e.promise}}async function Hc(e,t){e.asyncQueue.verifyOperationInProgress(),f("FirestoreClient","Initializing OfflineComponentProvider");const n=e.configuration;await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener((async e=>{r.isEqual(e)||(await No(t.localStore,e),r=e)})),t.persistence.setDatabaseDeletedListener((()=>e.terminate())),e._offlineComponents=t}async function Jc(e,t){e.asyncQueue.verifyOperationInProgress();const n=await Zc(e);f("FirestoreClient","Initializing OnlineComponentProvider"),await t.initialize(n,e.configuration),e.setCredentialChangeListener((e=>Oa(t.remoteStore,e))),e.setAppCheckTokenChangeListener(((e,n)=>Oa(t.remoteStore,n))),e._onlineComponents=t}function Xc(e){return"FirebaseError"===e.name?e.code===I.FAILED_PRECONDITION||e.code===I.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||22===e.code||20===e.code||11===e.code}async function Zc(e){if(!e._offlineComponents)if(e._uninitializedComponentsProvider){f("FirestoreClient","Using user provided OfflineComponentProvider");try{await Hc(e,e._uninitializedComponentsProvider._offline)}catch(t){const n=t;if(!Xc(n))throw n;g("Error using user provided cache. Falling back to memory cache: "+n),await Hc(e,new qc)}}else f("FirestoreClient","Using default OfflineComponentProvider"),await Hc(e,new qc);return e._offlineComponents}async function eu(e){return e._onlineComponents||(e._uninitializedComponentsProvider?(f("FirestoreClient","Using user provided OnlineComponentProvider"),await Jc(e,e._uninitializedComponentsProvider._online)):(f("FirestoreClient","Using default OnlineComponentProvider"),await Jc(e,new Gc))),e._onlineComponents}function tu(e){return Zc(e).then((e=>e.persistence))}function nu(e){return Zc(e).then((e=>e.localStore))}function ru(e){return eu(e).then((e=>e.remoteStore))}function su(e){return eu(e).then((e=>e.syncEngine))}function iu(e){return eu(e).then((e=>e.datastore))}async function ou(e){const t=await eu(e),n=t.eventManager;return n.onListen=hc.bind(null,t.syncEngine),n.onUnlisten=fc.bind(null,t.syncEngine),n}function au(e,t,n={}){const r=new b;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,s){const i=new $c({next:i=>{t.enqueueAndForget((()=>Ha(e,o)));const a=i.docs.has(n);!a&&i.fromCache?s.reject(new _(I.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&i.fromCache&&r&&"server"===r.source?s.reject(new _(I.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):s.resolve(i)},error:e=>s.reject(e)}),o=new ec(_n(n.path),i,{includeMetadataChanges:!0,Z_:!0});return Ya(e,o)}(await ou(e),e.asyncQueue,t,n,r))),r.promise}function cu(e,t,n={}){const r=new b;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,s){const i=new $c({next:n=>{t.enqueueAndForget((()=>Ha(e,o))),n.fromCache&&"server"===r.source?s.reject(new _(I.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(n)},error:e=>s.reject(e)}),o=new ec(n,i,{includeMetadataChanges:!0,Z_:!0});return Ya(e,o)}(await ou(e),e.asyncQueue,t,n,r))),r.promise}function uu(e,t,n,r){const s=function(e,t){let n;return n="string"==typeof e?Or().encode(e):e,function(e,t){return new Qc(e,t)}(function(e,t){if(e instanceof Uint8Array)return Kc(e,t);if(e instanceof ArrayBuffer)return Kc(new Uint8Array(e),t);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),t)}(n,oa(t));e.asyncQueue.enqueueAndForget((async()=>{!function(e,t,n){const r=v(e);(async function(e,t,n){try{const r=await t.getMetadata();if(await function(e,t){const n=v(e),r=as(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(e=>n.$r.getBundleMetadata(e,t.id))).then((e=>!!e&&e.createTime.compareTo(r)>=0))}(e.localStore,r))return await t.close(),n._completeWith(function(e){return{taskState:"Success",documentsLoaded:e.totalDocuments,bytesLoaded:e.totalBytes,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}(r)),Promise.resolve(new Set);n._updateProgress(sc(r));const s=new rc(r,e.localStore,t.serializer);let i=await t.Oa();for(;i;){const e=await s.na(i);e&&n._updateProgress(e),i=await t.Oa()}const o=await s.complete();return await xc(e,o.sa,void 0),await function(e,t){const n=v(e);return n.persistence.runTransaction("Save bundle","readwrite",(e=>n.$r.saveBundleMetadata(e,t)))}(e.localStore,r),n._completeWith(o.progress),Promise.resolve(o.ia)}catch(e){return g("SyncEngine",`Loading bundle failed with ${e}`),n._failWith(e),Promise.resolve(new Set)}})(r,t,n).then((e=>{r.sharedClientState.notifyBundleLoaded(e)}))}(await su(e),s,r)}))}function lu(e){const t={};return void 0!==e.timeoutSeconds&&(t.timeoutSeconds=e.timeoutSeconds),t}const hu=new Map;function du(e,t,n){if(!n)throw new _(I.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function fu(e,t,n,r){if(!0===t&&!0===r)throw new _(I.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function mu(e){if(!z.isDocumentKey(e))throw new _(I.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function gu(e){if(z.isDocumentKey(e))throw new _(I.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function pu(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{const t=function(e){return e.constructor?e.constructor.name:null}(e);return t?`a custom ${t} object`:"an object"}}return"function"==typeof e?"a function":y()}function yu(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new _(I.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=pu(e);throw new _(I.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}function wu(e,t){if(t<=0)throw new _(I.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class vu{constructor(e){var t,n;if(void 0===e.host){if(void 0!==e.ssl)throw new _(I.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,this.localCache=e.localCache,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new _(I.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}fu("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:void 0===e.experimentalAutoDetectLongPolling?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=lu(null!==(n=e.experimentalLongPollingOptions)&&void 0!==n?n:{}),function(e){if(void 0!==e.timeoutSeconds){if(isNaN(e.timeoutSeconds))throw new _(I.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (must not be NaN)`);if(e.timeoutSeconds<5)throw new _(I.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (minimum allowed value is 5)`);if(e.timeoutSeconds>30)throw new _(I.INVALID_ARGUMENT,`invalid long polling timeout: ${e.timeoutSeconds} (maximum allowed value is 30)`)}}(this.experimentalLongPollingOptions),this.useFetchStreams=!!e.useFetchStreams}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&function(e,t){return e.timeoutSeconds===t.timeoutSeconds}(this.experimentalLongPollingOptions,e.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class Iu{constructor(e,t,n,r){this._authCredentials=e,this._appCheckCredentials=t,this._databaseId=n,this._app=r,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new vu({}),this._settingsFrozen=!1}get app(){if(!this._app)throw new _(I.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new _(I.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new vu(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new T;switch(e.type){case"firstParty":return new D(e.sessionIndex||"0",e.iamToken||null,e.authTokenFactory||null);case"provider":return e.client;default:throw new _(I.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=hu.get(e);t&&(f("ComponentProvider","Removing Datastore"),hu.delete(e),t.terminate())}(this),Promise.resolve()}}function _u(e,t,n,r={}){var s;const i=(e=yu(e,Iu))._getSettings(),a=`${t}:${n}`;if("firestore.googleapis.com"!==i.host&&i.host!==a&&g("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),e._setSettings(Object.assign(Object.assign({},i),{host:a,ssl:!1})),r.mockUserToken){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=u.MOCK_USER;else{t=o.createMockUserToken(r.mockUserToken,null===(s=e._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new _(I.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new u(i)}e._authCredentials=new S(new E(t,n))}}class bu{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new bu(this.firestore,e,this._query)}}class Eu{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Tu(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Eu(this.firestore,e,this._key)}}class Tu extends bu{constructor(e,t,n){super(e,t,_n(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Eu(this.firestore,null,new z(e))}withConverter(e){return new Tu(this.firestore,e,this._path)}}function Su(e,t,...n){if(e=o.getModularInstance(e),1===arguments.length&&(t=M.newId()),du("doc","path",t),e instanceof Iu){const r=q.fromString(t,...n);return mu(r),new Eu(e,null,new z(r))}{if(!(e instanceof Eu||e instanceof Tu))throw new _(I.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(q.fromString(t,...n));return mu(r),new Eu(e.firestore,e instanceof Tu?e.converter:null,new z(r))}}function xu(e,t){return e=o.getModularInstance(e),t=o.getModularInstance(t),e instanceof bu&&t instanceof bu&&e.firestore===t.firestore&&Nn(e._query,t._query)&&e.converter===t.converter}class Cu{constructor(){this.Xa=Promise.resolve(),this.eu=[],this.tu=!1,this.nu=[],this.ru=null,this.iu=!1,this.su=!1,this.ou=[],this.jo=new aa(this,"async_queue_retry"),this._u=()=>{const e=ia();e&&f("AsyncQueue","Visibility state changed to "+e.visibilityState),this.jo.Ko()};const e=ia();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this._u)}get isShuttingDown(){return this.tu}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.au(),this.uu(e)}enterRestrictedMode(e){if(!this.tu){this.tu=!0,this.su=e||!1;const t=ia();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this._u)}}enqueue(e){if(this.au(),this.tu)return new Promise((()=>{}));const t=new b;return this.uu((()=>this.tu&&this.su?Promise.resolve():(e().then(t.resolve,t.reject),t.promise))).then((()=>t.promise))}enqueueRetryable(e){this.enqueueAndForget((()=>(this.eu.push(e),this.cu())))}async cu(){if(0!==this.eu.length){try{await this.eu[0](),this.eu.shift(),this.jo.reset()}catch(e){if(!ce(e))throw e;f("AsyncQueue","Operation failed with retryable error: "+e)}this.eu.length>0&&this.jo.qo((()=>this.cu()))}}uu(e){const t=this.Xa.then((()=>(this.iu=!0,e().catch((e=>{this.ru=e,this.iu=!1;const t=function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e);throw m("INTERNAL UNHANDLED ERROR: ",t),e})).then((e=>(this.iu=!1,e))))));return this.Xa=t,t}enqueueAfterDelay(e,t,n){this.au(),this.ou.indexOf(e)>-1&&(t=0);const r=za.createAndSchedule(this,e,t,n,(e=>this.lu(e)));return this.nu.push(r),r}au(){this.ru&&y()}verifyOperationInProgress(){}async hu(){let e;do{e=this.Xa,await e}while(e!==this.Xa)}Pu(e){for(const t of this.nu)if(t.timerId===e)return!0;return!1}Iu(e){return this.hu().then((()=>{this.nu.sort(((e,t)=>e.targetTimeMs-t.targetTimeMs));for(const t of this.nu)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.hu()}))}Tu(e){this.ou.push(e)}lu(e){const t=this.nu.indexOf(e);this.nu.splice(t,1)}}function Du(e){return function(e,t){if("object"!=typeof e||null===e)return!1;const n=e;for(const r of t)if(r in n&&"function"==typeof n[r])return!0;return!1}(e,["next","error","complete"])}class Nu{constructor(){this._progressObserver={},this._taskCompletionResolver=new b,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}class Au extends Iu{constructor(e,t,n,r){super(e,t,n,r),this.type="firestore",this._queue=new Cu,this._persistenceKey=(null==r?void 0:r.name)||"[DEFAULT]"}_terminate(){return this._firestoreClient||Mu(this),this._firestoreClient.terminate()}}function ku(e){return e._firestoreClient||Mu(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function Mu(e){var t,n,r;const s=e._freezeSettings(),i=function(e,t,n,r){return new ft(e,t,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,lu(r.experimentalLongPollingOptions),r.useFetchStreams)}(e._databaseId,(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",e._persistenceKey,s);e._firestoreClient=new Yc(e._authCredentials,e._appCheckCredentials,e._queue,i),(null===(n=s.localCache)||void 0===n?void 0:n._offlineComponentProvider)&&(null===(r=s.localCache)||void 0===r?void 0:r._onlineComponentProvider)&&(e._firestoreClient._uninitializedComponentsProvider={_offlineKind:s.localCache.kind,_offline:s.localCache._offlineComponentProvider,_online:s.localCache._onlineComponentProvider})}function Lu(e,t,n){const r=new b;return e.asyncQueue.enqueue((async()=>{try{await Hc(e,n),await Jc(e,t),r.resolve()}catch(e){const n=e;if(!Xc(n))throw n;g("Error enabling indexeddb cache. Falling back to memory cache: "+n),r.reject(n)}})).then((()=>r.promise))}function Ru(e){if(e._initialized||e._terminated)throw new _(I.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class Fu{constructor(e="count",t){this._internalFieldPath=t,this.type="AggregateField",this.aggregateType=e}}class Pu{constructor(e,t,n){this._userDataWriter=t,this._data=n,this.type="AggregateQuerySnapshot",this.query=e}data(){return this._userDataWriter.convertObjectMap(this._data)}}class Vu{constructor(e){this._byteString=e}static fromBase64String(e){try{return new Vu(it.fromBase64String(e))}catch(e){throw new _(I.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new Vu(it.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class Ou{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new _(I.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new B(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class qu{constructor(e){this._methodName=e}}class Uu{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new _(I.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new _(I.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return L(this._lat,e._lat)||L(this._long,e._long)}}const Bu=/^__.*__$/;class zu{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new br(e,this.data,this.fieldMask,t,this.fieldTransforms):new _r(e,this.data,t,this.fieldTransforms)}}class Gu{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new br(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function Ku(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw y()}}class $u{constructor(e,t,n,r,s,i){this.settings=e,this.databaseId=t,this.serializer=n,this.ignoreUndefinedProperties=r,void 0===s&&this.Eu(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get du(){return this.settings.du}Au(e){return new $u(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Ru(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.Au({path:n,Vu:!1});return r.mu(e),r}fu(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.Au({path:n,Vu:!1});return r.Eu(),r}gu(e){return this.Au({path:void 0,Vu:!0})}pu(e){return hl(e,this.settings.methodName,this.settings.yu||!1,this.path,this.settings.wu)}contains(e){return void 0!==this.fieldMask.find((t=>e.isPrefixOf(t)))||void 0!==this.fieldTransforms.find((t=>e.isPrefixOf(t.field)))}Eu(){if(this.path)for(let e=0;e<this.path.length;e++)this.mu(this.path.get(e))}mu(e){if(0===e.length)throw this.pu("Document fields must not be empty");if(Ku(this.du)&&Bu.test(e))throw this.pu('Document fields cannot begin and end with "__"')}}class Qu{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.serializer=n||oa(e)}Su(e,t,n,r=!1){return new $u({du:e,methodName:t,wu:n,path:B.emptyPath(),Vu:!1,yu:r},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function ju(e){const t=e._freezeSettings(),n=oa(e._databaseId);return new Qu(e._databaseId,!!t.ignoreUndefinedProperties,n)}function Wu(e,t,n,r,s,i={}){const o=e.Su(i.merge||i.mergeFields?2:0,t,n,s);al("Data must be an object, but it was:",o,r);const a=il(r,o);let c,u;if(i.merge)c=new rt(o.fieldMask),u=o.fieldTransforms;else if(i.mergeFields){const e=[];for(const r of i.mergeFields){const s=cl(t,r,n);if(!o.contains(s))throw new _(I.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);dl(e,s)||e.push(s)}c=new rt(e),u=o.fieldTransforms.filter((e=>c.covers(e.field)))}else c=null,u=o.fieldTransforms;return new zu(new Vt(a),c,u)}class Yu extends qu{_toFieldTransform(e){if(2!==e.du)throw 1===e.du?e.pu(`${this._methodName}() can only appear at the top level of your update data`):e.pu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof Yu}}function Hu(e,t,n){return new $u({du:3,wu:t.settings.wu,methodName:e._methodName,Vu:n},t.databaseId,t.serializer,t.ignoreUndefinedProperties)}class Ju extends qu{_toFieldTransform(e){return new hr(e.path,new rr)}isEqual(e){return e instanceof Ju}}class Xu extends qu{constructor(e,t){super(e),this.bu=t}_toFieldTransform(e){const t=Hu(this,e,!0),n=this.bu.map((e=>sl(e,t))),r=new sr(n);return new hr(e.path,r)}isEqual(e){return e instanceof Xu&&o.deepEqual(this.bu,e.bu)}}class Zu extends qu{constructor(e,t){super(e),this.bu=t}_toFieldTransform(e){const t=Hu(this,e,!0),n=this.bu.map((e=>sl(e,t))),r=new or(n);return new hr(e.path,r)}isEqual(e){return e instanceof Zu&&o.deepEqual(this.bu,e.bu)}}class el extends qu{constructor(e,t){super(e),this.Du=t}_toFieldTransform(e){const t=new cr(e.serializer,Xn(e.serializer,this.Du));return new hr(e.path,t)}isEqual(e){return e instanceof el&&this.Du===e.Du}}function tl(e,t,n,r){const s=e.Su(1,t,n);al("Data must be an object, but it was:",s,r);const i=[],a=Vt.empty();Ye(r,((e,r)=>{const c=ll(t,e,n);r=o.getModularInstance(r);const u=s.fu(c);if(r instanceof Yu)i.push(c);else{const e=sl(r,u);null!=e&&(i.push(c),a.set(c,e))}}));const c=new rt(i);return new Gu(a,c,s.fieldTransforms)}function nl(e,t,n,r,s,i){const a=e.Su(1,t,n),c=[cl(t,r,n)],u=[s];if(i.length%2!=0)throw new _(I.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let o=0;o<i.length;o+=2)c.push(cl(t,i[o])),u.push(i[o+1]);const l=[],h=Vt.empty();for(let f=c.length-1;f>=0;--f)if(!dl(l,c[f])){const e=c[f];let t=u[f];t=o.getModularInstance(t);const n=a.fu(e);if(t instanceof Yu)l.push(e);else{const r=sl(t,n);null!=r&&(l.push(e),h.set(e,r))}}const d=new rt(l);return new Gu(h,d,a.fieldTransforms)}function rl(e,t,n,r=!1){return sl(n,e.Su(r?4:3,t))}function sl(e,t){if(ol(e=o.getModularInstance(e)))return al("Unsupported field value:",t,e),il(e,t);if(e instanceof qu)return function(e,t){if(!Ku(t.du))throw t.pu(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.pu(`${e._methodName}() is not currently supported inside arrays`);const n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.Vu&&4!==t.du)throw t.pu("Nested arrays are not supported");return function(e,t){const n=[];let r=0;for(const s of e){let e=sl(s,t.gu(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=o.getModularInstance(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return Xn(t.serializer,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){const n=P.fromDate(e);return{timestampValue:ss(t.serializer,n)}}if(e instanceof P){const n=new P(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:ss(t.serializer,n)}}if(e instanceof Uu)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof Vu)return{bytesValue:is(t.serializer,e._byteString)};if(e instanceof Eu){const n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.pu(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:cs(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.pu(`Unsupported field value: ${pu(e)}`)}(e,t)}function il(e,t){const n={};return He(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):Ye(e,((e,r)=>{const s=sl(r,t.Ru(e));null!=s&&(n[e]=s)})),{mapValue:{fields:n}}}function ol(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof P||e instanceof Uu||e instanceof Vu||e instanceof Eu||e instanceof qu)}function al(e,t,n){if(!ol(n)||!function(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}(n)){const r=pu(n);throw"an object"===r?t.pu(e+" a custom object"):t.pu(e+" "+r)}}function cl(e,t,n){if((t=o.getModularInstance(t))instanceof Ou)return t._internalPath;if("string"==typeof t)return ll(e,t);throw hl("Field path arguments must be of type string or ",e,!1,void 0,n)}const ul=new RegExp("[~\\*/\\[\\]]");function ll(e,t,n){if(t.search(ul)>=0)throw hl(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new Ou(...t.split("."))._internalPath}catch(r){throw hl(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function hl(e,t,n,r,s){const i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${t}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let c="";return(i||o)&&(c+=" (found",i&&(c+=` in field ${r}`),o&&(c+=` in document ${s}`),c+=")"),new _(I.INVALID_ARGUMENT,a+e+c)}function dl(e,t){return e.some((e=>e.isEqual(t)))}class fl{constructor(e,t,n,r,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new Eu(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new ml(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(gl("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class ml extends fl{data(){return super.data()}}function gl(e,t){return"string"==typeof t?ll(e,t):t instanceof Ou?t._internalPath:t._delegate._internalPath}function pl(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new _(I.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class yl{}class wl extends yl{}class vl extends wl{constructor(e,t,n){super(),this._field=e,this._op=t,this._value=n,this.type="where"}static _create(e,t,n){return new vl(e,t,n)}_apply(e){const t=this._parse(e);return Dl(e._query,t),new bu(e.firestore,e.converter,Cn(e._query,t))}_parse(e){const t=ju(e.firestore),n=function(e,t,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new _(I.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){Cl(o,i);const t=[];for(const n of o)t.push(xl(r,e,n));a={arrayValue:{values:t}}}else a=xl(r,e,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||Cl(o,i),a=rl(n,t,o,"in"===i||"not-in"===i);return Qt.create(s,i,a)}(e._query,"where",t,e.firestore._databaseId,this._field,this._op,this._value);return n}}class Il extends yl{constructor(e,t){super(),this.type=e,this._queryConstraints=t}static _create(e,t){return new Il(e,t)}_parse(e){const t=this._queryConstraints.map((t=>t._parse(e))).filter((e=>e.getFilters().length>0));return 1===t.length?t[0]:jt.create(t,this._getOperator())}_apply(e){const t=this._parse(e);return 0===t.getFilters().length?e:(function(e,t){let n=e;const r=t.getFlattenedFilters();for(const s of r)Dl(n,s),n=Cn(n,s)}(e._query,t),new bu(e.firestore,e.converter,Cn(e._query,t)))}_getQueryConstraints(){return this._queryConstraints}_getOperator(){return"and"===this.type?"and":"or"}}class _l extends wl{constructor(e,t){super(),this._field=e,this._direction=t,this.type="orderBy"}static _create(e,t){return new _l(e,t)}_apply(e){const t=function(e,t,n){if(null!==e.startAt)throw new _(I.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new _(I.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");return new Gt(t,n)}(e._query,this._field,this._direction);return new bu(e.firestore,e.converter,function(e,t){const n=e.explicitOrderBy.concat([t]);return new vn(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}class bl extends wl{constructor(e,t,n){super(),this.type=e,this._limit=t,this._limitType=n}static _create(e,t,n){return new bl(e,t,n)}_apply(e){return new bu(e.firestore,e.converter,Dn(e._query,this._limit,this._limitType))}}class El extends wl{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new El(e,t,n)}_apply(e){const t=Sl(e,this.type,this._docOrFields,this._inclusive);return new bu(e.firestore,e.converter,function(e,t){return new vn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,t,e.endAt)}(e._query,t))}}class Tl extends wl{constructor(e,t,n){super(),this.type=e,this._docOrFields=t,this._inclusive=n}static _create(e,t,n){return new Tl(e,t,n)}_apply(e){const t=Sl(e,this.type,this._docOrFields,this._inclusive);return new bu(e.firestore,e.converter,function(e,t){return new vn(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,t)}(e._query,t))}}function Sl(e,t,n,r){if(n[0]=o.getModularInstance(n[0]),n[0]instanceof fl)return function(e,t,n,r,s){if(!r)throw new _(I.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const o of Tn(e))if(o.field.isKeyField())i.push(St(t,r.key));else{const e=r.data.field(o.field);if(lt(e))throw new _(I.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+o.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=o.field.canonicalString();throw new _(I.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}i.push(e)}return new Ut(i,s)}(e._query,e.firestore._databaseId,t,n[0]._document,r);{const s=ju(e.firestore);return function(e,t,n,r,s,i){const o=e.explicitOrderBy;if(s.length>o.length)throw new _(I.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let c=0;c<s.length;c++){const i=s[c];if(o[c].field.isKeyField()){if("string"!=typeof i)throw new _(I.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof i}`);if(!En(e)&&-1!==i.indexOf("/"))throw new _(I.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${i}' contains a slash.`);const n=e.path.child(q.fromString(i));if(!z.isDocumentKey(n))throw new _(I.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new z(n);a.push(St(t,s))}else{const e=rl(n,r,i);a.push(e)}}return new Ut(a,i)}(e._query,e.firestore._databaseId,s,t,n,r)}}function xl(e,t,n){if("string"==typeof(n=o.getModularInstance(n))){if(""===n)throw new _(I.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!En(t)&&-1!==n.indexOf("/"))throw new _(I.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=t.path.child(q.fromString(n));if(!z.isDocumentKey(r))throw new _(I.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return St(e,new z(r))}if(n instanceof Eu)return St(e,n._key);throw new _(I.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${pu(n)}.`)}function Cl(e,t){if(!Array.isArray(e)||0===e.length)throw new _(I.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`)}function Dl(e,t){const n=function(e,t){for(const n of e)for(const e of n.getFlattenedFilters())if(t.indexOf(e.op)>=0)return e.op;return null}(e.filters,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains-any":case"in":return["not-in"];case"not-in":return["array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new _(I.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new _(I.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}function Nl(e,t){if(!(t instanceof vl||t instanceof Il))throw new _(I.INVALID_ARGUMENT,`Function ${e}() requires AppliableConstraints created with a call to 'where(...)', 'or(...)', or 'and(...)'.`)}class Al{convertValue(e,t="none"){switch(yt(e)){case 0:return null;case 1:return e.booleanValue;case 2:return ct(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(ut(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw y()}}convertObject(e,t){return this.convertObjectMap(e.fields,t)}convertObjectMap(e,t="none"){const n={};return Ye(e,((e,r)=>{n[e]=this.convertValue(r,t)})),n}convertGeoPoint(e){return new Uu(ct(e.latitude),ct(e.longitude))}convertArray(e,t){return(e.values||[]).map((e=>this.convertValue(e,t)))}convertServerTimestamp(e,t){switch(t){case"previous":const n=ht(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(dt(e));default:return null}}convertTimestamp(e){const t=at(e);return new P(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=q.fromString(e);w(Ms(n));const r=new mt(n.get(1),n.get(3)),s=new z(n.popFirst(5));return r.isEqual(t)||m(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function kl(e,t,n){let r;return r=e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t,r}class Ml extends Al{constructor(e){super(),this.firestore=e}convertBytes(e){return new Vu(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new Eu(this.firestore,null,t)}}function Ll(){return new Fu("count")}class Rl{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Fl extends fl{constructor(e,t,n,r,s,i){super(e,t,n,r,i),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new Pl(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const n=this._document.data.field(gl("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class Pl extends Fl{data(e={}){return super.data(e)}}class Vl{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new Rl(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const e=[];return this.forEach((t=>e.push(t))),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach((n=>{e.call(t,new Pl(this._firestore,this._userDataWriter,n.key,n,new Rl(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(e={}){const t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new _(I.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map((n=>{const r=new Pl(e._firestore,e._userDataWriter,n.doc.key,n.doc,new Rl(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter);return n.doc,{type:"added",doc:r,oldIndex:-1,newIndex:t++}}))}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter((e=>t||3!==e.type)).map((t=>{const r=new Pl(e._firestore,e._userDataWriter,t.doc.key,t.doc,new Rl(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter);let s=-1,i=-1;return 0!==t.type&&(s=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(n=n.add(t.doc),i=n.indexOf(t.doc.key)),{type:Ol(t.type),doc:r,oldIndex:s,newIndex:i}}))}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function Ol(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return y()}}class ql extends Al{constructor(e){super(),this.firestore=e}convertBytes(e){return new Vu(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new Eu(this.firestore,null,t)}}function Ul(e,t){return function(e,t){const n=new b;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){const r=Oc(e);try{const e=await function(e,t){const n=v(e),r=P.now(),s=t.reduce(((e,t)=>e.add(t.key)),jn());let i,o;return n.persistence.runTransaction("Locally write mutations","readwrite",(e=>{let a=On(),c=jn();return n.os.getEntries(e,s).next((e=>{a=e,a.forEach(((e,t)=>{t.isValidDocument()||(c=c.add(e))}))})).next((()=>n.localDocuments.getOverlayedDocuments(e,a))).next((s=>{i=s;const o=[];for(const e of t){const t=vr(e,i.get(e.key).overlayedDocument);null!=t&&o.push(new br(e.key,t,Ot(t.value.mapValue),fr.exists(!0)))}return n.mutationQueue.addMutationBatch(e,r,o,t)})).next((t=>{o=t;const r=t.applyToLocalDocumentSet(i,c);return n.documentOverlayCache.saveOverlays(e,t.batchId,r)}))})).then((()=>({batchId:o.batchId,changes:Bn(i)})))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.Da[e.currentUser.toKey()];r||(r=new Je(L)),r=r.insert(t,n),e.Da[e.currentUser.toKey()]=r}(r,e.batchId,n),await xc(r,e.changes),await Na(r.remoteStore)}catch(e){const t=Ga(e,"Failed to persist write");n.reject(t)}}(await su(e),t,n))),n.promise}(ku(e),t)}function Bl(e,t,n){const r=n.docs.get(t._key),s=new ql(e);return new Fl(e,s,t._key,r,new Rl(n.hasPendingWrites,n.fromCache),t.converter)}function zl(e,t){const n=yu(e.firestore,Au),r=ku(n),s=function(e,t){const n=[];for(const r in e)Object.prototype.hasOwnProperty.call(e,r)&&n.push(t(e[r],r,e));return n}(t,((e,t)=>new kr(t,e.aggregateType,e._internalFieldPath)));return function(e,t,n){const r=new b;return e.asyncQueue.enqueueAndForget((async()=>{try{const s=await iu(e);r.resolve(async function(e,t,n){var r;const s=v(e),{request:i,V_:o,parent:a}=function(e,t,n){const{ut:r,parent:s}=bs(e,t),i={},o=[];let a=0;return n.forEach((e=>{const t="aggregate_"+a++;i[t]=e.alias,"count"===e.aggregateType?o.push({alias:t,count:{}}):"avg"===e.aggregateType?o.push({alias:t,avg:{field:Ds(e.fieldPath)}}):"sum"===e.aggregateType&&o.push({alias:t,sum:{field:Ds(e.fieldPath)}})})),{request:{structuredAggregationQuery:{aggregations:o,structuredQuery:r.structuredQuery},parent:r.parent},V_:i,parent:s}}(s.serializer,function(e){const t=v(e);return t.Pe||(t.Pe=xn(t,e.explicitOrderBy)),t.Pe}(t),n);s.connection.wo||delete i.parent;const c=(await s.vo("RunAggregationQuery",s.serializer.databaseId,a,i,1)).filter((e=>!!e.result));w(1===c.length);const u=null===(r=c[0].result)||void 0===r?void 0:r.aggregateFields;return Object.keys(u).reduce(((e,t)=>(e[o[t]]=u[t],e)),{})}(s,t,n))}catch(e){r.reject(e)}})),r.promise}(r,e._query,s).then((t=>function(e,t,n){const r=new ql(e);return new Pu(t,r,n)}(n,e,t)))}class Gl{constructor(e){this.kind="memory",this._onlineComponentProvider=new Gc,(null==e?void 0:e.garbageCollector)?this._offlineComponentProvider=e.garbageCollector._offlineComponentProvider:this._offlineComponentProvider=new qc}toJSON(){return{kind:this.kind}}}class Kl{constructor(e){let t;this.kind="persistent",(null==e?void 0:e.tabManager)?(e.tabManager._initialize(e),t=e.tabManager):(t=Yl(void 0),t._initialize(e)),this._onlineComponentProvider=t._onlineComponentProvider,this._offlineComponentProvider=t._offlineComponentProvider}toJSON(){return{kind:this.kind}}}class $l{constructor(){this.kind="memoryEager",this._offlineComponentProvider=new qc}toJSON(){return{kind:this.kind}}}class Ql{constructor(e){this.kind="memoryLru",this._offlineComponentProvider=new Uc(e)}toJSON(){return{kind:this.kind}}}class jl{constructor(e){this.forceOwnership=e,this.kind="persistentSingleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=new Gc,this._offlineComponentProvider=new Bc(this._onlineComponentProvider,null==e?void 0:e.cacheSizeBytes,this.forceOwnership)}}class Wl{constructor(){this.kind="PersistentMultipleTab"}toJSON(){return{kind:this.kind}}_initialize(e){this._onlineComponentProvider=new Gc,this._offlineComponentProvider=new zc(this._onlineComponentProvider,null==e?void 0:e.cacheSizeBytes)}}function Yl(e){return new jl(null==e?void 0:e.forceOwnership)}const Hl={maxAttempts:5};class Jl{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=ju(e)}set(e,t,n){this._verifyNotCommitted();const r=Xl(e,this._firestore),s=kl(r.converter,t,n),i=Wu(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,fr.none())),this}update(e,t,n,...r){this._verifyNotCommitted();const s=Xl(e,this._firestore);let i;return i="string"==typeof(t=o.getModularInstance(t))||t instanceof Ou?nl(this._dataReader,"WriteBatch.update",s._key,t,n,r):tl(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,fr.exists(!0))),this}delete(e){this._verifyNotCommitted();const t=Xl(e,this._firestore);return this._mutations=this._mutations.concat(new xr(t._key,fr.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new _(I.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function Xl(e,t){if((e=o.getModularInstance(e)).firestore!==t)throw new _(I.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}class Zl extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=ju(e)}get(e){const t=Xl(e,this._firestore),n=new Ml(this._firestore);return this._transaction.lookup([t._key]).then((e=>{if(!e||1!==e.length)return y();const r=e[0];if(r.isFoundDocument())return new fl(this._firestore,n,r.key,r,t.converter);if(r.isNoDocument())return new fl(this._firestore,n,t._key,null,t.converter);throw y()}))}set(e,t,n){const r=Xl(e,this._firestore),s=kl(r.converter,t,n),i=Wu(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(e,t,n,...r){const s=Xl(e,this._firestore);let i;return i="string"==typeof(t=o.getModularInstance(t))||t instanceof Ou?nl(this._dataReader,"Transaction.update",s._key,t,n,r):tl(this._dataReader,"Transaction.update",s._key,t),this._transaction.update(s._key,i),this}delete(e){const t=Xl(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=Xl(e,this._firestore),n=new ql(this._firestore);return super.get(e).then((e=>new Fl(this._firestore,n,t._key,e._document,new Rl(!1,!1),t.converter)))}}function eh(e,t){if("string"!=typeof e[t])throw new _(I.INVALID_ARGUMENT,"Missing string value for: "+t);return e[t]}class th{constructor(e){this._client=e,this.type="PersistentCacheIndexManager"}}function nh(e,t){e._client.verifyNotTerminated(),function(e,t){return e.asyncQueue.enqueue((async()=>function(e,t){v(e).ts.Ui=t}(await nu(e),t)))}(e._client,t).then((e=>f(`setting persistent cache index auto creation isEnabled=${t} succeeded`))).catch((e=>g(`setting persistent cache index auto creation isEnabled=${t} failed`,e)))}const rh=new WeakMap;class sh{constructor(){this.Cu=new Map}static get instance(){return ih||(ih=new sh,function(e){if(Vr)throw new Error("a TestingHooksSpi instance is already set");Vr=e}(ih)),ih}tt(e){this.Cu.forEach((t=>t(e)))}onExistenceFilterMismatch(e){const t=Symbol(),n=this.Cu;return n.set(t,e),()=>n.delete(t)}}let ih=null;!function(e,t=!0){!function(e){l=e}(r.SDK_VERSION),r._registerComponent(new s.Component("firestore",((e,{instanceIdentifier:n,options:r})=>{const s=e.getProvider("app").getImmediate(),i=new Au(new x(e.getProvider("auth-internal")),new A(e.getProvider("app-check-internal")),function(e,t){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new _(I.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new mt(e.options.projectId,t)}(s,n),s);return r=Object.assign({useFetchStreams:t},r),i._setSettings(r),i}),"PUBLIC").setMultipleInstances(!0)),r.registerVersion(c,"4.4.2",e),r.registerVersion(c,"4.4.2","cjs2017")}(),t.AbstractUserDataWriter=Al,t.AggregateField=Fu,t.AggregateQuerySnapshot=Pu,t.Bytes=Vu,t.CACHE_SIZE_UNLIMITED=-1,t.CollectionReference=Tu,t.DocumentReference=Eu,t.DocumentSnapshot=Fl,t.FieldPath=Ou,t.FieldValue=qu,t.Firestore=Au,t.FirestoreError=_,t.GeoPoint=Uu,t.LoadBundleTask=Nu,t.PersistentCacheIndexManager=th,t.Query=bu,t.QueryCompositeFilterConstraint=Il,t.QueryConstraint=wl,t.QueryDocumentSnapshot=Pl,t.QueryEndAtConstraint=Tl,t.QueryFieldFilterConstraint=vl,t.QueryLimitConstraint=bl,t.QueryOrderByConstraint=_l,t.QuerySnapshot=Vl,t.QueryStartAtConstraint=El,t.SnapshotMetadata=Rl,t.Timestamp=P,t.Transaction=Zl,t.WriteBatch=Jl,t._AutoId=M,t._ByteString=it,t._DatabaseId=mt,t._DocumentKey=z,t._EmptyAppCheckTokenProvider=class{getToken(){return Promise.resolve(new N(""))}invalidateToken(){}start(e,t){}shutdown(){}},t._EmptyAuthCredentialsProvider=T,t._FieldPath=B,t._TestingHooks=class{constructor(){throw new Error("instances of this class should not be created")}static onExistenceFilterMismatch(e){return sh.instance.onExistenceFilterMismatch(e)}},t._cast=yu,t._debugAssert=function(e,t){e||y()},t._isBase64Available=function(){return"undefined"!=typeof atob},t._logWarn=g,t._validateIsNotUsedTogether=fu,t.addDoc=function(e,t){const n=yu(e.firestore,Au),r=Su(e),s=kl(e.converter,t);return Ul(n,[Wu(ju(e.firestore),"addDoc",r._key,s,null!==e.converter,{}).toMutation(r._key,fr.exists(!1))]).then((()=>r))},t.aggregateFieldEqual=function(e,t){var n,r;return e instanceof Fu&&t instanceof Fu&&e.aggregateType===t.aggregateType&&(null===(n=e._internalFieldPath)||void 0===n?void 0:n.canonicalString())===(null===(r=t._internalFieldPath)||void 0===r?void 0:r.canonicalString())},t.aggregateQuerySnapshotEqual=function(e,t){return xu(e.query,t.query)&&o.deepEqual(e.data(),t.data())},t.and=function(...e){return e.forEach((e=>Nl("and",e))),Il._create("and",e)},t.arrayRemove=function(...e){return new Zu("arrayRemove",e)},t.arrayUnion=function(...e){return new Xu("arrayUnion",e)},t.average=function(e){return new Fu("avg",cl("average",e))},t.clearIndexedDbPersistence=function(e){if(e._initialized&&!e._terminated)throw new _(I.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new b;return e._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(e){if(!ie.D())return Promise.resolve();const t=e+"main";await ie.delete(t)}(Eo(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}})),t.promise},t.collection=function(e,t,...n){if(e=o.getModularInstance(e),du("collection","path",t),e instanceof Iu){const r=q.fromString(t,...n);return gu(r),new Tu(e,null,r)}{if(!(e instanceof Eu||e instanceof Tu))throw new _(I.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(q.fromString(t,...n));return gu(r),new Tu(e.firestore,null,r)}},t.collectionGroup=function(e,t){if(e=yu(e,Iu),du("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new _(I.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new bu(e,null,function(e){return new vn(q.emptyPath(),e)}(t))},t.connectFirestoreEmulator=_u,t.count=Ll,t.deleteAllPersistentCacheIndexes=function(e){e._client.verifyNotTerminated(),function(e){return e.asyncQueue.enqueue((async()=>function(e){const t=v(e),n=t.indexManager;return t.persistence.runTransaction("Delete All Indexes","readwrite",(e=>n.deleteAllFieldIndexes(e)))}(await nu(e))))}(e._client).then((e=>f("deleting all persistent cache indexes succeeded"))).catch((e=>g("deleting all persistent cache indexes failed",e)))},t.deleteDoc=function(e){return Ul(yu(e.firestore,Au),[new xr(e._key,fr.none())])},t.deleteField=function(){return new Yu("deleteField")},t.disableNetwork=function(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await tu(e),n=await ru(e);return t.setNetworkEnabled(!1),async function(e){const t=v(e);t.v_.add(0),await ga(t),t.x_.set("Offline")}(n)}))}(ku(e=yu(e,Au)))},t.disablePersistentCacheIndexAutoCreation=function(e){nh(e,!1)},t.doc=Su,t.documentId=function(){return new Ou("__name__")},t.enableIndexedDbPersistence=function(e,t){Ru(e=yu(e,Au));const n=ku(e);if(n._uninitializedComponentsProvider)throw new _(I.FAILED_PRECONDITION,"SDK cache is already specified.");g("enableIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const r=e._freezeSettings(),s=new Gc;return Lu(n,s,new Bc(s,r.cacheSizeBytes,null==t?void 0:t.forceOwnership))},t.enableMultiTabIndexedDbPersistence=function(e){Ru(e=yu(e,Au));const t=ku(e);if(t._uninitializedComponentsProvider)throw new _(I.FAILED_PRECONDITION,"SDK cache is already specified.");g("enableMultiTabIndexedDbPersistence() will be deprecated in the future, you can use `FirestoreSettings.cache` instead.");const n=e._freezeSettings(),r=new Gc;return Lu(t,r,new zc(r,n.cacheSizeBytes))},t.enableNetwork=function(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await tu(e),n=await ru(e);return t.setNetworkEnabled(!0),function(e){const t=v(e);return t.v_.delete(0),ma(t)}(n)}))}(ku(e=yu(e,Au)))},t.enablePersistentCacheIndexAutoCreation=function(e){nh(e,!0)},t.endAt=function(...e){return Tl._create("endAt",e,!0)},t.endBefore=function(...e){return Tl._create("endBefore",e,!1)},t.ensureFirestoreConfigured=ku,t.executeWrite=Ul,t.getAggregateFromServer=zl,t.getCountFromServer=function(e){return zl(e,{count:Ll()})},t.getDoc=function(e){e=yu(e,Eu);const t=yu(e.firestore,Au);return au(ku(t),e._key).then((n=>Bl(t,e,n)))},t.getDocFromCache=function(e){e=yu(e,Eu);const t=yu(e.firestore,Au),n=ku(t),r=new ql(t);return function(e,t){const n=new b;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const r=await function(e,t){const n=v(e);return n.persistence.runTransaction("read document","readonly",(e=>n.localDocuments.getDocument(e,t)))}(e,t);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new _(I.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){const r=Ga(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await nu(e),t,n))),n.promise}(n,e._key).then((n=>new Fl(t,r,e._key,n,new Rl(null!==n&&n.hasLocalMutations,!0),e.converter)))},t.getDocFromServer=function(e){e=yu(e,Eu);const t=yu(e.firestore,Au);return au(ku(t),e._key,{source:"server"}).then((n=>Bl(t,e,n)))},t.getDocs=function(e){e=yu(e,bu);const t=yu(e.firestore,Au),n=ku(t),r=new ql(t);return pl(e._query),cu(n,e._query).then((n=>new Vl(t,r,e,n)))},t.getDocsFromCache=function(e){e=yu(e,bu);const t=yu(e.firestore,Au),n=ku(t),r=new ql(t);return function(e,t){const n=new b;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const r=await Fo(e,t,!0),s=new ac(t,r.hs),i=s.ha(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(e){const r=Ga(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await nu(e),t,n))),n.promise}(n,e._query).then((n=>new Vl(t,r,e,n)))},t.getDocsFromServer=function(e){e=yu(e,bu);const t=yu(e.firestore,Au),n=ku(t),r=new ql(t);return cu(n,e._query,{source:"server"}).then((n=>new Vl(t,r,e,n)))},t.getFirestore=function(e,t){const n="object"==typeof e?e:r.getApp(),s="string"==typeof e?e:t||"(default)",i=r._getProvider(n,"firestore").getImmediate({identifier:s});if(!i._initialized){const e=o.getDefaultEmulatorHostnameAndPort("firestore");e&&_u(i,...e)}return i},t.getPersistentCacheIndexManager=function(e){var t;e=yu(e,Au);const n=rh.get(e);if(n)return n;const r=ku(e);if("persistent"!==(null===(t=r._uninitializedComponentsProvider)||void 0===t?void 0:t._offlineKind))return null;const s=new th(r);return rh.set(e,s),s},t.increment=function(e){return new el("increment",e)},t.initializeFirestore=function(e,t,n){n||(n="(default)");const s=r._getProvider(e,"firestore");if(s.isInitialized(n)){const e=s.getImmediate({identifier:n}),r=s.getOptions(n);if(o.deepEqual(r,t))return e;throw new _(I.FAILED_PRECONDITION,"initializeFirestore() has already been called with different options. To avoid this error, call initializeFirestore() with the same options as when it was originally called, or call getFirestore() to return the already initialized instance.")}if(void 0!==t.cacheSizeBytes&&void 0!==t.localCache)throw new _(I.INVALID_ARGUMENT,"cache and cacheSizeBytes cannot be specified at the same time as cacheSizeBytes willbe deprecated. Instead, specify the cache size in the cache object");if(void 0!==t.cacheSizeBytes&&-1!==t.cacheSizeBytes&&t.cacheSizeBytes<1048576)throw new _(I.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");return s.initialize({options:t,instanceIdentifier:n})},t.limit=function(e){return wu("limit",e),bl._create("limit",e,"F")},t.limitToLast=function(e){return wu("limitToLast",e),bl._create("limitToLast",e,"L")},t.loadBundle=function(e,t){const n=ku(e=yu(e,Au)),r=new Nu;return uu(n,e._databaseId,t,r),r},t.memoryEagerGarbageCollector=function(){return new $l},t.memoryLocalCache=function(e){return new Gl(e)},t.memoryLruGarbageCollector=function(e){return new Ql(null==e?void 0:e.cacheSizeBytes)},t.namedQuery=function(e,t){return function(e,t){return e.asyncQueue.enqueue((async()=>function(e,t){const n=v(e);return n.persistence.runTransaction("Get named query","readonly",(e=>n.$r.getNamedQuery(e,t)))}(await nu(e),t)))}(ku(e=yu(e,Au)),t).then((t=>t?new bu(e,null,t.query):null))},t.onSnapshot=function(e,...t){var n,r,s;e=o.getModularInstance(e);let i={includeMetadataChanges:!1},a=0;"object"!=typeof t[a]||Du(t[a])||(i=t[a],a++);const c={includeMetadataChanges:i.includeMetadataChanges};if(Du(t[a])){const e=t[a];t[a]=null===(n=e.next)||void 0===n?void 0:n.bind(e),t[a+1]=null===(r=e.error)||void 0===r?void 0:r.bind(e),t[a+2]=null===(s=e.complete)||void 0===s?void 0:s.bind(e)}let u,l,h;if(e instanceof Eu)l=yu(e.firestore,Au),h=_n(e._key.path),u={next:n=>{t[a]&&t[a](Bl(l,e,n))},error:t[a+1],complete:t[a+2]};else{const n=yu(e,bu);l=yu(n.firestore,Au),h=n._query;const r=new ql(l);u={next:e=>{t[a]&&t[a](new Vl(l,r,n,e))},error:t[a+1],complete:t[a+2]},pl(e._query)}return function(e,t,n,r){const s=new $c(r),i=new ec(t,s,n);return e.asyncQueue.enqueueAndForget((async()=>Ya(await ou(e),i))),()=>{s.La(),e.asyncQueue.enqueueAndForget((async()=>Ha(await ou(e),i)))}}(ku(l),h,c,u)},t.onSnapshotsInSync=function(e,t){return function(e,t){const n=new $c(t);return e.asyncQueue.enqueueAndForget((async()=>function(e,t){v(e).K_.add(t),t.next()}(await ou(e),n))),()=>{n.La(),e.asyncQueue.enqueueAndForget((async()=>function(e,t){v(e).K_.delete(t)}(await ou(e),n)))}}(ku(e=yu(e,Au)),Du(t)?t:{next:t})},t.or=function(...e){return e.forEach((e=>Nl("or",e))),Il._create("or",e)},t.orderBy=function(e,t="asc"){const n=t,r=gl("orderBy",e);return _l._create(r,n)},t.persistentLocalCache=function(e){return new Kl(e)},t.persistentMultipleTabManager=function(){return new Wl},t.persistentSingleTabManager=Yl,t.query=function(e,t,...n){let r=[];t instanceof yl&&r.push(t),r=r.concat(n),function(e){const t=e.filter((e=>e instanceof Il)).length,n=e.filter((e=>e instanceof vl)).length;if(t>1||t>0&&n>0)throw new _(I.INVALID_ARGUMENT,"InvalidQuery. When using composite filters, you cannot use more than one filter at the top level. Consider nesting the multiple filters within an `and(...)` statement. For example: change `query(query, where(...), or(...))` to `query(query, and(where(...), or(...)))`.")}(r);for(const s of r)e=s._apply(e);return e},t.queryEqual=xu,t.refEqual=function(e,t){return e=o.getModularInstance(e),t=o.getModularInstance(t),(e instanceof Eu||e instanceof Tu)&&(t instanceof Eu||t instanceof Tu)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter},t.runTransaction=function(e,t,n){e=yu(e,Au);const r=Object.assign(Object.assign({},Hl),n);return function(e){if(e.maxAttempts<1)throw new _(I.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(e,t,n){const r=new b;return e.asyncQueue.enqueueAndForget((async()=>{const s=await iu(e);new Wc(e.asyncQueue,s,n,t,r).ja()})),r.promise}(ku(e),(n=>t(new Zl(e,n))),r)},t.serverTimestamp=function(){return new Ju("serverTimestamp")},t.setDoc=function(e,t,n){e=yu(e,Eu);const r=yu(e.firestore,Au),s=kl(e.converter,t,n);return Ul(r,[Wu(ju(r),"setDoc",e._key,s,null!==e.converter,n).toMutation(e._key,fr.none())])},t.setIndexConfiguration=function(e,t){var n;const r=ku(e=yu(e,Au));if(!r._uninitializedComponentsProvider||"memory"===(null===(n=r._uninitializedComponentsProvider)||void 0===n?void 0:n._offlineKind))return g("Cannot enable indexes when persistence is disabled"),Promise.resolve();const s=function(e){const t="string"==typeof e?function(e){try{return JSON.parse(e)}catch(e){throw new _(I.INVALID_ARGUMENT,"Failed to parse JSON: "+(null==e?void 0:e.message))}}(e):e,n=[];if(Array.isArray(t.indexes))for(const r of t.indexes){const e=eh(r,"collectionGroup"),t=[];if(Array.isArray(r.fields))for(const n of r.fields){const e=ll("setIndexConfiguration",eh(n,"fieldPath"));"CONTAINS"===n.arrayConfig?t.push(new j(e,2)):"ASCENDING"===n.order?t.push(new j(e,0)):"DESCENDING"===n.order&&t.push(new j(e,1))}n.push(new G(G.UNKNOWN_ID,e,t,Y.empty()))}return n}(t);return function(e,t){return e.asyncQueue.enqueue((async()=>async function(e,t){const n=v(e),r=n.indexManager,s=[];return n.persistence.runTransaction("Configure indexes","readwrite",(e=>r.getFieldIndexes(e).next((n=>function(e,t,n,r,s){e=[...e],t=[...t],e.sort(n),t.sort(n);const i=e.length,o=t.length;let a=0,c=0;for(;a<o&&c<i;){const i=n(e[c],t[a]);i<0?s(e[c++]):i>0?r(t[a++]):(a++,c++)}for(;a<o;)r(t[a++]);for(;c<i;)s(e[c++])}(n,t,Q,(t=>{s.push(r.addFieldIndex(e,t))}),(t=>{s.push(r.deleteFieldIndex(e,t))})))).next((()=>re.waitFor(s)))))}(await nu(e),t)))}(r,s)},t.setLogLevel=function(e){h.setLogLevel(e)},t.snapshotEqual=function(e,t){return e instanceof Fl&&t instanceof Fl?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof Vl&&t instanceof Vl&&e._firestore===t._firestore&&xu(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)},t.startAfter=function(...e){return El._create("startAfter",e,!1)},t.startAt=function(...e){return El._create("startAt",e,!0)},t.sum=function(e){return new Fu("sum",cl("sum",e))},t.terminate=function(e){return r._removeServiceInstance(e.app,"firestore",e._databaseId.database),e._delete()},t.updateDoc=function(e,t,n,...r){e=yu(e,Eu);const s=yu(e.firestore,Au),i=ju(s);let a;return a="string"==typeof(t=o.getModularInstance(t))||t instanceof Ou?nl(i,"updateDoc",e._key,t,n,r):tl(i,"updateDoc",e._key,t),Ul(s,[a.toMutation(e._key,fr.exists(!0))])},t.waitForPendingWrites=function(e){return function(e){const t=new b;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t){const n=v(e);ba(n.remoteStore)||f("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(e){const t=v(e);return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e)))}(n.localStore);if(-1===e)return void t.resolve();const r=n.Ca.get(e)||[];r.push(t),n.Ca.set(e,r)}catch(e){const n=Ga(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await su(e),t))),t.promise}(ku(e=yu(e,Au)))},t.where=function(e,t,n){const r=t,s=gl("where",e);return vl._create(s,r,n)},t.writeBatch=function(e){return ku(e=yu(e,Au)),new Jl(e,(t=>Ul(e,t)))}}}]);
//# sourceMappingURL=484bcb1e-f37b52ac445247cfd30c.js.map